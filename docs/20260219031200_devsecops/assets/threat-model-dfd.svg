<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 580" style="max-height:70vh;width:auto;display:block;margin:0 auto;letter-spacing:0;font-family:Arial,sans-serif;">

  <!-- Background -->
  <rect width="900" height="580" fill="#F8F9FA" rx="8"/>

  <!-- Title -->
  <text x="450" y="32" text-anchor="middle" font-size="17" font-weight="bold" fill="#1A237E">脅威モデリング — データフロー図(DFD)例</text>

  <!-- Trust boundary: Internet -->
  <rect x="30" y="55" width="165" height="130" rx="6" fill="none" stroke="#FF5722" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="113" y="72" text-anchor="middle" font-size="10" fill="#FF5722" font-weight="bold">インターネット境界</text>

  <!-- Trust boundary: Internal -->
  <rect x="245" y="55" width="520" height="320" rx="6" fill="none" stroke="#1565C0" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="505" y="72" text-anchor="middle" font-size="10" fill="#1565C0" font-weight="bold">内部ネットワーク境界</text>

  <!-- Trust boundary: Data Layer -->
  <rect x="560" y="310" width="195" height="120" rx="6" fill="none" stroke="#4CAF50" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="657" y="327" text-anchor="middle" font-size="10" fill="#2E7D32" font-weight="bold">データ層境界</text>

  <!-- ===== NODES ===== -->

  <!-- External entity: ユーザー (orange) -->
  <rect x="40" y="85" width="110" height="70" rx="8" fill="#FF9800" stroke="#E65100" stroke-width="2"/>
  <text x="95" y="112" text-anchor="middle" font-size="13" font-weight="bold" fill="white">ユーザー</text>
  <text x="95" y="128" text-anchor="middle" font-size="10" fill="#FFF3E0">(ブラウザ)</text>
  <text x="95" y="142" text-anchor="middle" font-size="10" fill="#FFF3E0">外部エンティティ</text>

  <!-- Process: Webフロント -->
  <rect x="260" y="85" width="120" height="60" rx="8" fill="#232F3E" stroke="#37474F" stroke-width="2"/>
  <text x="320" y="110" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Webフロント</text>
  <text x="320" y="127" text-anchor="middle" font-size="10" fill="#90A4AE">(React)</text>

  <!-- Process: APIゲートウェイ -->
  <rect x="430" y="85" width="130" height="60" rx="8" fill="#232F3E" stroke="#37474F" stroke-width="2"/>
  <text x="495" y="110" text-anchor="middle" font-size="12" font-weight="bold" fill="white">APIゲートウェイ</text>
  <text x="495" y="127" text-anchor="middle" font-size="10" fill="#90A4AE">Kong / AWS APIGW</text>

  <!-- Process: 認証サービス -->
  <rect x="430" y="210" width="130" height="60" rx="8" fill="#232F3E" stroke="#37474F" stroke-width="2"/>
  <text x="495" y="235" text-anchor="middle" font-size="12" font-weight="bold" fill="white">認証サービス</text>
  <text x="495" y="252" text-anchor="middle" font-size="10" fill="#90A4AE">(JWT / OAuth2)</text>

  <!-- Process: バックエンドAPI -->
  <rect x="620" y="155" width="120" height="60" rx="8" fill="#232F3E" stroke="#37474F" stroke-width="2"/>
  <text x="680" y="180" text-anchor="middle" font-size="12" font-weight="bold" fill="white">バックエンド</text>
  <text x="680" y="197" text-anchor="middle" font-size="10" fill="#90A4AE">API</text>

  <!-- Data store: RDS (green) -->
  <!-- Cylinder-like shape using ellipses -->
  <rect x="590" y="340" width="90" height="55" rx="4" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
  <ellipse cx="635" cy="340" rx="45" ry="10" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
  <text x="635" y="365" text-anchor="middle" font-size="11" font-weight="bold" fill="white">RDS</text>
  <text x="635" y="381" text-anchor="middle" font-size="9" fill="#E8F5E9">(PostgreSQL)</text>

  <!-- Data store: Redis -->
  <rect x="700" y="340" width="90" height="55" rx="4" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
  <ellipse cx="745" cy="340" rx="45" ry="10" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
  <text x="745" y="365" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Redis</text>
  <text x="745" y="381" text-anchor="middle" font-size="9" fill="#E8F5E9">Cache</text>

  <!-- External entity: 外部API (orange) -->
  <rect x="790" y="85" width="100" height="70" rx="8" fill="#FF9800" stroke="#E65100" stroke-width="2"/>
  <text x="840" y="112" text-anchor="middle" font-size="11" font-weight="bold" fill="white">外部API</text>
  <text x="840" y="127" text-anchor="middle" font-size="10" fill="#FFF3E0">(Stripe等)</text>
  <text x="840" y="142" text-anchor="middle" font-size="10" fill="#FFF3E0">外部エンティティ</text>

  <!-- ===== ARROWS (line + polygon, no markers) ===== -->

  <!-- ユーザー → Webフロント -->
  <line x1="151" y1="115" x2="257" y2="115" stroke="#546E7A" stroke-width="2"/>
  <polygon points="257,110 269,115 257,120" fill="#546E7A"/>
  <text x="203" y="107" text-anchor="middle" font-size="9" fill="#37474F">HTTPS</text>

  <!-- Webフロント → APIゲートウェイ -->
  <line x1="381" y1="115" x2="427" y2="115" stroke="#546E7A" stroke-width="2"/>
  <polygon points="427,110 439,115 427,120" fill="#546E7A"/>
  <text x="404" y="107" text-anchor="middle" font-size="9" fill="#37474F">REST</text>

  <!-- APIゲートウェイ → 認証サービス -->
  <line x1="495" y1="146" x2="495" y2="207" stroke="#546E7A" stroke-width="2"/>
  <polygon points="490,207 495,219 500,207" fill="#546E7A"/>
  <text x="510" y="180" font-size="9" fill="#37474F">JWT検証</text>

  <!-- APIゲートウェイ → バックエンドAPI -->
  <line x1="561" y1="115" x2="617" y2="165" stroke="#546E7A" stroke-width="2"/>
  <polygon points="611,162 622,170 617,158" fill="#546E7A"/>
  <text x="595" y="132" text-anchor="middle" font-size="9" fill="#37474F">gRPC</text>

  <!-- バックエンドAPI → RDS -->
  <line x1="660" y1="216" x2="645" y2="338" stroke="#546E7A" stroke-width="2"/>
  <polygon points="641,338 645,350 649,338" fill="#546E7A"/>
  <text x="643" y="285" font-size="9" fill="#37474F">SQL</text>

  <!-- バックエンドAPI → Redis -->
  <line x1="700" y1="200" x2="748" y2="338" stroke="#546E7A" stroke-width="2"/>
  <polygon points="744,338 748,350 752,338" fill="#546E7A"/>
  <text x="738" y="276" font-size="9" fill="#37474F">Cache</text>

  <!-- バックエンドAPI → 外部API -->
  <line x1="741" y1="185" x2="787" y2="130" stroke="#546E7A" stroke-width="2"/>
  <polygon points="782,134 790,124 796,132" fill="#546E7A"/>
  <text x="776" y="165" font-size="9" fill="#37474F">HTTPS</text>

  <!-- ===== THREAT INDICATORS (red circles with STRIDE labels) ===== -->

  <!-- T1: at ユーザー→Webフロント arrow (Spoofing) -->
  <circle cx="200" cy="130" r="12" fill="none" stroke="#D32F2F" stroke-width="2" style="filter:drop-shadow(0 0 3px rgba(211,47,47,0.5))"/>
  <text x="200" y="134" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">S</text>
  <text x="200" y="148" text-anchor="middle" font-size="8" fill="#D32F2F">なりすまし</text>

  <!-- T2: at APIゲートウェイ (Tampering) -->
  <circle cx="570" cy="90" r="12" fill="none" stroke="#D32F2F" stroke-width="2" style="filter:drop-shadow(0 0 3px rgba(211,47,47,0.5))"/>
  <text x="570" y="94" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">T</text>
  <text x="570" y="108" text-anchor="middle" font-size="8" fill="#D32F2F">改ざん</text>

  <!-- T3: at 認証サービス (Elevation of Privilege) -->
  <circle cx="415" cy="240" r="12" fill="none" stroke="#D32F2F" stroke-width="2" style="filter:drop-shadow(0 0 3px rgba(211,47,47,0.5))"/>
  <text x="415" y="244" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">E</text>
  <text x="415" y="258" text-anchor="middle" font-size="8" fill="#D32F2F">権限昇格</text>

  <!-- T4: at RDS (Information Disclosure) -->
  <circle cx="575" cy="370" r="12" fill="none" stroke="#D32F2F" stroke-width="2" style="filter:drop-shadow(0 0 3px rgba(211,47,47,0.5))"/>
  <text x="575" y="374" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">I</text>
  <text x="575" y="388" text-anchor="middle" font-size="8" fill="#D32F2F">情報漏洩</text>

  <!-- ===== LEGEND ===== -->
  <rect x="30" y="430" width="860" height="140" rx="6" fill="#ECEFF1" stroke="#B0BEC5" stroke-width="1"/>
  <text x="450" y="450" text-anchor="middle" font-size="12" font-weight="bold" fill="#37474F">凡例 / STRIDEカテゴリ</text>

  <!-- Node types -->
  <rect x="50" y="462" width="60" height="22" rx="4" fill="#232F3E"/>
  <text x="80" y="477" text-anchor="middle" font-size="10" fill="white">プロセス</text>
  <rect x="130" y="462" width="60" height="22" rx="4" fill="#4CAF50"/>
  <text x="160" y="477" text-anchor="middle" font-size="10" fill="white">データストア</text>
  <rect x="210" y="462" width="60" height="22" rx="4" fill="#FF9800"/>
  <text x="240" y="477" text-anchor="middle" font-size="10" fill="white">外部エンティティ</text>

  <!-- STRIDE -->
  <circle cx="305" cy="473" r="10" fill="none" stroke="#D32F2F" stroke-width="2"/>
  <text x="305" y="477" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">S</text>
  <text x="320" y="477" font-size="10" fill="#37474F">Spoofing (なりすまし)</text>

  <circle cx="470" cy="473" r="10" fill="none" stroke="#D32F2F" stroke-width="2"/>
  <text x="470" y="477" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">T</text>
  <text x="485" y="477" font-size="10" fill="#37474F">Tampering (改ざん)</text>

  <circle cx="635" cy="473" r="10" fill="none" stroke="#D32F2F" stroke-width="2"/>
  <text x="635" y="477" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">I</text>
  <text x="650" y="477" font-size="10" fill="#37474F">Info Disclosure (情報漏洩)</text>

  <circle cx="305" cy="503" r="10" fill="none" stroke="#D32F2F" stroke-width="2"/>
  <text x="305" y="507" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">D</text>
  <text x="320" y="507" font-size="10" fill="#37474F">Denial of Service (DoS)</text>

  <circle cx="470" cy="503" r="10" fill="none" stroke="#D32F2F" stroke-width="2"/>
  <text x="470" y="507" text-anchor="middle" font-size="9" font-weight="bold" fill="#D32F2F">E</text>
  <text x="485" y="507" font-size="10" fill="#37474F">Elevation of Privilege (権限昇格)</text>

  <!-- Trust boundary legend -->
  <line x1="50" y1="530" x2="100" y2="530" stroke="#FF5722" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="108" y="534" font-size="10" fill="#37474F">インターネット境界</text>
  <line x1="240" y1="530" x2="290" y2="530" stroke="#1565C0" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="298" y="534" font-size="10" fill="#37474F">内部ネットワーク境界</text>
  <line x1="430" y1="530" x2="480" y2="530" stroke="#4CAF50" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="488" y="534" font-size="10" fill="#37474F">データ層境界</text>

  <!-- Data flow arrow legend -->
  <line x1="50" y1="556" x2="90" y2="556" stroke="#546E7A" stroke-width="2"/>
  <polygon points="90,551 102,556 90,561" fill="#546E7A"/>
  <text x="108" y="560" font-size="10" fill="#37474F">データフロー</text>

</svg>
