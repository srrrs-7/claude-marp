<svg viewBox="0 0 800 370" xmlns="http://www.w3.org/2000/svg" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0">
  <rect width="800" height="370" fill="#f8f9fa" rx="8"/>
  <text x="400" y="24" text-anchor="middle" font-size="13" font-weight="bold" fill="#2c3e50" font-family="sans-serif">PKCE (RFC 7636) — S256 チャレンジ生成・検証フロー</text>

  <!-- Client Side (Left) -->
  <rect x="15" y="38" width="370" height="288" rx="8" fill="#dbeafe" stroke="#3498db" stroke-width="1.5"/>
  <text x="200" y="58" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af" font-family="sans-serif">クライアント（Authorization Request 前）</text>

  <!-- Step 1: code_verifier -->
  <rect x="30" y="68" width="340" height="56" rx="6" fill="#3498db" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.15))"/>
  <text x="200" y="88" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">① code_verifier 生成</text>
  <text x="200" y="104" text-anchor="middle" font-size="9" fill="#dbeafe" font-family="sans-serif">crypto.randomBytes(32).toString('base64url')</text>
  <text x="200" y="118" text-anchor="middle" font-size="8" fill="#93c5fd" font-family="sans-serif">43〜128 文字 / unreserved chars [A-Z a-z 0-9 - . _ ~]</text>

  <!-- Arrow down -->
  <line x1="200" y1="124" x2="200" y2="140" stroke="#2980b9" stroke-width="1.5"/>
  <polygon points="200,140 195,130 205,130" fill="#2980b9"/>

  <!-- Step 2: code_challenge -->
  <rect x="30" y="142" width="340" height="70" rx="6" fill="#2980b9" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.15))"/>
  <text x="200" y="162" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">② code_challenge 導出 (method=S256)</text>
  <text x="200" y="180" text-anchor="middle" font-size="11" fill="#f1c40f" font-family="sans-serif">BASE64URL( SHA256( code_verifier ) )</text>
  <text x="200" y="198" text-anchor="middle" font-size="8" fill="#aed6f1" font-family="sans-serif">パディング '=' を除去 / URL-safe 文字変換 / 43文字固定長</text>

  <!-- Arrow down -->
  <line x1="200" y1="212" x2="200" y2="228" stroke="#1a5276" stroke-width="1.5"/>
  <polygon points="200,228 195,218 205,218" fill="#1a5276"/>

  <!-- Step 3: Send in Auth Request -->
  <rect x="30" y="230" width="340" height="48" rx="6" fill="#1a5276" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.15))"/>
  <text x="200" y="250" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">③ Authorization Request に追加</text>
  <text x="200" y="267" text-anchor="middle" font-size="9" fill="#aed6f1" font-family="sans-serif">code_challenge=&lt;value&gt; &amp; code_challenge_method=S256</text>

  <!-- Step 4: Store verifier -->
  <rect x="30" y="290" width="340" height="28" rx="6" fill="#154360"/>
  <text x="200" y="308" text-anchor="middle" font-size="9" fill="#aed6f1" font-family="sans-serif">④ code_verifier をセッション / メモリに保存（Token Request で送信）</text>

  <!-- Arrow: Token Request -->
  <rect x="396" y="178" width="68" height="46" rx="6" fill="#f39c12" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.1))"/>
  <text x="430" y="198" text-anchor="middle" font-size="9" font-weight="bold" fill="white" font-family="sans-serif">Token</text>
  <text x="430" y="212" text-anchor="middle" font-size="9" font-weight="bold" fill="white" font-family="sans-serif">Request</text>
  <text x="430" y="224" text-anchor="middle" font-size="8" fill="#fdebd0" font-family="sans-serif">code_verifier</text>
  <line x1="370" y1="201" x2="394" y2="201" stroke="#f39c12" stroke-width="1.5"/>
  <polygon points="394,201 384,196 384,206" fill="#f39c12"/>
  <line x1="464" y1="201" x2="490" y2="201" stroke="#f39c12" stroke-width="1.5"/>
  <polygon points="490,201 480,196 480,206" fill="#f39c12"/>

  <!-- Auth Server Side (Right) -->
  <rect x="492" y="38" width="293" height="288" rx="8" fill="#dcfce7" stroke="#27ae60" stroke-width="1.5"/>
  <text x="639" y="58" text-anchor="middle" font-size="11" font-weight="bold" fill="#166534" font-family="sans-serif">認可サーバー（Token Request 受信時）</text>

  <!-- AS: stored challenge -->
  <rect x="507" y="68" width="263" height="44" rx="6" fill="#27ae60" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.15))"/>
  <text x="639" y="88" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">① code_challenge 保存済み</text>
  <text x="639" y="104" text-anchor="middle" font-size="8" fill="#d5f5e3" font-family="sans-serif">Authorization Request 受信時に DB/セッションに保存</text>

  <!-- Arrow down -->
  <line x1="639" y1="112" x2="639" y2="128" stroke="#1e8449" stroke-width="1.5"/>
  <polygon points="639,128 634,118 644,118" fill="#1e8449"/>

  <!-- AS: compute -->
  <rect x="507" y="130" width="263" height="60" rx="6" fill="#1e8449" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.15))"/>
  <text x="639" y="150" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">② 検証計算</text>
  <text x="639" y="168" text-anchor="middle" font-size="9" fill="#d5f5e3" font-family="sans-serif">BASE64URL( SHA256( received code_verifier ) )</text>
  <text x="639" y="183" text-anchor="middle" font-size="10" font-weight="bold" fill="#f1c40f" font-family="sans-serif">== stored code_challenge ?</text>

  <!-- Match / Mismatch -->
  <rect x="507" y="204" width="120" height="44" rx="6" fill="#1abc9c" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.1))"/>
  <text x="567" y="224" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">✅ 一致</text>
  <text x="567" y="239" text-anchor="middle" font-size="9" fill="#d1f2eb" font-family="sans-serif">トークン発行</text>

  <rect x="638" y="204" width="112" height="44" rx="6" fill="#e74c3c" style="filter:drop-shadow(1px 1px 3px rgba(0,0,0,0.1))"/>
  <text x="694" y="224" text-anchor="middle" font-size="10" font-weight="bold" fill="white" font-family="sans-serif">❌ 不一致</text>
  <text x="694" y="239" text-anchor="middle" font-size="9" fill="#fdecea" font-family="sans-serif">400 invalid_grant</text>

  <!-- Security note in AS -->
  <rect x="507" y="262" width="263" height="56" rx="6" fill="#2c3e50"/>
  <text x="639" y="280" text-anchor="middle" font-size="9" font-weight="bold" fill="#f1c40f" font-family="sans-serif">防御対象: 認可コードインジェクション攻撃</text>
  <text x="639" y="296" text-anchor="middle" font-size="8" fill="#bdc3c7" font-family="sans-serif">攻撃者は code_verifier を知らない</text>
  <text x="639" y="312" text-anchor="middle" font-size="8" fill="#bdc3c7" font-family="sans-serif">→ 盗んだ code を自分のフローに転用できない</text>

  <!-- Footer -->
  <rect x="15" y="338" width="770" height="24" rx="6" fill="#2c3e50"/>
  <text x="400" y="354" text-anchor="middle" font-size="9" fill="#ecf0f1" font-family="sans-serif">code_verifier は1回のみ有効。Token Request 後は即削除。S256 のみ使用（plain は非推奨）。BCP 212 / RFC 7636</text>
</svg>
