{
	"slides": [
		{
			"title": "AWS Observability完全ガイド",
			"layout": "center",
			"content": [
				"OpenTelemetry + CloudWatch + Grafana + X-Ray",
				"開発者のためのフルスタック観測入門",
				"2026年版 — 実践コマンド・設定例・コスト最適化"
			],
			"speakerNotes": "AWS Observabilityの全体像を体系的に学ぶ90枚スライド。Logs/Metrics/Tracesの三本柱からADOT/AMP/AMGまで実践的に解説。"
		},
		{
			"title": "アジェンダ (1/2)",
			"layout": "default",
			"content": [
				"**Ch.1** — Observabilityとは（三本柱・全体像）",
				"**Ch.2** — Amazon CloudWatch基礎（Metrics/Logs/Alarms/RUM/Insights）",
				"**Ch.3** — AWS X-Ray 分散トレーシング（Segment/ServiceMap/サンプリング）",
				"**Ch.4** — OpenTelemetry on AWS — ADOT完全ガイド",
				"**Ch.5** — Amazon Managed Prometheus + Grafana"
			]
		},
		{
			"title": "アジェンダ (2/2)",
			"layout": "default",
			"content": [
				"**Ch.6** — 実践パターン（Serverless/EKS/ECS/マルチアカウント）",
				"**Ch.7** — コスト最適化（ログ/メトリクス/トレース削減戦略）",
				"**Ch.8** — まとめ・ツール選択チートシート",
				"各章に実践コマンド例・設定スニペット・試験頻出ポイントを収録",
				"対象: 開発者（AWS認定 DevOps Pro / SysOps 対策にも活用可）"
			]
		},
		{
			"title": "Observabilityとは — 三本柱",
			"layout": "default",
			"content": [
				"**Observability（可観測性）= システムの内部状態を外部出力から推測できる能力**",
				"**Logs（ログ）**: 離散的イベント記録。「何が起きたか」を詳細に記述",
				"**Metrics（メトリクス）**: 数値の時系列データ。「どの程度か」を定量化",
				"**Traces（トレース）**: リクエストの因果関係追跡。「どこで詰まったか」を可視化",
				"MonitoringとObservabilityの違い: Monitoring=既知の障害を検知、Observability=未知の問題を探索",
				"AWS実装: CW Logs / CW Metrics / X-Ray — ADOT（OpenTelemetry）で統合収集"
			],
			"speakerNotes": "Observabilityの定義はControl Theory由来。Honeycombのcharity.wtfが提唱した概念が業界標準に。"
		},
		{
			"title": "なぜObservabilityが重要か",
			"layout": "default",
			"content": [
				"**マイクロサービス時代の課題**: サービス数増加 → 障害の原因特定が困難",
				"**MTTR短縮**: 平均復旧時間 2h → 20分（可観測性あり）— 業界調査",
				"**本番デバッグ**: ステージング再現不可の障害をトレースで直接診断",
				"**SLO管理**: エラーバジェット消費率を可視化 → リリース判断に活用",
				"**コスト最適化**: 使われていないリソース・ホットスポットを特定",
				"**セキュリティ**: 異常アクセスパターンを早期検知（GuardDuty + CloudWatch連携）"
			]
		},
		{
			"title": "AWS Observabilityフルスタック",
			"layout": "default",
			"content": ["![w:880 center](assets/observability-stack-overview.svg)"]
		},
		{
			"title": "Ch.2 Amazon CloudWatch基礎",
			"layout": "section",
			"content": [
				"Metrics / Logs / Alarms / Dashboards",
				"Synthetics / RUM / Container Insights / Lambda Insights"
			]
		},
		{
			"title": "CloudWatch サービス構成マップ",
			"layout": "default",
			"content": ["![w:880 center](assets/cloudwatch-service-map.svg)"]
		},
		{
			"title": "CloudWatch Metrics — 基本概念",
			"layout": "default",
			"content": [
				"**Namespace**: メトリクスの名前空間（例: `AWS/Lambda`, `AWS/ECS`, `MyApp/Orders`）",
				"**Dimension**: メトリクスの識別軸（例: FunctionName=my-func, Region=ap-northeast-1）",
				"**Resolution**: 標準（1分）vs 高解像度（1秒）— 高解像度は10倍コスト",
				"**Statistics**: Average/Sum/Min/Max/SampleCount/Percentile（p99など）",
				"**Retention**: 1秒→3時間, 1分→15日, 5分→63日, 1時間→15ヶ月（自動集約）",
				"AWS標準メトリクスは**無料**、カスタムメトリクスは$0.30/メトリクス/月（最初10,000無料）"
			]
		},
		{
			"title": "カスタムメトリクス — PutMetricData vs EMF",
			"layout": "default",
			"content": [
				"**PutMetricData API**: 直接メトリクス送信（シンプルだが高コスト）",
				"**EMF（Embedded Metric Format）**: CloudWatch Logsに埋め込み → 自動でメトリクス生成（推奨）"
			],
			"code": "import { createMetricsLogger, Unit } from 'aws-embedded-metrics';\n\nexport const handler = async (event) => {\n  const metrics = createMetricsLogger();\n  metrics.setNamespace('MyApp/Orders');\n  metrics.putDimensions({ Service: 'OrderAPI', Env: 'prod' });\n\n  const start = Date.now();\n  const result = await processOrder(event);\n  const latency = Date.now() - start;\n\n  metrics.putMetric('OrderLatency', latency, Unit.Milliseconds);\n  metrics.putMetric('OrderSuccess', 1, Unit.Count);\n  await metrics.flush(); // CloudWatch Logsへ書き込み\n  return result;\n};",
			"codeLanguage": "typescript",
			"speakerNotes": "EMFはLambda/ECS/EKSどこでも使える。CloudWatch Logs書き込みコストのみで済むため経済的。"
		},
		{
			"title": "CloudWatch Logs — 基本設定",
			"layout": "default",
			"content": [
				"**ロググループ**: `/aws/lambda/<name>`, `/aws/eks/<cluster>/cluster` など",
				"**ログストリーム**: ロググループ内の時系列ストリーム（Lambdaは実行環境ごと）",
				"**保持期間設定**: Never Expire → 必ず設定（30日/90日/1年など）",
				"**ログクラス**: Standard（$0.50/GB）vs Infrequent Access（$0.25/GB、Insights使用不可）",
				"**サブスクリプションフィルター**: Firehose/Lambda/Kinesis へリアルタイム転送",
				"**メトリクスフィルター**: ログから自動でメトリクス生成（例: `ERROR` 出現カウント）"
			]
		},
		{
			"title": "CloudWatch Logs Insights — 実践クエリ",
			"layout": "default",
			"content": [
				"Logs Insightsはサーバーレスクエリエンジン（$0.005/GBスキャン）"
			],
			"code": "# Lambda エラー率分析\nfilter @message like /ERROR/\n| stats count(*) as errors by bin(5m)\n| sort @timestamp desc\n\n# レイテンシ分析（p99）\nfilter @type = \"REPORT\"\n| stats avg(@duration), percentile(@duration, 99) as p99\n        by bin(1h)\n\n# 相関ID追跡（構造化ログ）\nfilter correlationId = \"abc-123\"\n| fields @timestamp, @message, service, statusCode\n| sort @timestamp asc\n\n# コールドスタート検出\nfilter @message like /Init Duration/\n| parse @message '* ms' as initDuration\n| stats avg(initDuration) by functionName",
			"codeLanguage": "bash"
		},
		{
			"title": "CloudWatch Alarms — 設計パターン",
			"layout": "default",
			"content": [
				"**単一アラーム**: メトリクス閾値 → OK / ALARM / INSUFFICIENT_DATA",
				"**複合アラーム（Composite）**: 複数アラームのAND/OR結合 → アラーム疲れ防止",
				"**Anomaly Detection**: 統計モデルで異常自動検知（閾値設定不要）",
				"**M of N評価**: N期間中M回違反で発火（スパイク誤検知防止）",
				"**アクション**: SNS → Lambda/PagerDuty, Auto Scaling, EC2 Actions, Systems Manager",
				"試験TIP: `ALARM`状態 = 閾値超過、`INSUFFICIENT_DATA` ≠ アラーム（データ不足）"
			]
		},
		{
			"title": "CloudWatch Dashboards",
			"layout": "default",
			"content": [
				"**ウィジェット種類**: Line/Number/Bar/Explorer/Log Table/Alarm Status/Text",
				"**クロスアカウント表示**: Organizations統合で複数アカウントを一画面に",
				"**共有ダッシュボード**: URL共有（認証なし）/ Cognito認証付き共有",
				"**自動ダッシュボード**: サービス別に自動生成（EC2/Lambda/DDB等）",
				"**Variable機能**: ダッシュボード変数でフィルタ切り替え（環境/リージョン等）",
				"コスト: 最初3ダッシュボード無料、以降 $3/ダッシュボード/月"
			]
		},
		{
			"title": "CloudWatch Synthetics + RUM",
			"layout": "default",
			"content": [
				"**Synthetics（合成監視）**: Canaryスクリプト（Node.js/Python）で外形監視",
				"  - Heartbeat: URL応答確認（最もシンプル）",
				"  - API Canary: REST APIエンドポイント検証",
				"  - Broken Link Checker: リンク切れ検出",
				"  - Visual Monitoring: スクリーンショット比較",
				"**CloudWatch RUM（リアルユーザー監視）**:",
				"  - JSスニペット埋め込み → Core Web Vitals / JavaScript エラー収集",
				"  - LCP/FID/CLS/TTFB をリアルユーザーデータで計測",
				"  - X-Ray連携でバックエンドトレースとの紐付け可能"
			]
		},
		{
			"title": "Container Insights + Lambda Insights",
			"layout": "default",
			"content": [
				"**Container Insights（EKS/ECS対応）**:",
				"  - ADOT/CloudWatch Agentで収集: CPU/Memory/Network/Disk/Pod数",
				"  - `/aws/containerinsights/<cluster>/performance` へ書き込み",
				"  - コスト: 約$0.50/ノード/月（概算）",
				"**Lambda Insights**:",
				"  - Lambda Layer追加で自動収集: init_duration/used_memory/cpu_total_time",
				"  - コールドスタート頻度・メモリ使用効率分析に最適",
				"**試験TIP**: Container Insights はデフォルト無効。eksctl/Console/CDKで明示的に有効化必要"
			]
		},
		{
			"title": "Ch.3 AWS X-Ray — 分散トレーシング",
			"layout": "section",
			"content": [
				"Trace / Segment / Subsegment / ServiceMap",
				"Lambda / ECS / EKS 統合 / サンプリング戦略"
			]
		},
		{
			"title": "X-Ray 概念 — Trace構造",
			"layout": "default",
			"content": [
				"**Trace**: 1リクエストのエンドツーエンドの記録（Trace ID で紐付け）",
				"**Segment**: サービス1つ分の処理記録（開始/終了時刻・HTTP情報・エラー）",
				"**Subsegment**: Segment内の細分（DDB呼び出し・外部HTTP・カスタム処理）",
				"**Annotation**: インデックス可能なキーバリュー（フィルタ検索に使用）",
				"**Metadata**: 非インデックスの追加情報（大きなオブジェクトも格納可）",
				"**X-Ray Trace Header**: `X-Amzn-Trace-Id: Root=1-xxx;Parent=yyy;Sampled=1`"
			]
		},
		{
			"title": "X-Ray Service Map",
			"layout": "default",
			"content": [
				"**Service Map**: サービス間の依存関係グラフを自動生成",
				"各ノードに表示される情報:",
				"  - 平均レイテンシ・リクエスト数/秒・エラー率",
				"  - Fault（5xx）/ Error（4xx）/ Throttle（429）を色分け",
				"**ServiceLens**: X-Ray Service Map + CloudWatch Metricsの統合ビュー",
				"  - メトリクス・ログ・トレースを1画面で確認",
				"  - SLA違反の原因を数クリックで特定",
				"**試験TIP**: X-Rayはデフォルトで**サンプリング**（全件記録ではない）→ コスト管理が必要"
			]
		},
		{
			"title": "X-Ray SDK vs X-Ray daemon vs ADOT",
			"layout": "default",
			"content": [
				"**X-Ray SDK（旧来）**: AWS SDK直接依存、X-Ray固有API、AWS専用",
				"**X-Ray daemon**: UDP 2000番でセグメント受信 → X-Ray API転送（サイドカー/デーモン）",
				"**ADOT（OpenTelemetry）**: ベンダーニュートラル、OTLP gRPC/HTTP、X-Ray以外にも送信可",
				"| 比較項目 | X-Ray SDK | ADOT |",
				"| ベンダー依存 | AWS固有 | ベンダーニュートラル |",
				"| Auto-instrument | 一部 | 充実（Java/Node.js/Python）|",
				"| 推奨新規開発 | — | ✅ |",
				"**推奨**: 新規開発はADOT + OTLP。既存X-Ray SDKはそのまま使用可"
			]
		},
		{
			"title": "Lambda + X-Ray設定",
			"layout": "default",
			"content": [
				"Active Tracing有効化でLambdaがX-Rayに自動でセグメントを送信"
			],
			"code": "# CDKでActive Tracing有効化\nconst fn = new lambda.Function(this, 'MyFn', {\n  tracing: lambda.Tracing.ACTIVE, // PassThrough も選択可\n  layers: [adotLayer],            // ADOT Layer追加\n});\n\n# Lambda Powertools (TypeScript) でサブセグメント作成\nimport { Tracer } from '@aws-lambda-powertools/tracer';\nconst tracer = new Tracer({ serviceName: 'OrderService' });\n\nexport const handler = tracer.captureLambdaHandler(async (event) => {\n  const segment = tracer.getSegment();\n  const subsegment = segment.addNewSubsegment('## fetchFromDB');\n  try {\n    const result = await db.getOrder(event.orderId);\n    tracer.putAnnotation('orderId', event.orderId);\n    tracer.putMetadata('orderDetails', result);\n    return result;\n  } finally { subsegment.close(); }\n});",
			"codeLanguage": "typescript"
		},
		{
			"title": "ECS/Fargate + X-Ray サイドカー",
			"layout": "default",
			"content": [
				"ECS TaskDefinitionにX-Ray daemonコンテナをサイドカーとして追加"
			],
			"code": "# ECS Task Definition (CDK)\nconst taskDef = new ecs.FargateTaskDefinition(this, 'Task');\n\n// X-Ray daemon サイドカー\ntaskDef.addContainer('xray-daemon', {\n  image: ecs.ContainerImage.fromRegistry(\n    'amazon/aws-xray-daemon'\n  ),\n  portMappings: [{ containerPort: 2000, protocol: ecs.Protocol.UDP }],\n  cpu: 32,\n  memoryLimitMiB: 256,\n  logging: ecs.LogDrivers.awsLogs({\n    logGroup: new logs.LogGroup(this, 'XRayLogs'),\n    streamPrefix: 'xray',\n  }),\n});\n\n// アプリコンテナの環境変数\ntaskDef.addContainer('app', {\n  environment: {\n    AWS_XRAY_DAEMON_ADDRESS: 'xray-daemon:2000',\n  },\n});",
			"codeLanguage": "typescript"
		},
		{
			"title": "EKS + X-Ray (ADOT Collector)",
			"layout": "default",
			"content": [
				"EKSではADOT Operator経由でCollectorを管理し、X-Ray Exporterへ転送"
			],
			"code": "# OpenTelemetryCollector CR (X-Ray exporter)\napiVersion: opentelemetry.io/v1alpha1\nkind: OpenTelemetryCollector\nmetadata:\n  name: adot-xray\nspec:\n  mode: daemonset\n  serviceAccount: adot-collector  # IRSA設定済み\n  config: |\n    receivers:\n      otlp:\n        protocols:\n          grpc:\n            endpoint: 0.0.0.0:4317\n    processors:\n      batch:\n        timeout: 1s\n    exporters:\n      awsxray:\n        region: ap-northeast-1\n    service:\n      pipelines:\n        traces:\n          receivers: [otlp]\n          processors: [batch]\n          exporters: [awsxray]",
			"codeLanguage": "yaml"
		},
		{
			"title": "API Gateway + X-Ray統合",
			"layout": "default",
			"content": [
				"**API Gateway X-Ray有効化**: Tracing → Active で全リクエストにTrace ID付与",
				"**Sampling Rule適用**: API GW → Lambda → DynamoDB の全ホップを追跡",
				"**注意点**: API Gateway自身のSegmentは「AWS::ApiGateway::Stage」として記録",
				"**HTTP API vs REST API**: 両方ともX-Ray対応、設定方法が若干異なる",
				"**CloudFront連携**: CloudFrontはX-Rayに対応（2023年以降、一部リージョン）",
				"試験TIP: API Gatewayでのエラーは`Fault`（5xx）か`Error`（4xx）かで原因特定"
			]
		},
		{
			"title": "X-Ray アノテーションとメタデータ",
			"layout": "default",
			"content": ["**Annotation vs Metadata の使い分け**:"],
			"code": "// Annotation: インデックス可能 → フィルタ/グループ化に使用\n// 型: string/number/boolean のみ\ntracer.putAnnotation('userId', userId);\ntracer.putAnnotation('orderId', orderId);\ntracer.putAnnotation('region', 'ap-northeast-1');\n\n// Metadata: インデックス不可 → 詳細デバッグ情報\n// 型: オブジェクト・配列も可（最大64KB）\ntracer.putMetadata('requestPayload', event.body);\ntracer.putMetadata('dbQueryPlan', queryPlan);\n\n// X-Ray Console でAnnotationフィルタ\n// annotation.userId = \"user-123\" AND annotation.env = \"prod\"\n\n// X-Ray Groups でアノテーション条件グループ作成\n// aws xray create-group --group-name \"HighValueOrders\"\n//   --filter-expression 'annotation.orderValue > 10000'",
			"codeLanguage": "typescript"
		},
		{
			"title": "X-Ray Groups と Insights",
			"layout": "default",
			"content": [
				"**X-Ray Groups**: フィルタ式でトレースをグループ化 → 個別にSamplingRule設定可",
				"**用途**: サービス別・エラー種別・高優先リクエスト別の分析",
				"**X-Ray Insights**: エラー急増・レイテンシ異常を自動検知 → SNS通知",
				"  - Anomaly Detection: 過去のパターンと比較して異常を検出",
				"  - Root Cause Analysis: 影響を受けたサービスの自動特定",
				"  - Impact Summary: 影響ユーザー数・リクエスト数の推計",
				"試験TIP: X-Ray Insightsは**自動**で異常検知 → 手動アラーム設定不要"
			]
		},
		{
			"title": "X-Ray サンプリングルール",
			"layout": "default",
			"content": ["サンプリングでコストを制御（デフォルト: 5%, 最大1TPS）"],
			"code": "# カスタムサンプリングルール\naws xray create-sampling-rule \\\n  --sampling-rule '{\n    \"RuleName\": \"HighPriorityOrders\",\n    \"Priority\": 1,\n    \"ReservoirSize\": 5,\n    \"FixedRate\": 0.10,\n    \"URLPath\": \"/api/orders/*\",\n    \"HTTPMethod\": \"POST\",\n    \"ServiceName\": \"OrderService\",\n    \"ServiceType\": \"AWS::Lambda::Function\"\n  }'\n\n# ヘルスチェックを除外（サンプリング0%）\naws xray create-sampling-rule \\\n  --sampling-rule '{\n    \"RuleName\": \"ExcludeHealthCheck\",\n    \"Priority\": 1,\n    \"ReservoirSize\": 0,\n    \"FixedRate\": 0,\n    \"URLPath\": \"/health\",\n    \"HTTPMethod\": \"GET\"\n  }'",
			"codeLanguage": "bash"
		},
		{
			"title": "X-Ray + ServiceLens統合",
			"layout": "default",
			"content": [
				"**ServiceLens** = X-Ray Service Map + CloudWatch Metrics + Logs の統合ビュー",
				"**ノードをクリック**すると表示される情報:",
				"  - Request rate / Fault rate / Error rate / Throttle rate",
				"  - 平均レイテンシ / p99レイテンシ",
				"  - 関連ログ（Logs Insightsへ遷移）",
				"  - 関連トレース（X-Ray Consoleへ遷移）",
				"**設定条件**: X-Ray Active Tracing有効 + サービスがX-Ray SDKまたはADOTを使用",
				"試験TIP: ServiceLensはCloudWatchのコンソール内（X-Rayコンソールとは別）"
			]
		},
		{
			"title": "トレース分析パターン",
			"layout": "default",
			"content": [
				"**レイテンシ分析**: 遅いSubsegmentを特定 → DDB/RDS/外部API呼び出しを疑う",
				"**N+1クエリ検出**: ループ内DB呼び出しがSegmentに多数のSubsegment生成",
				"**エラー伝播**: 上流エラーが下流Faultになる連鎖を可視化",
				"**Cold Start影響**: Lambda InitセグメントがTraceの先頭に表示",
				"**Throttling分析**: `ThrottleException` がSubsegmentに記録 → SQSでバッファリング検討",
				"**非同期フロー追跡**: SQS/SNS経由でもTrace IDを`AWSTraceHeader`属性で伝播可能"
			]
		},
		{
			"title": "X-Ray コスト最適化",
			"layout": "default",
			"content": [
				"**X-Rayの料金構造**: 記録$5/1M, 取得$0.50/1M, スキャン$0.50/1Mセグメント",
				"**最初100万Trace/月は無料（Free Tier）**",
				"**コスト削減戦略**:",
				"  - サンプリング率を下げる（本番環境: 1〜5%が多い）",
				"  - ヘルスチェック・Ping URLをサンプリング0%に設定",
				"  - Reservoir（固定TPS）を適切に設定し、スパイク時のコスト増を抑制",
				"  - X-Ray Groups でフィルタ → 取得コストを削減",
				"**目安**: EKS 100Pod × 1000req/s → サンプリング1% → 約$30/月"
			]
		},
		{
			"title": "Ch.4 OpenTelemetry on AWS (ADOT)",
			"layout": "section",
			"content": [
				"AWS Distro for OpenTelemetry",
				"Lambda / EKS / ECS 対応 — Java/Node.js/Python SDK実装"
			]
		},
		{
			"title": "OpenTelemetry概要",
			"layout": "default",
			"content": [
				"**OpenTelemetry（OTel）**: CNCF（Cloud Native Computing Foundation）のObservability標準",
				"**目標**: Logs/Metrics/Tracesの収集・変換・エクスポートを統一API/SDKで実現",
				"**主要コンポーネント**:",
				"  - **API**: テレメトリ生成の抽象インターフェース（ベンダー非依存）",
				"  - **SDK**: APIの実装（言語ごと）",
				"  - **Collector**: エージェント/プロキシ（受信→処理→転送）",
				"  - **OTLP**: OpenTelemetry Line Protocol（gRPC/HTTP）",
				"**AWS ADOT**: AWSが管理するOTelディストリビューション（セキュリティパッチ・互換性保証）"
			]
		},
		{
			"title": "OTel三本柱とADOT配置",
			"layout": "default",
			"content": [
				"**Traces**: OpenTelemetry TraceAPI → OTLP → ADOT Collector → X-Ray / Jaeger",
				"**Metrics**: OpenTelemetry MetricsAPI → OTLP → ADOT Collector → AMP / CW EMF",
				"**Logs**: OpenTelemetry LogsAPI → OTLP → ADOT Collector → CW Logs / S3",
				"**ADOT展開パターン**:",
				"  - Lambda: Lambda Layer（Extension）としてサイドカー展開",
				"  - EKS: DaemonSet / Sidecar / Deployment（用途に応じて選択）",
				"  - ECS: Sidecar コンテナとしてTask Definitionに追加",
				"  - EC2: systemdサービスとして起動"
			]
		},
		{
			"title": "ADOT Collectorアーキテクチャ",
			"layout": "default",
			"content": ["![w:880 center](assets/adot-architecture.svg)"]
		},
		{
			"title": "ADOT Collector設定 — フル構成例",
			"layout": "default",
			"content": ["X-Ray + AMP + CloudWatch を同時に受信・転送する設定例"],
			"code": "receivers:\n  otlp:\n    protocols:\n      grpc: { endpoint: 0.0.0.0:4317 }\n      http: { endpoint: 0.0.0.0:4318 }\n  prometheus:\n    config:\n      scrape_configs:\n        - job_name: 'k8s-pods'\n          kubernetes_sd_configs:\n            - role: pod\nprocessors:\n  batch: { timeout: 5s, send_batch_size: 1000 }\n  resourcedetection:\n    detectors: [eks, ec2, env]\n  filter/drop_health:\n    spans:\n      exclude:\n        match_type: strict\n        attributes:\n          - { key: http.url, value: /health }\nexporters:\n  awsxray:  { region: ap-northeast-1 }\n  awsemf:   { namespace: MyApp/Metrics, region: ap-northeast-1 }\n  prometheusremotewrite:\n    endpoint: https://aps-workspaces.../api/v1/remote_write\n    auth: { authenticator: sigv4auth }\nservice:\n  pipelines:\n    traces:  { receivers: [otlp], processors: [batch,resourcedetection,filter/drop_health], exporters: [awsxray] }\n    metrics: { receivers: [otlp,prometheus], processors: [batch], exporters: [awsemf,prometheusremotewrite] }",
			"codeLanguage": "yaml"
		},
		{
			"title": "Lambda + ADOT Layer",
			"layout": "default",
			"content": [
				"Lambda LayerとしてADOTを追加 — 既存コードを変更せずに計装可能"
			],
			"code": "# CDK: ADOT Lambda Layer追加\nconst adotLayer = lambda.LayerVersion.fromLayerVersionArn(\n  this, 'AdotLayer',\n  `arn:aws:lambda:ap-northeast-1:901920570463:layer:\\\n   aws-otel-nodejs-amd64-ver-1-18-1:4`\n);\n\nconst fn = new lambda.Function(this, 'Fn', {\n  runtime: lambda.Runtime.NODEJS_20_X,\n  handler: 'index.handler',\n  layers: [adotLayer],\n  environment: {\n    AWS_LAMBDA_EXEC_WRAPPER: '/opt/otel-handler',\n    OPENTELEMETRY_COLLECTOR_CONFIG_FILE:\n      '/var/task/collector.yaml',\n  },\n  tracing: lambda.Tracing.ACTIVE,\n});\n\n// collector.yaml (Lambda内に配置)\n// receivers: { otlp: {} }\n// exporters: { awsxray: {}, awsemf: {} }\n// service:\n//   pipelines:\n//     traces: { receivers: [otlp], exporters: [awsxray] }",
			"codeLanguage": "typescript"
		},
		{
			"title": "EKS + ADOT Operator",
			"layout": "default",
			"content": [
				"ADOT Operatorは OpenTelemetryCollector CRDを提供 — Collector管理を自動化"
			],
			"code": "# ADOT Operator インストール\nhelm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts\nhelm install opentelemetry-operator \\\n  open-telemetry/opentelemetry-operator \\\n  --namespace opentelemetry-operator-system\n\n# Auto-instrumentation設定（Java自動計装）\napiVersion: opentelemetry.io/v1alpha1\nkind: Instrumentation\nmetadata:\n  name: java-instrumentation\nspec:\n  exporter:\n    endpoint: http://adot-collector:4317\n  propagators: [tracecontext, baggage, xray]\n  sampler:\n    type: parentbased_traceidratio\n    argument: \"0.05\"  # 5%サンプリング\n  java:\n    image: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:latest\n\n# PodにAnnotation追加だけで自動計装\nmetadata:\n  annotations:\n    instrumentation.opentelemetry.io/inject-java: \"true\"",
			"codeLanguage": "yaml"
		},
		{
			"title": "Java Auto-instrumentation",
			"layout": "default",
			"content": [
				"**OTel Java Javaagent**: バイトコードインジェクションで自動計装（コード変更不要）",
				"**対応ライブラリ**: Spring Boot / Quarkus / gRPC / JDBC / Kafka / Redis / MongoDB etc.",
				"JVM起動オプションに `-javaagent` を追加するだけで動作"
			],
			"code": "# Dockerfile\nFROM amazoncorretto:17\nCOPY opentelemetry-javaagent.jar /app/\nCOPY app.jar /app/\n\nENV JAVA_TOOL_OPTIONS=\"-javaagent:/app/opentelemetry-javaagent.jar\"\nENV OTEL_EXPORTER_OTLP_ENDPOINT=\"http://adot-collector:4317\"\nENV OTEL_RESOURCE_ATTRIBUTES=\"service.name=order-service,env=prod\"\nENV OTEL_PROPAGATORS=\"tracecontext,baggage,xray\"\nENV OTEL_TRACES_SAMPLER=\"parentbased_traceidratio\"\nENV OTEL_TRACES_SAMPLER_ARG=\"0.05\"\n\nCMD [\"java\", \"-jar\", \"/app/app.jar\"]\n\n# 計装される主なライブラリ（自動）\n# Spring MVC / WebFlux / RestTemplate / WebClient\n# JDBC / Hibernate / R2DBC\n# AWS SDK v2（DynamoDB/S3/SQS）",
			"codeLanguage": "dockerfile"
		},
		{
			"title": "Node.js OpenTelemetry SDK",
			"layout": "default",
			"content": [
				"Node.js SDKによる手動計装とAuto-instrumentation（`@opentelemetry/auto-instrumentations-node`）"
			],
			"code": "// tracing.ts (アプリ起動前にimport)\nimport { NodeSDK } from '@opentelemetry/sdk-node';\nimport { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-grpc';\nimport { AWSXRayPropagator } from '@aws/aws-xray-propagator';\nimport { AWSXRayIdGenerator } from '@aws/aws-xray-id-generator';\n\nconst sdk = new NodeSDK({\n  traceExporter: new OTLPTraceExporter({\n    url: 'http://localhost:4317', // ADOT Collector\n  }),\n  instrumentations: [getNodeAutoInstrumentations()],\n  idGenerator: new AWSXRayIdGenerator(),     // X-Ray互換ID\n  textMapPropagator: new AWSXRayPropagator(), // X-Ray Trace Header\n});\n\nsdk.start(); // Express/Fastify/Koa が自動計装される",
			"codeLanguage": "typescript"
		},
		{
			"title": "Python OpenTelemetry SDK",
			"layout": "default",
			"content": [
				"Python SDK + `opentelemetry-instrument` コマンドで最小変更で計装可能"
			],
			"code": "# pip install\n# opentelemetry-sdk opentelemetry-exporter-otlp\n# opentelemetry-instrumentation-flask\n# opentelemetry-instrumentation-botocore\n# aws-opentelemetry-distro\n\n# tracing.py\nfrom opentelemetry import trace\nfrom opentelemetry.sdk.trace import TracerProvider\nfrom opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter\nfrom opentelemetry.sdk.trace.export import BatchSpanProcessor\nfrom opentelemetry.propagators.aws import AwsXRayPropagator\n\nprovider = TracerProvider()\nexporter = OTLPSpanExporter(endpoint='http://localhost:4317')\nprovider.add_span_processor(BatchSpanProcessor(exporter))\ntrace.set_tracer_provider(provider)\n\ntracer = trace.get_tracer(__name__)\n\n@app.route('/order', methods=['POST'])\ndef create_order():\n    with tracer.start_as_current_span('create-order') as span:\n        span.set_attribute('order.id', order_id)\n        return process_order(request.json)",
			"codeLanguage": "python"
		},
		{
			"title": "カスタムSpanの作成",
			"layout": "default",
			"content": [
				"**Span属性のベストプラクティス**: OpenTelemetry Semantic Conventions準拠"
			],
			"code": "import { trace, context, SpanStatusCode } from '@opentelemetry/api';\nconst tracer = trace.getTracer('payment-service', '1.0.0');\n\nasync function processPayment(paymentData: PaymentRequest) {\n  // 手動Span作成\n  return tracer.startActiveSpan('payment.process', async (span) => {\n    try {\n      // Semantic Conventions準拠の属性\n      span.setAttributes({\n        'payment.method': paymentData.method,\n        'payment.amount': paymentData.amount,\n        'payment.currency': paymentData.currency,\n        'user.id': paymentData.userId,\n        // HTTP Semantic Conventions\n        'http.method': 'POST',\n        'http.url': 'https://payment-provider.example',\n      });\n      const result = await callPaymentProvider(paymentData);\n      span.setStatus({ code: SpanStatusCode.OK });\n      return result;\n    } catch (err) {\n      span.setStatus({ code: SpanStatusCode.ERROR, message: err.message });\n      span.recordException(err); // スタックトレースを記録\n      throw err;\n    } finally { span.end(); }\n  });\n}",
			"codeLanguage": "typescript"
		},
		{
			"title": "Baggageによるコンテキスト伝播",
			"layout": "default",
			"content": [
				"**Baggage**: サービス間をまたいで任意のキーバリューを伝播する仕組み",
				"**用途**: テナントID・機能フラグ・A/Bテストグループをトレース全体に伝播",
				"**注意**: Baggageは全ホップに転送される → 機密情報は入れない",
				"**X-Ray Annotation vs Baggage**: X-Ray Annotationはそのサービスのみ、Baggageは下流全体に伝播",
				"実装: HTTPヘッダ `baggage: userId=user-123,feature=new-checkout` で伝播",
				"受信側: `propagation.getBaggage(context.active()).getEntry('userId')`"
			]
		},
		{
			"title": "ADOT → AMP Exporter設定",
			"layout": "default",
			"content": ["Amazon Managed PrometheusへSigV4認証付きでremote_write"],
			"code": "# ADOT Collector config.yaml (AMP exporter)\nextensions:\n  sigv4auth:\n    region: ap-northeast-1\n    service: aps\n\nexporters:\n  prometheusremotewrite:\n    endpoint: https://aps-workspaces.ap-northeast-1.amazonaws.com/\\\nworkspaces/ws-xxxxxxxx/api/v1/remote_write\n    auth:\n      authenticator: sigv4auth\n    resource_to_telemetry_conversion:\n      enabled: true\n    tls:\n      insecure: false\n\n# Prometheus remote_write (代替方法)\n# prometheus.yml\nremote_write:\n  - url: https://aps-workspaces.../api/v1/remote_write\n    sigv4:\n      region: ap-northeast-1\n      # IAMロールはIRSAで付与\n    queue_config:\n      max_samples_per_send: 1000\n      batch_send_deadline: 5s",
			"codeLanguage": "yaml"
		},
		{
			"title": "OTel vs AWS固有SDK — 選択基準",
			"layout": "default",
			"content": [
				"| シナリオ | 推奨 | 理由 |",
				"| 新規開発（AWS環境） | **ADOT + OTel SDK** | 将来の移植性・Auto-instrument充実 |",
				"| Lambda Powertools利用中 | **Powertools継続** | X-Ray統合済み・シンプル |",
				"| マルチクラウド/ハイブリッド | **OTel SDK** | ベンダーロックイン回避 |",
				"| X-Ray SDK既存コード | **既存継続** | 再実装コスト不要 |",
				"| Prometheus既存環境 | **ADOT（Prom互換）** | スクレイプ設定をそのまま活用 |",
				"**結論**: 新規は迷わずADOT+OTel SDK。X-RayとPrometheusどちらにも送れる柔軟性"
			]
		},
		{
			"title": "Ch.5 Amazon Managed Prometheus + Grafana",
			"layout": "section",
			"content": [
				"AMP (Amazon Managed Service for Prometheus)",
				"AMG (Amazon Managed Grafana) — セットアップ・ダッシュボード設計"
			]
		},
		{
			"title": "Amazon Managed Prometheus (AMP) 概要",
			"layout": "default",
			"content": [
				"**AMP**: フルマネージドのPrometheusサービス（サーバー管理不要）",
				"**互換性**: Prometheus API完全互換（PromQL, recording rules, alerting rules）",
				"**スケール**: 数十億メトリクスを自動スケール（セルフホストでは困難な規模）",
				"**マルチAZ**: 高可用性レプリケーション（デフォルト）",
				"**セキュリティ**: VPCエンドポイント + SigV4認証 + IRSA",
				"**料金**: $0.90/GiB ingested + $0.03/GiB stored/月 + $0.01/DPM query（最初10GiB無料）"
			]
		},
		{
			"title": "AMP ワークスペース作成・IRSA設定",
			"layout": "default",
			"content": ["AMPワークスペース作成とEKSからの書き込みIRSA設定"],
			"code": "# AMP ワークスペース作成\naws amp create-workspace \\\n  --alias my-workspace \\\n  --region ap-northeast-1\n# → workspaceId: ws-xxxxxxxx\n\n# IRSA設定（ADOT Collector用）\neksctl create iamserviceaccount \\\n  --name adot-collector \\\n  --namespace monitoring \\\n  --cluster my-cluster \\\n  --attach-policy-arn \\\n    arn:aws:iam::aws:policy/AmazonPrometheusRemoteWriteAccess \\\n  --approve --override-existing-serviceaccounts\n\n# 追加ポリシー（X-Ray + CW Logs用）\naws iam attach-role-policy \\\n  --role-name eksctl-my-cluster-addon-iamserviceacc-... \\\n  --policy-arn \\\n    arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess",
			"codeLanguage": "bash"
		},
		{
			"title": "Prometheus recording rules でコスト最適化",
			"layout": "default",
			"content": [
				"**recording rules**: 高頻度クエリを事前集計 → クエリコスト削減 + ダッシュボード高速化"
			],
			"code": "# AMP Alerting + Recording Rules\naws amp create-rule-groups-namespace \\\n  --workspace-id ws-xxxxxxxx \\\n  --name monitoring-rules \\\n  --data file://rules.yaml\n\n# rules.yaml\ngroups:\n  - name: recording_rules\n    rules:\n      # 5分集計でカーディナリティ削減\n      - record: job:http_requests_total:rate5m\n        expr: rate(http_requests_total[5m])\n      - record: job:http_error_rate:rate5m\n        expr: |\n          rate(http_requests_total{status=~\"5..\"}[5m])\n          / rate(http_requests_total[5m])\n  - name: alerting_rules\n    rules:\n      - alert: HighErrorRate\n        expr: job:http_error_rate:rate5m > 0.05\n        for: 5m\n        labels: { severity: critical }\n        annotations:\n          summary: \"Error rate > 5%: {{ $value | humanize }}\"",
			"codeLanguage": "yaml"
		},
		{
			"title": "Amazon Managed Grafana (AMG) 概要",
			"layout": "default",
			"content": [
				"**AMG**: フルマネージドのGrafanaサービス（バージョン管理・プラグイン管理不要）",
				"**データソース**: AMP / CloudWatch / X-Ray / Athena / OpenSearch / Timestream など",
				"**認証**: IAM Identity Center (SSO) / SAML 2.0 / AWS Organizations連携",
				"**権限**: Admin / Editor / Viewer の3ロール",
				"**料金**: $9/active editor/月, $5/active viewer/月（2ユーザーまで無料）",
				"**Grafana Enterprise**: 追加プラグイン（Datadog/Splunk連携等）有料プランで利用可"
			]
		},
		{
			"title": "AMG セットアップ — IAM Identity Center連携",
			"layout": "default",
			"content": [
				"**前提**: IAM Identity Center有効化（Organizations推奨）",
				"**手順**:",
				"  1. AMGワークスペース作成（Console / CLI）",
				"  2. 認証プロバイダーにIAM Identity Centerを選択",
				"  3. データソースをAWS managed（CW/X-Ray/AMP）で追加",
				"  4. IAM Identity Centerでユーザー/グループをワークスペースに割り当て",
				"  5. Grafanaコンソールにアクセス（SSO URL経由）",
				"**SAML統合**: Okta/Azure ADとSAML 2.0で連携可（Enterprise IdP利用時）"
			]
		},
		{
			"title": "Grafana データソース設定",
			"layout": "default",
			"content": ["AMGでAMP/CloudWatch/X-Rayを設定し統合ダッシュボードを作成"],
			"code": "# Grafana as Code (Terraform)\nresource \"aws_grafana_workspace\" \"main\" {\n  name                     = \"prod-observability\"\n  account_access_type      = \"CURRENT_ACCOUNT\"\n  authentication_providers = [\"AWS_SSO\"]\n  permission_type          = \"SERVICE_MANAGED\"\n  data_sources = [\n    \"CLOUDWATCH\",\n    \"PROMETHEUS\",  # AMP\n    \"XRAY\",\n    \"AMAZON_OPENSEARCH_SERVICE\",\n  ]\n  role_arn = aws_iam_role.grafana.arn\n}\n\n# Grafana IAMロール（各データソースへのRead権限）\n# AmazonGrafanaCloudWatchAccess\n# AmazonPrometheusQueryAccess\n# AWSXRayReadOnlyAccess\n# + CloudFormation Stack IDからWorkspace IDを参照",
			"codeLanguage": "hcl"
		},
		{
			"title": "Grafana ダッシュボード設計ベストプラクティス",
			"layout": "default",
			"content": [
				"**4 Golden Signals（SREの基本）**:",
				"  - **Latency**: リクエスト処理時間（p50/p95/p99）",
				"  - **Traffic**: リクエスト数/秒（RPS）",
				"  - **Errors**: エラー率（5xx/4xx 比率）",
				"  - **Saturation**: リソース使用率（CPU/Memory/Disk）",
				"**USE Method（インフラ向け）**: Utilization / Saturation / Errors",
				"**RED Method（サービス向け）**: Rate / Errors / Duration",
				"**ダッシュボード設計原則**: 上位概要 → ドリルダウン / 閾値線を表示 / 変数で環境切替"
			]
		},
		{
			"title": "Grafana アラート設定",
			"layout": "default",
			"content": [
				"**Grafana Unified Alerting**: ダッシュボードパネルからアラート設定 → 通知チャンネルへ",
				"**Contact Points**: SNS / PagerDuty / Slack / OpsGenie / Webhook",
				"**Notification Policies**: ルーティングルール（severity/teamでグループ化）",
				"**Silences**: メンテナンス時間帯のアラーム抑制",
				"**評価間隔**: 1分 / 5分 / 15分 → PromQLクエリコストとのトレードオフ",
				"試験TIP: AMGアラートはGrafana管理（CloudWatch Alarmsとは独立）— 重複に注意"
			]
		},
		{
			"title": "EKS監視ダッシュボード例",
			"layout": "default",
			"content": [
				"**EKSダッシュボード構成（AMG + AMP）**:",
				"  - **Cluster Overview**: Node数・Pod数・Namespace別リソース使用量",
				"  - **Node Detail**: CPU/Memory使用率・Disk I/O・Network帯域",
				"  - **Pod Detail**: コンテナCPU/Memory・Restart回数・OOMKill検出",
				"  - **Deployment Health**: ReplicaSet状態・Rollout進捗",
				"**Grafana公式ダッシュボードID活用**:",
				"  - Dashboard ID 17682: Kubernetes All-in-one (AMP版)",
				"  - Dashboard ID 6417: Kubernetes Cluster (Prometheus)",
				"  - インポート → Grafana.comダッシュボードIDを入力するだけで即利用"
			]
		},
		{
			"title": "SLO/SLI/エラーバジェット管理",
			"layout": "default",
			"content": [
				"**SLI（Service Level Indicator）**: 測定値（例: p99レイテンシ、エラー率）",
				"**SLO（Service Level Objective）**: 目標値（例: p99 < 500ms, 99.9%稼働）",
				"**エラーバジェット**: 1 - SLO目標値（99.9% SLO → 0.1%のエラーを許容）",
				"**Grafana SLO Plugin**: SLI/SLO定義 → エラーバジェット消費グラフを自動生成",
				"**PromQL例**: `1 - (sum(rate(http_errors[30d])) / sum(rate(http_requests[30d])))`",
				"運用: エラーバジェット50%消費 → 開発凍結、100%消費 → SRE対応優先"
			]
		},
		{
			"title": "AMG vs セルフホストGrafana",
			"layout": "default",
			"content": [
				"| 比較項目 | Amazon Managed Grafana | セルフホスト |",
				"| 運用負荷 | なし（マネージド） | 高（k8s/ECS管理） |",
				"| バージョン管理 | AWS管理 | 自己管理 |",
				"| HA構成 | 自動 | 手動設定必要 |",
				"| プラグイン | 制限あり | 自由 |",
				"| コスト（小規模）| $9/editor/月 | EC2/Fargate費用 |",
				"| コスト（大規模）| ユーザー数比例 | 固定インフラ費 |",
				"**推奨**: 小〜中規模はAMG。大規模（50+ユーザー）はセルフホストが経済的な場合も"
			]
		},
		{
			"title": "Ch.6 実践パターン — ユースケース別構成",
			"layout": "section",
			"content": [
				"Serverless / EKS / ECS / API Gateway / RDS / DynamoDB",
				"マルチアカウント / Observability as Code"
			]
		},
		{
			"title": "Serverless Observabilityアーキテクチャ",
			"layout": "default",
			"content": ["![w:880 center](assets/serverless-observability.svg)"]
		},
		{
			"title": "Lambda Powertools — 詳細実装",
			"layout": "default",
			"content": [
				"**AWS Lambda Powertools**: SRE/DevOpsベストプラクティスをデコレータで提供"
			],
			"code": "import { Logger } from '@aws-lambda-powertools/logger';\nimport { Tracer } from '@aws-lambda-powertools/tracer';\nimport { Metrics, MetricUnits } from '@aws-lambda-powertools/metrics';\n\nconst logger = new Logger({ serviceName: 'OrderService', logLevel: 'INFO' });\nconst tracer = new Tracer({ serviceName: 'OrderService' });\nconst metrics = new Metrics({ namespace: 'MyApp', serviceName: 'OrderService' });\n\nexport const handler = tracer.captureLambdaHandler(\n  logger.injectLambdaContext(\n    metrics.logMetrics(\n      async (event, context) => {\n        logger.info('Processing order', { orderId: event.orderId });\n        tracer.putAnnotation('orderId', event.orderId);\n\n        const result = await processOrder(event);\n\n        metrics.addMetric('OrderProcessed', MetricUnits.Count, 1);\n        metrics.addDimension('PaymentMethod', event.paymentMethod);\n        logger.info('Order completed', { result });\n        return result;\n      }\n    )\n  )\n);",
			"codeLanguage": "typescript"
		},
		{
			"title": "EKS Observabilityスタック",
			"layout": "default",
			"content": ["![w:880 center](assets/eks-observability-stack.svg)"]
		},
		{
			"title": "ECS Fargate Observability",
			"layout": "default",
			"content": [
				"**ECS Fargate固有の制約**: DaemonSet不可 → サイドカーコンテナで対応",
				"**ADOT Sidecar**: Task DefinitionにADOTコンテナを追加",
				"**FireLens（Fluent Bit）**: ECS標準のログルーターでCloudWatch/S3/Firehoseへ転送",
				"**Container Insights for ECS**: ECS ConsoleからInsights有効化 → CPU/Memory/Network自動収集",
				"**設定手順**:",
				"  1. Task定義にADOT sidecar追加（ports: 4317/4318）",
				"  2. アプリコンテナ環境変数: `OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317`",
				"  3. Task RoleにX-Ray/CW権限付与",
				"  4. ECS CloudWatch Container Insights有効化"
			]
		},
		{
			"title": "API Gateway + Lambda エンドツーエンドトレース",
			"layout": "default",
			"content": [
				"**完全なトレースフロー**: Client → CloudFront → API GW → Lambda → DynamoDB",
				"**設定ポイント**:",
				"  - API GW: Tracing → Active （Stageleベルで設定）",
				"  - Lambda: ADOT Layer + X-Ray Active Tracing",
				"  - DynamoDB: AWS SDK v3はX-Ray自動計装（ADOT使用時）",
				"**Trace Header伝播**: `X-Amzn-Trace-Id` がAPI GW → Lambda自動伝播",
				"**Custom Domain**: Route 53 → ACM → API GW（この区間はX-Ray外）",
				"**API GW Access Logs**: `$context.xrayTraceId` でログとトレースを相関"
			]
		},
		{
			"title": "RDS / Aurora 監視",
			"layout": "default",
			"content": [
				"**RDS Enhanced Monitoring**: OS/プロセスレベルメトリクス（1秒粒度、50指標以上）",
				"**Performance Insights（PI）**: クエリ別・待機イベント別のDB負荷可視化（7日間無料）",
				"**CloudWatch RDS Metrics**: CPU/FreeableMemory/DatabaseConnections/ReadLatency",
				"**PI + X-Ray連携**: アプリトレースのDB Subsegmentとクエリを紐付け",
				"**推奨アラーム**:",
				"  - DatabaseConnections > max_connections × 0.8",
				"  - FreeStorageSpace < 10GB",
				"  - ReadLatency > 50ms（OLTP目安）",
				"試験TIP: Performance InsightsはRDS Pro / Aurora標準（追加料金なし期間あり）"
			]
		},
		{
			"title": "DynamoDB 監視",
			"layout": "default",
			"content": [
				"**主要メトリクス**: SuccessfulRequestLatency / SystemErrors / UserErrors / ThrottledRequests",
				"**ConsumedRCU/WCU**: プロビジョンドモードでは上限を監視してスロットリング防止",
				"**Contributor Insights**: 頻繁にアクセスされるPK/SKを特定（ホットパーティション検出）",
				"**DDB Streams + Lambda**: 変更イベントをトレースに含めることでデータフロー可視化",
				"**CloudWatch Alarms推奨**:",
				"  - ThrottledRequests > 0 → キャパシティ増強またはDAX導入検討",
				"  - SystemErrors > 0 → AWS側問題（自動回復待ち）",
				"試験TIP: UserErrorsは4xx（アプリのバグ）、SystemErrorsは5xx（AWSインフラ）"
			]
		},
		{
			"title": "SQS / SNS / EventBridge 監視",
			"layout": "default",
			"content": [
				"**SQS重要メトリクス**:",
				"  - `ApproximateAgeOfOldestMessage`: 最古メッセージ滞留時間（処理遅延の指標）",
				"  - `ApproximateNumberOfMessagesNotVisible`: 処理中メッセージ数",
				"  - `NumberOfMessagesSent` / `NumberOfMessagesDeleted`",
				"**DLQ監視**: `ApproximateNumberOfMessagesVisible > 0` でアラーム → 処理失敗の検知",
				"**EventBridge失敗検知**: ルールのターゲット失敗 → Dead Letter Queue + CloudWatch",
				"**X-Rayトレース伝播**: SQS経由でも `AWSTraceHeader` 属性でTrace IDを伝播可能"
			]
		},
		{
			"title": "相関IDと構造化ログ設計",
			"layout": "default",
			"content": [
				"**相関ID（Correlation ID）**: リクエストを横断して追跡するためのユニークID"
			],
			"code": "// 構造化ログ設計（JSON形式）\nconst logger = new Logger({\n  serviceName: 'OrderService',\n  persistentLogAttributes: {\n    environment: process.env.ENV,\n    version: process.env.SERVICE_VERSION,\n  },\n});\n\n// X-Ray Trace IDを相関IDとして自動付与（Powertools）\n// 出力例:\n// {\n//   \"level\": \"INFO\",\n//   \"service\": \"OrderService\",\n//   \"timestamp\": \"2026-02-19T04:43:39.000Z\",\n//   \"xray_trace_id\": \"1-65d33c7f-...\",\n//   \"correlation_id\": \"req-uuid-abc123\", // カスタム相関ID\n//   \"cold_start\": false,\n//   \"message\": \"Order processed\",\n//   \"orderId\": \"order-456\",\n//   \"userId\": \"user-789\"\n// }\n\n// Logs Insightsで横断検索\n// filter correlation_id = 'req-uuid-abc123'",
			"codeLanguage": "typescript"
		},
		{
			"title": "カスタムメトリクス設計比較",
			"layout": "default",
			"content": [
				"| 手法 | API | コスト | 用途 |",
				"| PutMetricData | CW API直接 | 高 | シンプルな1件送信 |",
				"| EMF（推奨） | CW Logs経由 | 低 | 複数メトリクス一括・Lambda |",
				"| ADOT + awsemf | Collector経由 | 低 | EKS/ECS複雑なDimension |",
				"| AMP + PromQL | AMP直接 | 中 | Prometheus互換環境 |",
				"**EMFが推奨される理由**:",
				"  - CW Logs書き込みコストのみ（PutMetricDataより大幅安）",
				"  - 1回の書き込みで複数メトリクス＋ログを同時送信",
				"  - Lambda/ECS/EKSどこでも同じSDKが動作"
			]
		},
		{
			"title": "アラート設計ベストプラクティス",
			"layout": "default",
			"content": [
				"**アンチパターン**: 閾値多すぎ → アラーム疲れ（Alert Fatigue）",
				"**ベストプラクティス**:",
				"  - **症状ベースアラート**: 「CPUが80%」より「レスポンスタイムが遅い」",
				"  - **Composite Alarm**: 複数条件AND → 誤検知削減",
				"  - **M of N評価**: 一時的スパイクをフィルタ",
				"  - **Anomaly Detection**: 閾値チューニングなしで異常検知",
				"  - **Runbook URL**: アラームにRunbook/Playbookリンクを記載",
				"  - **オンコールローテーション**: PagerDuty / OpsGenie との連携必須"
			]
		},
		{
			"title": "AIOps — CloudWatch Anomaly Detection",
			"layout": "default",
			"content": [
				"**Anomaly Detection**: 機械学習モデルで通常パターンを学習 → 逸脱を自動検知",
				"**設定方法**: メトリクスにAnomaly Detection Band を作成 → Alarmで使用",
				"**対応メトリクス**: CloudWatch標準 + カスタムメトリクス全て",
				"**学習期間**: 最低2週間のデータで精度向上（週次パターン・季節性を考慮）",
				"**Contributor Insights**: どのリソース/ユーザーが高負荷を引き起こしているか自動分析",
				"**Container Insights + Anomaly Detection**: EKS Pod異常を自動検知 → 自動スケール連携"
			]
		},
		{
			"title": "マルチアカウントObservability",
			"layout": "default",
			"content": [
				"**CloudWatch Cross-account Observability**: Organizations統合で複数アカウントを一元化",
				"**Monitoring Account**: 中央ダッシュボード/アラーム管理アカウント",
				"**Source Accounts**: データを送信するワークロードアカウント",
				"**設定**: CloudFormation StackSetsで全アカウントに一括デプロイ",
				"**AMG Cross-account**: AMGワークスペースに複数アカウントのCW/AMP/X-Rayを追加",
				"**推奨アーキテクチャ**: 共有サービスアカウント（Monitoring）+ 本番/開発/ステージングを分離"
			]
		},
		{
			"title": "Observability as Code (CDK)",
			"layout": "default",
			"content": [
				"観測設定をCDKでコード管理 — ダッシュボード・アラーム・ログ保持を再現可能に"
			],
			"code": "import * as cloudwatch from 'aws-cdk-lib/aws-cloudwatch';\nimport { Dashboard, GraphWidget, Alarm } from 'aws-cdk-lib/aws-cloudwatch';\n\n// ダッシュボードをCDKで定義\nconst dashboard = new Dashboard(stack, 'AppDashboard', {\n  dashboardName: 'OrderService-Production',\n});\n\ndashboard.addWidgets(\n  new GraphWidget({\n    title: 'Order Latency (p99)',\n    left: [orderFn.metricDuration({ statistic: 'p99' })],\n  }),\n  new GraphWidget({\n    title: 'Error Rate',\n    left: [orderFn.metricErrors({ period: Duration.minutes(1) })],\n  })\n);\n\n// アラームもコードで管理\nconst errorAlarm = new Alarm(stack, 'ErrorAlarm', {\n  metric: orderFn.metricErrors(),\n  threshold: 5,\n  evaluationPeriods: 3,\n  datapointsToAlarm: 2, // 3of2\n  treatMissingData: TreatMissingData.NOT_BREACHING,\n});",
			"codeLanguage": "typescript"
		},
		{
			"title": "Ch.7 コスト最適化",
			"layout": "section",
			"content": [
				"CloudWatch Logs / Metrics / X-Ray / AMP/AMG",
				"S3アーカイブ / ROI計算"
			]
		},
		{
			"title": "Observabilityコスト構造マップ",
			"layout": "default",
			"content": ["![w:880 center](assets/observability-cost-map.svg)"]
		},
		{
			"title": "CloudWatch Logs コスト削減",
			"layout": "default",
			"content": [
				"**最大の節約ポイント: 保持期間設定**（Never Expire → 30日で最大90%削減）",
				"**Infrequent Access (IA) クラス**: 収集コスト50%削減（Logs Insights検索は不可）",
				"  - 用途: アーカイブ用途・後日分析しないログ",
				"**Subscription Filter + Firehose → S3**: 長期保存はS3へ（$0.023/GB vs $0.03/GB）",
				"**ログレベル制御**: Lambda環境変数 `POWERTOOLS_LOG_LEVEL=WARN` で本番INFO抑制",
				"**CloudWatch Logs Insights コスト**: スキャン量に比例 → 時間範囲を絞る・パーティションキー使用"
			]
		},
		{
			"title": "カスタムメトリクス コスト最適化",
			"layout": "default",
			"content": [
				"**無料枠を最大活用**: AWS標準メトリクス（EC2/Lambda/RDS）は完全無料",
				"**カスタムメトリクス削減**:",
				"  - Dimension数を減らす（High Cardinality避ける）",
				"  - EMFで複数メトリクスを1 PutLogEvents に集約",
				"  - 不要なカスタムメトリクスをAWS Console → Metricsから削除",
				"**高解像度（1秒）は慎重に**: 1分解像度メトリクスの10倍コスト",
				"**Container Insights**: `--set containerLogs.enabled=false` で不要ログ無効化",
				"試験TIP: カスタムメトリクスの課金は「ユニークなメトリクス名+Dimensionの組合せ」単位"
			]
		},
		{
			"title": "X-Ray サンプリング戦略",
			"layout": "default",
			"content": ["サンプリング設定でコスト制御（本番環境の推奨設定）"],
			"code": "# 本番環境向けサンプリングルール設計\n# 優先度1: ヘルスチェックを除外\naws xray create-sampling-rule --sampling-rule '{\n  \"RuleName\": \"ExcludeHealthCheck\",\n  \"Priority\": 1,\n  \"ReservoirSize\": 0,\n  \"FixedRate\": 0,\n  \"URLPath\": \"/health\",\n  \"HTTPMethod\": \"*\"\n}'\n\n# 優先度2: 高価値APIは5%サンプリング\naws xray create-sampling-rule --sampling-rule '{\n  \"RuleName\": \"PaymentAPI\",\n  \"Priority\": 2,\n  \"ReservoirSize\": 10,\n  \"FixedRate\": 0.05,\n  \"URLPath\": \"/api/payments/*\",\n  \"ServiceName\": \"PaymentService\"\n}'\n\n# デフォルト(優先度10000): 1%サンプリング\n# ReservoirSize: 1 (TPS), FixedRate: 0.01\n# コスト試算: 1000req/s × 1% × 3600 × 24 × 30 = 259.2万/月 → $13/月",
			"codeLanguage": "bash"
		},
		{
			"title": "AMP/AMG コスト最適化",
			"layout": "default",
			"content": [
				"**AMP削減策**:",
				"  - Recording Rulesで高頻度メトリクスをダウンサンプリング（15秒 → 5分集計）",
				"  - `label_drop` / `metric_relabel_configs` で不要ラベル削除",
				"  - 不要なScrape Targetを除外（`drop` action）",
				"  - ストレージ保持期間をデフォルト150日 → 実情に合わせて短縮",
				"**AMG削減策**:",
				"  - Viewerは共有ダッシュボード（Public/Embed）で対応 → ユーザーコスト削減",
				"  - 不使用ワークスペースの削除（$0でも残しておくと将来課金の原因に）",
				"**AMP vs CloudWatch Metrics**: 既存Prometheusスタックがある場合はAMP。なければCWメトリクスが設定シンプル"
			]
		},
		{
			"title": "S3 + Athena ログコールドストレージ",
			"layout": "default",
			"content": [
				"**アーキテクチャ**: CW Logs → Subscription Filter → Kinesis Firehose → S3（Parquet変換）→ Athena",
				"**コスト比較（1TB/月のログ）**:",
				"  - CloudWatch Logs保存: $30/TB/月",
				"  - S3 Standard: $23/TB/月",
				"  - S3 Glacier Instant: $4/TB/月",
				"  - S3 Glacier Deep Archive: $0.99/TB/月",
				"**Athena でのアドホック分析**: $5/TBスキャン（列形式Parquetで最大90%削減）",
				"**ライフサイクルルール**: 30日 → Standard-IA → 90日 → Glacier → 365日 → Deep Archive"
			]
		},
		{
			"title": "Observabilityコスト計算例",
			"layout": "default",
			"content": [
				"**中規模Webアプリ（EKS 20Node、Lambda 500万リクエスト/月）の概算**:",
				"| サービス | 用途 | 月額概算 |",
				"| CW Logs | アプリログ 50GB/月 | $25 |",
				"| CW Metrics | カスタム300個 | $87 |",
				"| X-Ray | 1%サンプリング | $15 |",
				"| Container Insights | 20Node | $10 |",
				"| Lambda Insights | 500万req | $5 |",
				"| AMP | 5GiB/日 ingested | $135 |",
				"| AMG | 3 editors | $27 |",
				"| **合計** | | **約$304/月** |"
			]
		},
		{
			"title": "コストアラーム設定",
			"layout": "default",
			"content": ["Observability費用の予算超過を事前に検知する設定"],
			"code": "# AWS Budgets でObservabilityコスト監視\naws budgets create-budget \\\n  --account-id $ACCOUNT_ID \\\n  --budget '{\n    \"BudgetName\": \"Observability-Monthly\",\n    \"BudgetLimit\": {\"Amount\": \"500\", \"Unit\": \"USD\"},\n    \"TimeUnit\": \"MONTHLY\",\n    \"BudgetType\": \"COST\",\n    \"CostFilters\": {\n      \"Service\": [\n        \"Amazon CloudWatch\",\n        \"AWS X-Ray\",\n        \"Amazon Managed Service for Prometheus\",\n        \"Amazon Managed Grafana\"\n      ]\n    }\n  }' \\\n  --notifications-with-subscribers '[{\n    \"Notification\": {\n      \"NotificationType\": \"ACTUAL\",\n      \"ComparisonOperator\": \"GREATER_THAN\",\n      \"Threshold\": 80,\n      \"ThresholdType\": \"PERCENTAGE\"\n    },\n    \"Subscribers\": [{\"SubscriptionType\": \"SNS\",\n      \"Address\": \"arn:aws:sns:...\"}]\n  }]'",
			"codeLanguage": "bash"
		},
		{
			"title": "ROI計算 — Observabilityの投資対効果",
			"layout": "default",
			"content": [
				"**コスト（例: $304/月 = $3,648/年）**",
				"**MTTR短縮効果**:",
				"  - 障害対応: 2時間 → 20分（-83%短縮）",
				"  - 月2回発生 × エンジニア2名 × $100/h = $280/月 × 12 = $3,360/年節約",
				"**予防効果**:",
				"  - 本番障害1件回避 = 売上損失$1,000〜$10,000相当",
				"  - 年間2件回避で$2,000〜$20,000相当",
				"**総ROI**: $(3,360 + 2,000〜20,000) / $3,648 = **1.5x〜6x**",
				"**結論**: Observabilityへの投資はほぼ確実にROIがプラス — コスト最適化しながら継続"
			]
		},
		{
			"title": "Ch.8 まとめ・ツール選択チートシート",
			"layout": "section",
			"content": [
				"ツール選択指針 / 落とし穴 Top5",
				"DevOps Pro / SysOps 頻出パターン"
			]
		},
		{
			"title": "ツール選択チートシート",
			"layout": "default",
			"content": ["![w:880 center](assets/tools-cheatsheet.svg)"]
		},
		{
			"title": "よくある落とし穴 Top5",
			"layout": "default",
			"content": [
				"**1. CloudWatch Logs保持期間「Never Expire」のまま放置**",
				"   → 必ず保持期間を設定（コスト爆発の主因）",
				"**2. 高解像度メトリクスを全部に適用**",
				"   → 標準解像度で十分なケースが多い（10倍コスト差に注意）",
				"**3. X-Rayでヘルスチェックをサンプリング100%**",
				"   → サンプリングルールでURLパスを除外設定",
				"**4. AMP Label Cardinality爆発**",
				"   → user_idをDimensionにしない（高カーディナリティ禁止）",
				"**5. アラーム設定後のRunbook未整備**",
				"   → アラーム = 誰かが起こされる → 必ず対応手順を明記"
			]
		},
		{
			"title": "参考資料・次のステップ",
			"layout": "default",
			"content": [
				"**公式ドキュメント**:",
				"  - [AWS Observability Best Practices](https://aws-observability.github.io/observability-best-practices/)",
				"  - [AWS One Observability Workshop](https://catalog.workshops.aws/observability/en-US)",
				"  - [Lambda Powertools](https://docs.powertools.aws.dev/lambda/typescript/)",
				"  - [OpenTelemetry AWS Distro](https://aws-otel.github.io/)",
				"**次のステップ**:",
				"  - AWS One Observability Workshopをハンズオン実践（無料）",
				"  - AWS DevOps Professional / SysOps Associate 試験でObservability問題を確認",
				"  - Production ReadinessをSREの観点でチェックリスト化"
			]
		}
	]
}
