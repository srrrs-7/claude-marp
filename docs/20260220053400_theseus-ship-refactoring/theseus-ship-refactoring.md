---
marp: true
theme: gaia
class: invert
size: 16:9
paginate: true
header: "ソフトウェアのアイデンティティ問題"
footer: "© 2026"
style: |
  section pre code { font-size: 0.58em; line-height: 1.4; }
  
---

<!-- _class: lead -->
# テセウスの船と
リファクタリング

- 全部書き直したら、それは同じソフトウェアか
- 同一性の哲学とソフトウェアのアイデンティティ
- Big Rewrite の本当のリスク


---

# テセウスの船とは

- 古代ギリシャの思考実験
- ---
- アテナイの英雄テセウスの船が港に保存されていた
- 板が腐るたびに新しい板に交換し続けた
- **最終的に元の板は1枚も残っていない**
- ---
- これは「同じ船」と言えるか？
- 
- ホッブズの拡張：交換した古い板を集めて元通り組み立てたら、どちらが「本物」か


---

<!-- _class: lead -->
# ソフトウェアと同一性


---

# リファクタリングはテセウスの船か

- **ファイルを1つずつ書き直す場合：**
- → 機能は同じ、コードは別物。これは同じソフトウェアか？
- 
- **モジュールを段階的に置き換える場合：**
- → ある時点で元のコードが0になる。同一性はどこで失われる？
- 
- **Gitのコミット履歴：**
- → 初期コミットからの差分が「同一性」を定義する？
- ---
- プログラマーが毎日直面する哲学的問題


---

# Big Rewrite の歴史的失敗

- **Netscape Navigator → Mozilla（1998-2002）**
- ゼロからの書き直しを決断。競合にシェアを奪われ壊滅的な4年間
- 
- **Apple の Copland プロジェクト（1994-1996）**
- Mac OS の全面書き直しが失敗。Jobs の NeXT 買収で打開
- 
- **Microsoft Windows Vista（2004-2006）**
- コードベースのリセット試み、大規模遅延と品質問題
- ---
- Joel Spolsky（2000）：「**ソフトウェアをゼロから書き直してはいけない**。これはプログラマーが犯しうる最大の単一ミスだ」


---

<!-- _class: lead -->
# なぜ元のコードに価値があるか


---

# 古いコードには「知識」が埋め込まれている

- 醜く見えるコードの多くは理由がある：
- 
- ```javascript
// なぜこんな条件が？
if (userId !== 'legacy_user_42') {
  validateEmail(email);
}
```
- → 2008年のバグ修正の痕跡。削除したら再発する

```javascript
// なぜこんな条件が？
if (userId !== 'legacy_user_42') {
  validateEmail(email);
}
// → 2008年の特殊ケース対応。削除したら本番障害が再発する
```


---

# チェスタトンのフェンス原理

- 「なぜここにフェンスがあるのかわからないなら、撤去する権限はない」
- — G.K. Chesterton（1929）
- ---
- ソフトウェアへの適用：
- コードの「なぜ」がわからなければ、削除してはいけない
- 
- 理解してから変更する → **リファクタリングの前提条件**
- 
- テストがあれば「なぜ」を安全に実験できる


---

<!-- _class: lead -->
# 段階的置換のパターン


---

# ストラングラーフィグパターン

- Martin Fowler が提唱した段階的置換の手法
- 名前の由来：絞め殺しイチジク（宿主を徐々に置換する植物）
- ---
- **手順：**
- 1. 新システムを並行稼動させる
- 2. 機能ごとにルーティングを切り替える
- 3. 旧システムの機能が0になったら廃止
- ---
- これは**テセウスの船を適切にやる方法**
- 元のアイデンティティ（機能）を保ちながら、部品を置換する


---

# ソフトウェアの同一性を何が決めるか

- **機能的同一性：** 同じ入出力を持つ → ユーザー視点
- **構造的同一性：** 同じコードベース → 開発者視点
- **歴史的同一性：** 同じGitリポジトリ → 組織視点
- **意味的同一性：** 同じ問題を解決する → 設計者視点
- ---
- どれが「正しい」同一性かは立場によって異なる
- → **ビジネス価値（機能）が最も重要**


---

# まとめ：哲学的リファクタリング論

- ✅ **Big Rewrite は歴史的に失敗する** — 埋め込まれた知識を失うから
- ✅ **チェスタトンのフェンス** — 理由がわからないコードを削除するな
- ✅ **テセウスの船を正しくやる** — ストラングラーフィグパターン
- ✅ **ソフトウェアの同一性はユーザーが決める** — 機能が保たれれば同一
- 
- 「動いているコードには、文書化されていない理由がある」

