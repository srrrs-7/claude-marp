---
marp: true
theme: gaia
class: invert
size: 16:9
paginate: true
header: "AWS ANS — VPN完全ガイド"
footer: "© 2026 AWS Networking Reference"
style: |
  section {
    font-size: 1.0em;
  }
  section pre code {
    font-size: 0.58em;
    line-height: 1.4;
  }
  section.lead h1 {
    font-size: 1.8em;
  }
  section.lead p {
    font-size: 1.0em;
  }
  
---

<!-- _class: lead -->
# AWS ANS — VPN完全ガイド

- インフラ / ネットワークエンジニア向け
- Site-to-Site VPN · Client VPN · TGW VPN · CloudHub · Direct Connect
- 構成・ユースケース・設計パターン 網羅版

<!--
AWS Advanced Networking Specialty 対応。AWS VPN 全サービスの構成・ユースケース・設計パターンを網羅したリファレンスデッキ。
-->

---

# このスライドで学べること

- AWS VPN 5サービスの全体像を体系的に把握する
- 各サービスのアーキテクチャ・設定パラメータ・制限値を理解する
- ユースケース別の最適なVPN設計パターンを選択できる
- 高可用性・冗長化設計のベストプラクティスを習得する
- セキュリティ設定（暗号化アルゴリズム・PFS）とコンプライアンス対応
- CloudWatch / Reachability Analyzer を活用したトラブルシューティング

<!--
前提知識: ネットワーク基礎（TCP/IP, ルーティング）, AWS基礎（VPC, サブネット, ルートテーブル）
-->

---

# AWS VPNサービス全体マップ

- <svg viewBox="0 0 760 380" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="40" width="220" height="145" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><rect x="10" y="40" width="220" height="33" rx="8" fill="#3b82f6"/><rect x="10" y="59" width="220" height="14" fill="#3b82f6"/><text x="120" y="63" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Site-to-Site VPN</text><text x="120" y="97" text-anchor="middle" font-size="11" fill="#1e40af">オンプレ ↔ AWS 接続</text><text x="120" y="115" text-anchor="middle" font-size="11" fill="#374151">IPsec IKEv1 / IKEv2</text><text x="120" y="133" text-anchor="middle" font-size="11" fill="#374151">VGW / TGW に接続</text><text x="120" y="151" text-anchor="middle" font-size="11" fill="#3b82f6">最大 1.25Gbps / トンネル</text><text x="120" y="169" text-anchor="middle" font-size="10" fill="#374151">10 接続/VGW（デフォルト）</text><rect x="270" y="40" width="220" height="145" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><rect x="270" y="40" width="220" height="33" rx="8" fill="#22c55e"/><rect x="270" y="59" width="220" height="14" fill="#22c55e"/><text x="380" y="63" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Client VPN</text><text x="380" y="97" text-anchor="middle" font-size="11" fill="#15803d">リモートアクセス VPN</text><text x="380" y="115" text-anchor="middle" font-size="11" fill="#374151">OpenVPN 互換</text><text x="380" y="133" text-anchor="middle" font-size="11" fill="#374151">証明書 / AD / SAML 認証</text><text x="380" y="151" text-anchor="middle" font-size="11" fill="#22c55e">最大 2,000 同時接続</text><text x="380" y="169" text-anchor="middle" font-size="10" fill="#374151">5 エンドポイント/リージョン</text><rect x="530" y="40" width="220" height="145" rx="8" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><rect x="530" y="40" width="220" height="33" rx="8" fill="#eab308"/><rect x="530" y="59" width="220" height="14" fill="#eab308"/><text x="640" y="63" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Transit Gateway + VPN</text><text x="640" y="97" text-anchor="middle" font-size="11" fill="#854d0e">集中型 VPN 管理</text><text x="640" y="115" text-anchor="middle" font-size="11" fill="#374151">ECMP 対応</text><text x="640" y="133" text-anchor="middle" font-size="11" fill="#374151">マルチアカウント対応</text><text x="640" y="151" text-anchor="middle" font-size="11" fill="#eab308">ECMP で最大 50Gbps+</text><text x="640" y="169" text-anchor="middle" font-size="10" fill="#374151">50 接続/TGW（デフォルト）</text><rect x="140" y="225" width="220" height="140" rx="8" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/><rect x="140" y="225" width="220" height="33" rx="8" fill="#a855f7"/><rect x="140" y="244" width="220" height="14" fill="#a855f7"/><text x="250" y="248" text-anchor="middle" font-size="13" font-weight="bold" fill="white">VPN CloudHub</text><text x="250" y="281" text-anchor="middle" font-size="11" fill="#7e22ce">マルチサイト Hub</text><text x="250" y="299" text-anchor="middle" font-size="11" fill="#374151">Hub-and-Spoke 接続</text><text x="250" y="317" text-anchor="middle" font-size="11" fill="#374151">拠点間通信も可能</text><text x="250" y="351" text-anchor="middle" font-size="10" fill="#a855f7">VGW で実現</text><rect x="400" y="225" width="220" height="140" rx="8" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/><rect x="400" y="225" width="220" height="33" rx="8" fill="#ef4444"/><rect x="400" y="244" width="220" height="14" fill="#ef4444"/><text x="510" y="248" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Direct Connect + VPN</text><text x="510" y="281" text-anchor="middle" font-size="11" fill="#b91c1c">DX 上で IPsec 暗号化</text><text x="510" y="299" text-anchor="middle" font-size="11" fill="#374151">低レイテンシ + 暗号化</text><text x="510" y="317" text-anchor="middle" font-size="11" fill="#374151">DX バックアップに VPN</text><text x="510" y="351" text-anchor="middle" font-size="10" fill="#ef4444">金融・規制業界向け</text></svg>

<!--
5種類のAWS VPNサービスの概要。ユースケースに応じて最適なサービスを選択する。
-->

---

# VPNとは — 概念と仕組み

- <svg viewBox="0 0 760 320" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="20" y="55" width="145" height="95" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><text x="92" y="88" text-anchor="middle" font-size="13" font-weight="bold" fill="#374151">オンプレミス</text><text x="92" y="108" text-anchor="middle" font-size="11" fill="#6b7280">Customer Router</text><text x="92" y="128" text-anchor="middle" font-size="11" fill="#6b7280">(CGW)</text><ellipse cx="380" cy="102" rx="115" ry="58" fill="#e0f2fe" stroke="#7dd3fc" stroke-width="2"/><text x="380" y="97" text-anchor="middle" font-size="12" font-weight="bold" fill="#0369a1">インターネット</text><text x="380" y="115" text-anchor="middle" font-size="10" fill="#0c4a6e">Public Network</text><rect x="595" y="55" width="145" height="95" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><text x="667" y="88" text-anchor="middle" font-size="13" font-weight="bold" fill="#1e40af">AWS VPC</text><text x="667" y="108" text-anchor="middle" font-size="11" fill="#374151">VGW / TGW</text><text x="667" y="128" text-anchor="middle" font-size="11" fill="#374151">Endpoint</text><rect x="163" y="83" width="434" height="38" rx="5" fill="none" stroke="#ef4444" stroke-width="2" stroke-dasharray="6,3"/><text x="380" y="76" text-anchor="middle" font-size="10" font-weight="bold" fill="#ef4444">IPsec VPN Tunnel（暗号化）</text><line x1="165" y1="102" x2="263" y2="102" stroke="#374151" stroke-width="2"/><polygon points="265,102 257,98 257,106" fill="#374151"/><line x1="595" y1="102" x2="497" y2="102" stroke="#374151" stroke-width="2"/><polygon points="495,102 503,98 503,106" fill="#374151"/><text x="380" y="198" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">IPsec トンネルモード: カプセル化構造</text><rect x="15" y="208" width="78" height="30" fill="#fde68a" stroke="#d97706"/><text x="54" y="227" text-anchor="middle" font-size="9" fill="#374151">New IP Hdr</text><rect x="93" y="208" width="52" height="30" fill="#fca5a5" stroke="#dc2626"/><text x="119" y="227" text-anchor="middle" font-size="9" fill="#374151">ESP Hdr</text><rect x="145" y="208" width="78" height="30" fill="#a7f3d0" stroke="#059669"/><text x="184" y="227" text-anchor="middle" font-size="9" fill="#374151">Orig IP Hdr</text><rect x="223" y="208" width="55" height="30" fill="#bfdbfe" stroke="#3b82f6"/><text x="250" y="227" text-anchor="middle" font-size="9" fill="#374151">TCP/UDP</text><rect x="278" y="208" width="220" height="30" fill="#e9d5ff" stroke="#9333ea"/><text x="388" y="227" text-anchor="middle" font-size="10" fill="#374151">Payload（AES-256-GCM 暗号化）</text><rect x="498" y="208" width="68" height="30" fill="#fca5a5" stroke="#dc2626"/><text x="532" y="227" text-anchor="middle" font-size="9" fill="#374151">ESP Trailer</text><rect x="566" y="208" width="55" height="30" fill="#fde68a" stroke="#d97706"/><text x="593" y="227" text-anchor="middle" font-size="9" fill="#374151">ICV</text><line x1="93" y1="238" x2="566" y2="238" stroke="#9333ea" stroke-width="1" stroke-dasharray="2,2"/><text x="329" y="253" text-anchor="middle" font-size="9" fill="#9333ea">← ESP 暗号化・完全性保護範囲 →</text><text x="380" y="278" text-anchor="middle" font-size="10" fill="#374151">VPN: 公共ネットワーク上に仮想プライベートトンネルを構築し、通信を暗号化・認証する技術</text></svg>

<!--
VPNの基本概念。IPsecトンネルモードではオリジナルパケット全体が暗号化され、新しいIPヘッダーでカプセル化される。
-->

---

# IPsec プロトコルスタック

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><text x="190" y="25" text-anchor="middle" font-size="13" font-weight="bold" fill="#374151">IPsec トンネルモード 層構造</text><rect x="30" y="38" width="320" height="38" rx="4" fill="#e0f2fe" stroke="#7dd3fc" stroke-width="2"/><text x="190" y="62" text-anchor="middle" font-size="11" fill="#0369a1">アプリケーションデータ</text><rect x="30" y="84" width="320" height="38" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><text x="190" y="108" text-anchor="middle" font-size="11" fill="#15803d">TCP / UDP</text><rect x="30" y="130" width="320" height="38" rx="4" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><text x="190" y="154" text-anchor="middle" font-size="11" fill="#854d0e">Original IP Header（送信元・宛先）</text><rect x="30" y="176" width="320" height="44" rx="4" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/><text x="190" y="196" text-anchor="middle" font-size="12" font-weight="bold" fill="#ef4444">ESP（暗号化＋認証）/ AH（認証のみ）</text><text x="190" y="213" text-anchor="middle" font-size="9" fill="#dc2626">Protocol 50 / Protocol 51</text><rect x="30" y="228" width="320" height="38" rx="4" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/><text x="190" y="252" text-anchor="middle" font-size="11" fill="#7e22ce">新しい外部 IP Header（ゲートウェイのIP）</text><rect x="30" y="274" width="320" height="38" rx="4" fill="#374151"/><text x="190" y="298" text-anchor="middle" font-size="11" fill="white">IKE — 鍵交換・SA確立（UDP 500/4500）</text><text x="400" y="25" text-anchor="middle" font-size="13" font-weight="bold" fill="#374151">Security Association（SA）の種類</text><rect x="370" y="38" width="365" height="75" rx="6" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/><text x="552" y="62" text-anchor="middle" font-size="12" font-weight="bold" fill="#ef4444">IKE SA</text><text x="552" y="82" text-anchor="middle" font-size="11" fill="#374151">IKE メッセージ自体の暗号化・認証</text><text x="552" y="100" text-anchor="middle" font-size="10" fill="#374151">Phase 1（IKEv1）/ IKE_SA_INIT（IKEv2）</text><rect x="370" y="125" width="365" height="75" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><text x="552" y="149" text-anchor="middle" font-size="12" font-weight="bold" fill="#15803d">IPsec SA（CHILD SA）</text><text x="552" y="169" text-anchor="middle" font-size="11" fill="#374151">実際のトラフィックの暗号化・認証</text><text x="552" y="187" text-anchor="middle" font-size="10" fill="#374151">Phase 2（IKEv1）/ CREATE_CHILD_SA（IKEv2）</text><rect x="370" y="212" width="365" height="120" rx="6" fill="#374151"/><text x="552" y="237" text-anchor="middle" font-size="12" font-weight="bold" fill="white">AWS デフォルト推奨設定</text><text x="552" y="260" text-anchor="middle" font-size="11" fill="#d1fae5">暗号化: AES-256-GCM-16</text><text x="552" y="280" text-anchor="middle" font-size="11" fill="#d1fae5">整合性: SHA-256（GCM 使用時は不要）</text><text x="552" y="300" text-anchor="middle" font-size="11" fill="#fde68a">DH グループ: 14（2048-bit）以上</text><text x="552" y="320" text-anchor="middle" font-size="11" fill="#fde68a">IKE バージョン: IKEv2（推奨）</text></svg>

<!--
IPsecのプロトコル層構造。ESPが暗号化を担い、IKEが鍵交換を行う。AWSではESP + IKEv2の組み合わせを推奨。
-->

---

# IKEv1 vs IKEv2 — 比較

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="15" y="15" width="350" height="330" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/><rect x="15" y="15" width="350" height="40" rx="8" fill="#22c55e"/><rect x="15" y="41" width="350" height="14" fill="#22c55e"/><text x="190" y="41" text-anchor="middle" font-size="14" font-weight="bold" fill="white">IKEv1</text><rect x="395" y="15" width="350" height="330" rx="8" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/><rect x="395" y="15" width="350" height="40" rx="8" fill="#3b82f6"/><rect x="395" y="41" width="350" height="14" fill="#3b82f6"/><text x="570" y="41" text-anchor="middle" font-size="14" font-weight="bold" fill="white">IKEv2（AWS 推奨）</text><text x="20" y="78" font-size="11" fill="#374151">  Phase 1（ISAKMP SA）: 6 または 3 メッセージ</text><text x="20" y="98" font-size="11" fill="#374151">  Phase 2（Quick Mode）: 3 メッセージ</text><text x="20" y="118" font-size="11" fill="#dc2626">  EAP 認証: ✗ 非対応</text><text x="20" y="138" font-size="11" fill="#dc2626">  MOBIKE: ✗ IP 変更後に切断</text><text x="20" y="158" font-size="11" fill="#6b7280">  DPD: 非標準拡張（実装依存）</text><text x="20" y="178" font-size="11" fill="#374151">  トラフィックセレクタ: 1 組のみ</text><text x="20" y="198" font-size="11" fill="#dc2626">  再認証: フルハンドシェイク必要</text><text x="20" y="218" font-size="11" fill="#374151">  合計メッセージ数: 9</text><text x="20" y="238" font-size="11" fill="#374151">  NAT-T: 拡張機能（RFC 3947）</text><text x="20" y="268" font-size="10" font-weight="bold" fill="#374151">  AWSサポート: 対応（非推奨）</text><text x="20" y="286" font-size="10" fill="#6b7280">  RFC 2409</text><text x="20" y="304" font-size="10" fill="#6b7280">  古い機器との互換性目的のみ推奨</text><text x="400" y="78" font-size="11" fill="#374151">  IKE_SA_INIT + IKE_AUTH: 4 メッセージ</text><text x="400" y="98" font-size="11" fill="#374151">  CREATE_CHILD_SA: 統合フロー</text><text x="400" y="118" font-size="11" fill="#15803d">  EAP 認証: ✓ 標準サポート</text><text x="400" y="138" font-size="11" fill="#15803d">  MOBIKE: ✓ IP 変更時も接続維持</text><text x="400" y="158" font-size="11" fill="#15803d">  DPD: 標準組み込み（INFORMATIONAL）</text><text x="400" y="178" font-size="11" fill="#15803d">  トラフィックセレクタ: 複数同時対応</text><text x="400" y="198" font-size="11" fill="#15803d">  再認証: 差分のみ再ネゴシエーション</text><text x="400" y="218" font-size="11" fill="#374151">  合計メッセージ数: 4（50%削減）</text><text x="400" y="238" font-size="11" fill="#15803d">  NAT-T: 標準統合（UDP 4500）</text><text x="400" y="268" font-size="10" font-weight="bold" fill="#374151">  AWSサポート: ✓ 推奨</text><text x="400" y="286" font-size="10" fill="#6b7280">  RFC 7296</text><text x="400" y="304" font-size="10" fill="#15803d">  新規構築はすべて IKEv2 を選択すること</text></svg>

<!--
IKEv2はIKEv1より高速・シンプル・機能豊富。AWSは新規VPN接続ではIKEv2を強く推奨。
-->

---

# BGP 基礎知識

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="15" y="35" width="210" height="160" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><rect x="15" y="35" width="210" height="35" rx="8" fill="#6b7280"/><rect x="15" y="56" width="210" height="14" fill="#6b7280"/><text x="120" y="60" text-anchor="middle" font-size="12" font-weight="bold" fill="white">自社ネットワーク</text><text x="120" y="95" text-anchor="middle" font-size="12" fill="#374151">AS 番号: 65000</text><text x="120" y="115" text-anchor="middle" font-size="11" fill="#374151">（Private ASN）</text><text x="120" y="137" text-anchor="middle" font-size="11" fill="#374151">BGP ルーター</text><text x="120" y="157" text-anchor="middle" font-size="10" fill="#6b7280">192.168.0.0/16 広報</text><text x="120" y="175" text-anchor="middle" font-size="10" fill="#6b7280">ルーティングテーブル管理</text><rect x="535" y="35" width="210" height="160" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><rect x="535" y="35" width="210" height="35" rx="8" fill="#3b82f6"/><rect x="535" y="56" width="210" height="14" fill="#3b82f6"/><text x="640" y="60" text-anchor="middle" font-size="12" font-weight="bold" fill="white">AWS VGW / TGW</text><text x="640" y="95" text-anchor="middle" font-size="12" fill="#1e40af">AS 番号: 7224</text><text x="640" y="115" text-anchor="middle" font-size="11" fill="#374151">（AWS Default ASN）</text><text x="640" y="137" text-anchor="middle" font-size="11" fill="#374151">BGP ピア</text><text x="640" y="157" text-anchor="middle" font-size="10" fill="#374151">10.0.0.0/16 広報</text><text x="640" y="175" text-anchor="middle" font-size="10" fill="#374151">ルート自動受け取り</text><line x1="225" y1="115" x2="380" y2="115" stroke="#374151" stroke-width="2"/><polygon points="382,115 374,111 374,119" fill="#374151"/><line x1="535" y1="115" x2="380" y2="115" stroke="#374151" stroke-width="2"/><polygon points="378,115 386,111 386,119" fill="#374151"/><text x="380" y="107" text-anchor="middle" font-size="10" fill="#374151">eBGP セッション（TCP 179）</text><rect x="240" y="225" width="280" height="120" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/><text x="380" y="248" text-anchor="middle" font-size="12" font-weight="bold" fill="#15803d">BGP パス選択 属性（優先順）</text><text x="245" y="270" font-size="11" fill="#374151">  1. WEIGHT（Cisco 独自、ローカル）</text><text x="245" y="290" font-size="11" fill="#374151">  2. LOCAL_PREF（iBGP 内優先度）</text><text x="245" y="310" font-size="11" fill="#374151">  3. AS_PATH 長（短いほど優先）</text><text x="245" y="330" font-size="11" fill="#374151">  4. MED（外部メトリック）</text></svg>

<!--
BGPはAS間でルーティング情報を交換するプロトコル。AWS VPNでは動的ルーティングにBGPを使用。AS_PATH prepend でルート制御が可能。
-->

---

# AWS VPN 共通コンポーネント

- <svg viewBox="0 0 760 340" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="75" width="145" height="105" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><rect x="10" y="75" width="145" height="33" rx="8" fill="#6b7280"/><rect x="10" y="94" width="145" height="14" fill="#6b7280"/><text x="82" y="98" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Customer Gateway</text><text x="82" y="128" text-anchor="middle" font-size="10" fill="#374151">オンプレ側ルーター</text><text x="82" y="146" text-anchor="middle" font-size="10" fill="#374151">の論理表現</text><text x="82" y="164" text-anchor="middle" font-size="9" fill="#6b7280">IP / BGP ASN / 証明書</text><rect x="293" y="75" width="174" height="105" rx="8" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><rect x="293" y="75" width="174" height="33" rx="8" fill="#eab308"/><rect x="293" y="94" width="174" height="14" fill="#eab308"/><text x="380" y="98" text-anchor="middle" font-size="11" font-weight="bold" fill="white">VPN Connection</text><text x="380" y="128" text-anchor="middle" font-size="10" fill="#374151">CGW ↔ VGW/TGW</text><text x="380" y="146" text-anchor="middle" font-size="10" fill="#374151">2 本の IPsec トンネル</text><text x="380" y="164" text-anchor="middle" font-size="9" fill="#854d0e">静的 / BGP ルーティング</text><rect x="555" y="25" width="190" height="100" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><rect x="555" y="25" width="190" height="33" rx="8" fill="#3b82f6"/><rect x="555" y="44" width="190" height="14" fill="#3b82f6"/><text x="650" y="48" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Virtual Private Gateway</text><text x="650" y="78" text-anchor="middle" font-size="10" fill="#1e40af">VPC 単体に接続</text><text x="650" y="96" text-anchor="middle" font-size="10" fill="#374151">10 VPN 接続/VGW</text><text x="650" y="114" text-anchor="middle" font-size="9" fill="#6b7280">1 VPC のみアタッチ可</text><rect x="555" y="145" width="190" height="100" rx="8" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><rect x="555" y="145" width="190" height="33" rx="8" fill="#eab308"/><rect x="555" y="164" width="190" height="14" fill="#eab308"/><text x="650" y="168" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Transit Gateway</text><text x="650" y="198" text-anchor="middle" font-size="10" fill="#854d0e">複数 VPC + 複数 VPN</text><text x="650" y="216" text-anchor="middle" font-size="10" fill="#374151">50 VPN 接続/TGW</text><text x="650" y="234" text-anchor="middle" font-size="9" fill="#6b7280">マルチアカウント対応</text><line x1="155" y1="127" x2="291" y2="127" stroke="#374151" stroke-width="2"/><polygon points="293,127 285,123 285,131" fill="#374151"/><line x1="467" y1="107" x2="553" y2="75" stroke="#374151" stroke-width="1.5"/><polygon points="555,73 547,77 551,85" fill="#374151"/><line x1="467" y1="147" x2="553" y2="195" stroke="#374151" stroke-width="1.5"/><polygon points="555,197 547,191 551,199" fill="#374151"/><text x="205" y="118" text-anchor="middle" font-size="9" fill="#6b7280">接続設定</text><text x="520" y="85" text-anchor="middle" font-size="9" fill="#374151">VGW選択</text><text x="520" y="173" text-anchor="middle" font-size="9" fill="#374151">TGW選択</text><rect x="10" y="255" width="730" height="60" rx="6" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/><text x="380" y="276" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">VPN Connection: 主要設定項目</text><text x="100" y="298" text-anchor="middle" font-size="10" fill="#374151">外部 IP（Tunnel 1/2）</text><text x="290" y="298" text-anchor="middle" font-size="10" fill="#374151">Inside CIDR（/30）</text><text x="470" y="298" text-anchor="middle" font-size="10" fill="#374151">PSK / 証明書</text><text x="640" y="298" text-anchor="middle" font-size="10" fill="#374151">BGP ASN / Static Routes</text></svg>

<!--
AWS VPN接続の4つの主要コンポーネント: CGW（オンプレ側論理表現）、VPN Connection（接続リソース）、VGW/TGW（AWS側エンドポイント）。
-->

---

<!-- _class: lead -->
# Section 2: AWS Site-to-Site VPN

- オンプレミス / データセンター と VPC の IPsec VPN 接続
- Virtual Private Gateway（VGW）または Transit Gateway（TGW）に接続
- 2 本の IPsec トンネルで冗長性を確保

<!--
最も基本的なAWS VPNサービス。オンプレミスとAWS VPCをサイト間IPsec VPNで接続する。
-->

---

# Site-to-Site VPN アーキテクチャ

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="80" width="155" height="120" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><rect x="10" y="80" width="155" height="33" rx="8" fill="#6b7280"/><rect x="10" y="99" width="155" height="14" fill="#6b7280"/><text x="87" y="103" text-anchor="middle" font-size="11" font-weight="bold" fill="white">オンプレミス DC</text><text x="87" y="135" text-anchor="middle" font-size="10" fill="#374151">Customer Router</text><text x="87" y="153" text-anchor="middle" font-size="10" fill="#374151">パブリック IP:</text><text x="87" y="171" text-anchor="middle" font-size="10" fill="#374151">203.0.113.1</text><text x="87" y="189" text-anchor="middle" font-size="9" fill="#6b7280">Customer Gateway</text><ellipse cx="350" cy="140" rx="95" ry="48" fill="#e0f2fe" stroke="#7dd3fc" stroke-width="2"/><text x="350" y="135" text-anchor="middle" font-size="11" font-weight="bold" fill="#0369a1">インターネット</text><text x="350" y="153" text-anchor="middle" font-size="9" fill="#0c4a6e">Public Network</text><rect x="480" y="50" width="270" height="260" rx="8" fill="#f0f9ff" stroke="#3b82f6" stroke-width="2" stroke-dasharray="6,3"/><text x="615" y="72" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">AWS Region</text><rect x="500" y="85" width="110" height="80" rx="6" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><text x="555" y="115" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">Virtual Private</text><text x="555" y="133" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">Gateway（VGW）</text><text x="555" y="153" text-anchor="middle" font-size="9" fill="#374151">Tunnel EP 1/2</text><rect x="620" y="85" width="110" height="200" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="675" y="108" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">VPC</text><text x="675" y="125" text-anchor="middle" font-size="9" fill="#374151">10.0.0.0/16</text><rect x="630" y="140" width="90" height="35" rx="4" fill="#bfdbfe" stroke="#3b82f6"/><text x="675" y="161" text-anchor="middle" font-size="9" fill="#374151">Route Table</text><rect x="630" y="190" width="90" height="35" rx="4" fill="#a7f3d0" stroke="#059669"/><text x="675" y="211" text-anchor="middle" font-size="9" fill="#374151">Private Subnet</text><rect x="630" y="240" width="90" height="35" rx="4" fill="#a7f3d0" stroke="#059669"/><text x="675" y="261" text-anchor="middle" font-size="9" fill="#374151">Private Subnet</text><line x1="610" y1="125" x2="620" y2="125" stroke="#3b82f6" stroke-width="1.5"/><polygon points="622,125 614,121 614,129" fill="#3b82f6"/><line x1="165" y1="125" x2="252" y2="125" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,3"/><polygon points="254,125 246,121 246,129" fill="#ef4444"/><line x1="165" y1="155" x2="252" y2="155" stroke="#7c3aed" stroke-width="2" stroke-dasharray="5,3"/><polygon points="254,155 246,151 246,159" fill="#7c3aed"/><line x1="445" y1="125" x2="498" y2="125" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,3"/><polygon points="500,125 492,121 492,129" fill="#ef4444"/><line x1="445" y1="155" x2="498" y2="155" stroke="#7c3aed" stroke-width="2" stroke-dasharray="5,3"/><polygon points="500,155 492,151 492,159" fill="#7c3aed"/><text x="308" y="115" text-anchor="middle" font-size="9" fill="#ef4444">Tunnel 1</text><text x="308" y="148" text-anchor="middle" font-size="9" fill="#7c3aed">Tunnel 2</text><rect x="10" y="280" width="460" height="50" rx="6" fill="#f8fafc" stroke="#e2e8f0"/><text x="240" y="300" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">冗長性ポイント</text><text x="240" y="318" text-anchor="middle" font-size="10" fill="#374151">2 本のトンネルは異なる AWS VPN エンドポイントに終端 → 一方障害時も継続</text></svg>

<!--
Site-to-Site VPNの基本構成。CGW（オンプレ）とVGW（AWS）間に2本のIPsecトンネルを確立。片方のトンネル障害時は自動で切り替わる。
-->

---

# Virtual Private Gateway（VGW）詳細

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="275" y="120" width="210" height="120" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="3"/><rect x="275" y="120" width="210" height="35" rx="8" fill="#1d4ed8"/><rect x="275" y="141" width="210" height="14" fill="#1d4ed8"/><text x="380" y="145" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Virtual Private Gateway</text><text x="380" y="178" text-anchor="middle" font-size="11" fill="#1e40af">リージョンリソース</text><text x="380" y="196" text-anchor="middle" font-size="11" fill="#374151">Tunnel EP-1 / EP-2</text><text x="380" y="214" text-anchor="middle" font-size="10" fill="#374151">BGP ASN: 7224（デフォルト）</text><text x="380" y="232" text-anchor="middle" font-size="10" fill="#374151">カスタム ASN 設定可</text><rect x="10" y="50" width="155" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="87" y="78" text-anchor="middle" font-size="10" fill="#374151">CGW 1（東京オフィス）</text><text x="87" y="96" text-anchor="middle" font-size="9" fill="#6b7280">203.0.113.1</text><rect x="10" y="130" width="155" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="87" y="158" text-anchor="middle" font-size="10" fill="#374151">CGW 2（大阪オフィス）</text><text x="87" y="176" text-anchor="middle" font-size="9" fill="#6b7280">198.51.100.1</text><rect x="10" y="210" width="155" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="87" y="238" text-anchor="middle" font-size="10" fill="#374151">CGW 3（名古屋 DC）</text><text x="87" y="256" text-anchor="middle" font-size="9" fill="#6b7280">192.0.2.1</text><line x1="165" y1="80" x2="273" y2="155" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><line x1="165" y1="160" x2="273" y2="170" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><line x1="165" y1="240" x2="273" y2="195" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><polygon points="275,155 267,151 269,159" fill="#6b7280"/><polygon points="275,170 267,166 269,174" fill="#6b7280"/><polygon points="275,195 267,191 269,199" fill="#6b7280"/><rect x="596" y="110" width="155" height="140" rx="8" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/><text x="673" y="133" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">VPC</text><text x="673" y="153" text-anchor="middle" font-size="9" fill="#374151">10.0.0.0/16</text><rect x="606" y="165" width="135" height="30" rx="4" fill="#bfdbfe" stroke="#3b82f6"/><text x="673" y="183" text-anchor="middle" font-size="9" fill="#374151">Route Table</text><rect x="606" y="205" width="135" height="30" rx="4" fill="#a7f3d0" stroke="#059669"/><text x="673" y="223" text-anchor="middle" font-size="9" fill="#374151">Private Subnets</text><line x1="485" y1="180" x2="594" y2="180" stroke="#3b82f6" stroke-width="2"/><polygon points="596,180 588,176 588,184" fill="#3b82f6"/><rect x="270" y="270" width="220" height="60" rx="6" fill="#fef9c3" stroke="#eab308" stroke-width="1.5"/><text x="380" y="292" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">ルート伝播</text><text x="380" y="312" text-anchor="middle" font-size="10" fill="#374151">有効化: VPN ルートが自動で</text><text x="380" y="326" text-anchor="middle" font-size="10" fill="#374151">Route Table に追加される</text><line x1="380" y1="240" x2="380" y2="268" stroke="#eab308" stroke-width="2"/><polygon points="380,270 376,262 384,262" fill="#eab308"/></svg>

<!--
VGWは最大10のVPN接続をサポート。1つのVPCにのみアタッチ可能。ルート伝播を有効化するとVPNルートが自動でRoute Tableに追加される。
-->

---

# Customer Gateway 設定パラメータ

- **IP アドレス**: オンプレルーターのパブリック IP（NATアドレスも可）
- **BGP ASN**: 動的ルーティング使用時に指定（1–4294967295 / Private: 64512–65535）
- **デバイスタイプ**: ダウンロード設定ファイルのテンプレート選択に使用
- **証明書 ARN**: 証明書ベース認証を使用する場合に ACM ARN を指定
- **作成後は変更不可** — IP / ASN 変更が必要な場合は再作成が必要
- **コスト**: CGW リソース自体は無料（VPN Connection に課金）

```bash
# CGW 作成例（AWS CLI）
aws ec2 create-customer-gateway \
  --type ipsec.1 \
  --public-ip 203.0.113.1 \
  --bgp-asn 65000

# TGW 接続の VPN Connection 作成
aws ec2 create-vpn-connection \
  --customer-gateway-id cgw-xxxxxxxxx \
  --transit-gateway-id tgw-xxxxxxxxx \
  --type ipsec.1 \
  --options TunnelOptions=[{...},{...}]
```

<!--
CGWはオンプレミス側のルーターをAWSリソースとして論理的に表現したもの。設定後は変更不可のため注意。
-->

---

# 2トンネル構成とフェイルオーバー

- <svg viewBox="0 0 760 340" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="20" y="100" width="160" height="110" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><rect x="20" y="100" width="160" height="33" rx="8" fill="#6b7280"/><rect x="20" y="119" width="160" height="14" fill="#6b7280"/><text x="100" y="123" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Customer Router</text><text x="100" y="155" text-anchor="middle" font-size="10" fill="#374151">IP: 203.0.113.1</text><text x="100" y="173" text-anchor="middle" font-size="10" fill="#374151">AS 65000</text><text x="100" y="195" text-anchor="middle" font-size="9" fill="#6b7280">Customer Gateway</text><rect x="540" y="60" width="190" height="200" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><rect x="540" y="60" width="190" height="33" rx="8" fill="#1d4ed8"/><rect x="540" y="79" width="190" height="14" fill="#1d4ed8"/><text x="635" y="83" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Virtual Private Gateway</text><rect x="550" y="105" width="170" height="65" rx="6" fill="#ef4444" stroke="#dc2626"/><text x="635" y="128" text-anchor="middle" font-size="10" font-weight="bold" fill="white">Tunnel 1（アクティブ）</text><text x="635" y="148" text-anchor="middle" font-size="9" fill="#fef2f2">EP: 169.254.10.1</text><text x="635" y="162" text-anchor="middle" font-size="9" fill="#fef2f2">Inside: 169.254.10.0/30</text><rect x="550" y="185" width="170" height="65" rx="6" fill="#6b7280" stroke="#4b5563"/><text x="635" y="208" text-anchor="middle" font-size="10" font-weight="bold" fill="white">Tunnel 2（スタンバイ）</text><text x="635" y="228" text-anchor="middle" font-size="9" fill="#f3f4f6">EP: 169.254.11.1</text><text x="635" y="242" text-anchor="middle" font-size="9" fill="#f3f4f6">Inside: 169.254.11.0/30</text><line x1="180" y1="138" x2="538" y2="138" stroke="#ef4444" stroke-width="2.5"/><polygon points="540,138 532,134 532,142" fill="#ef4444"/><text x="360" y="128" text-anchor="middle" font-size="10" font-weight="bold" fill="#ef4444">Tunnel 1（通常使用）</text><line x1="180" y1="215" x2="538" y2="215" stroke="#9ca3af" stroke-width="1.5" stroke-dasharray="6,4"/><polygon points="540,215 532,211 532,219" fill="#9ca3af"/><text x="360" y="208" text-anchor="middle" font-size="10" fill="#9ca3af">Tunnel 2（待機中）</text><rect x="20" y="260" width="700" height="60" rx="6" fill="#f0fdf4" stroke="#22c55e" stroke-width="1"/><text x="380" y="282" text-anchor="middle" font-size="11" font-weight="bold" fill="#15803d">フェイルオーバー動作</text><text x="380" y="300" text-anchor="middle" font-size="10" fill="#374151">Tunnel 1 障害検知（DPD: Dead Peer Detection）→ 自動的に Tunnel 2 へ切り替え（BGP 再収束: 約30-60秒）</text><text x="380" y="316" text-anchor="middle" font-size="10" fill="#374151">BGP 使用時: ルートが自動更新 ／ 静的ルーティング使用時: フェイルオーバー遅延あり</text></svg>

<!--
AWS S2S VPNは常に2本のトンネルを作成。各トンネルは別々のAWSエンドポイントに接続し、片方障害時に自動フェイルオーバー。BGP使用時は収束が速い。
-->

---

# 静的ルーティング vs BGP 動的ルーティング

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="15" y="20" width="350" height="320" rx="8" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><rect x="15" y="20" width="350" height="35" rx="8" fill="#d97706"/><rect x="15" y="41" width="350" height="14" fill="#d97706"/><text x="190" y="45" text-anchor="middle" font-size="13" font-weight="bold" fill="white">静的ルーティング</text><text x="20" y="80" font-size="11" fill="#374151">  設定: 手動でオンプレ CIDR を指定</text><text x="20" y="100" font-size="11" fill="#15803d">  ✓ 設定がシンプル・わかりやすい</text><text x="20" y="120" font-size="11" fill="#15803d">  ✓ BGP 非対応機器でも動作</text><text x="20" y="140" font-size="11" fill="#dc2626">  ✗ 自動フェイルオーバーなし</text><text x="20" y="160" font-size="11" fill="#dc2626">  ✗ ルート変更時は手動更新が必要</text><text x="20" y="180" font-size="11" fill="#dc2626">  ✗ トンネル障害の検知・切替に遅延</text><text x="20" y="210" font-size="10" font-weight="bold" fill="#374151">  制限: 最大 100 プレフィックス/VPN</text><text x="20" y="240" font-size="11" font-weight="bold" fill="#374151">  推奨ユースケース:</text><text x="20" y="260" font-size="11" fill="#374151">  ・BGP 非対応の古い機器</text><text x="20" y="280" font-size="11" fill="#374151">  ・単一拠点でルート変更なし</text><text x="20" y="300" font-size="11" fill="#374151">  ・PoC / テスト環境</text><rect x="395" y="20" width="350" height="320" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><rect x="395" y="20" width="350" height="35" rx="8" fill="#15803d"/><rect x="395" y="41" width="350" height="14" fill="#15803d"/><text x="570" y="45" text-anchor="middle" font-size="13" font-weight="bold" fill="white">BGP 動的ルーティング（推奨）</text><text x="400" y="80" font-size="11" fill="#374151">  設定: BGP セッションでルート自動交換</text><text x="400" y="100" font-size="11" fill="#15803d">  ✓ 自動フェイルオーバー（BGP 再収束）</text><text x="400" y="120" font-size="11" fill="#15803d">  ✓ ルート変更がリアルタイムで反映</text><text x="400" y="140" font-size="11" fill="#15803d">  ✓ AS_PATH prepend で優先制御</text><text x="400" y="160" font-size="11" fill="#15803d">  ✓ 複数経路の負荷分散（ECMP）</text><text x="400" y="180" font-size="11" fill="#dc2626">  ✗ BGP 対応ルーターが必要</text><text x="400" y="210" font-size="10" font-weight="bold" fill="#374151">  制限: 広報受信 100/VPN, 送信10,000</text><text x="400" y="240" font-size="11" font-weight="bold" fill="#374151">  推奨ユースケース:</text><text x="400" y="260" font-size="11" fill="#374151">  ・本番環境（高可用性要件あり）</text><text x="400" y="280" font-size="11" fill="#374151">  ・複数拠点 / 多様なルート構成</text><text x="400" y="300" font-size="11" fill="#374151">  ・TGW + ECMP による帯域集約</text></svg>

<!--
本番環境ではBGPを強く推奨。自動フェイルオーバー、AS_PATH prependによるトラフィック制御、ECMPによる帯域集約が可能。
-->

---

# ルート伝播（Route Propagation）

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="20" y="20" width="170" height="100" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><text x="105" y="58" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">Customer Router</text><text x="105" y="78" text-anchor="middle" font-size="10" fill="#374151">192.168.0.0/16</text><text x="105" y="98" text-anchor="middle" font-size="10" fill="#374151">172.16.0.0/12</text><text x="105" y="115" text-anchor="middle" font-size="9" fill="#6b7280">BGP 広報</text><rect x="295" y="20" width="170" height="100" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><text x="380" y="58" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">VGW</text><text x="380" y="78" text-anchor="middle" font-size="10" fill="#374151">BGP セッション確立</text><text x="380" y="98" text-anchor="middle" font-size="10" fill="#374151">ルート受信</text><text x="380" y="115" text-anchor="middle" font-size="9" fill="#374151">AS 7224</text><line x1="190" y1="70" x2="293" y2="70" stroke="#374151" stroke-width="2"/><polygon points="295,70 287,66 287,74" fill="#374151"/><text x="242" y="62" text-anchor="middle" font-size="9" fill="#374151">BGP</text><rect x="20" y="190" width="710" height="140" rx="8" fill="#f8fafc" stroke="#e2e8f0" stroke-width="2"/><text x="375" y="213" text-anchor="middle" font-size="12" font-weight="bold" fill="#374151">VPC Route Table（ルート伝播 有効）</text><rect x="30" y="225" width="690" height="30" rx="4" fill="#dbeafe" stroke="#3b82f6"/><text x="100" y="244" text-anchor="middle" font-size="10" fill="#1e40af">10.0.0.0/16</text><text x="300" y="244" text-anchor="middle" font-size="10" fill="#374151">local</text><text x="560" y="244" text-anchor="middle" font-size="10" fill="#374151">—</text><rect x="30" y="260" width="690" height="30" rx="4" fill="#dcfce7" stroke="#22c55e"/><text x="100" y="279" text-anchor="middle" font-size="10" fill="#15803d">192.168.0.0/16</text><text x="300" y="279" text-anchor="middle" font-size="10" fill="#374151">vgw-xxxxxxxx</text><text x="560" y="279" text-anchor="middle" font-size="10" fill="#22c55e">自動追加（ルート伝播）</text><rect x="30" y="295" width="690" height="28" rx="4" fill="#dcfce7" stroke="#22c55e"/><text x="100" y="313" text-anchor="middle" font-size="10" fill="#15803d">172.16.0.0/12</text><text x="300" y="313" text-anchor="middle" font-size="10" fill="#374151">vgw-xxxxxxxx</text><text x="560" y="313" text-anchor="middle" font-size="10" fill="#22c55e">自動追加（ルート伝播）</text><line x1="380" y1="120" x2="380" y2="188" stroke="#eab308" stroke-width="2"/><polygon points="380,190 376,182 384,182" fill="#eab308"/><rect x="295" y="148" width="170" height="35" rx="6" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><text x="380" y="170" text-anchor="middle" font-size="10" font-weight="bold" fill="#854d0e">ルート伝播 ON</text></svg>

<!--
ルート伝播を有効にすると、VGNからBGPで受け取ったルートが自動でRoute Tableに追加される。各サブネットのRoute Tableに対して個別に有効化が必要。
-->

---

# NAT Traversal（NAT-T）の仕組み

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="60" width="130" height="110" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><text x="75" y="92" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">Customer</text><text x="75" y="110" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">Router</text><text x="75" y="130" text-anchor="middle" font-size="9" fill="#374151">Private IP:</text><text x="75" y="148" text-anchor="middle" font-size="9" fill="#374151">10.1.0.1</text><rect x="175" y="60" width="120" height="110" rx="8" fill="#fef9c3" stroke="#eab308" stroke-width="2"/><text x="235" y="92" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">NAT</text><text x="235" y="110" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">Device</text><text x="235" y="130" text-anchor="middle" font-size="9" fill="#374151">外部IP:</text><text x="235" y="148" text-anchor="middle" font-size="9" fill="#374151">203.0.113.1</text><ellipse cx="430" cy="115" rx="90" ry="50" fill="#e0f2fe" stroke="#7dd3fc" stroke-width="2"/><text x="430" y="110" text-anchor="middle" font-size="11" font-weight="bold" fill="#0369a1">インターネット</text><text x="430" y="128" text-anchor="middle" font-size="9" fill="#0c4a6e">Public Network</text><rect x="560" y="60" width="185" height="110" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><text x="652" y="92" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">AWS VPN</text><text x="652" y="110" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">Endpoint</text><text x="652" y="130" text-anchor="middle" font-size="9" fill="#374151">52.0.0.1</text><text x="652" y="148" text-anchor="middle" font-size="9" fill="#374151">NAT-T 自動検知</text><line x1="140" y1="115" x2="173" y2="115" stroke="#374151" stroke-width="2"/><polygon points="175,115 167,111 167,119" fill="#374151"/><line x1="295" y1="115" x2="338" y2="115" stroke="#374151" stroke-width="2"/><polygon points="340,115 332,111 332,119" fill="#374151"/><line x1="520" y1="115" x2="558" y2="115" stroke="#374151" stroke-width="2"/><polygon points="560,115 552,111 552,119" fill="#374151"/><rect x="10" y="210" width="730" height="130" rx="8" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/><text x="380" y="232" text-anchor="middle" font-size="12" font-weight="bold" fill="#374151">NAT-T（NAT Traversal）の動作</text><rect x="20" y="245" width="340" height="85" rx="6" fill="#fee2e2" stroke="#ef4444" stroke-width="1"/><text x="190" y="265" text-anchor="middle" font-size="11" font-weight="bold" fill="#ef4444">NAT なし（標準 IPsec）</text><text x="190" y="285" text-anchor="middle" font-size="10" fill="#374151">IKE: UDP 500</text><text x="190" y="303" text-anchor="middle" font-size="10" fill="#374151">ESP: IP Protocol 50（直接）</text><text x="190" y="321" text-anchor="middle" font-size="10" fill="#dc2626">NAT 機器でドロップされる</text><rect x="390" y="245" width="340" height="85" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="1"/><text x="560" y="265" text-anchor="middle" font-size="11" font-weight="bold" fill="#15803d">NAT-T 有効（AWS デフォルト）</text><text x="560" y="285" text-anchor="middle" font-size="10" fill="#374151">IKE: UDP 500 → UDP 4500 に移行</text><text x="560" y="303" text-anchor="middle" font-size="10" fill="#374151">ESP → UDP 4500 でカプセル化</text><text x="560" y="321" text-anchor="middle" font-size="10" fill="#15803d">NAT 経由でも IPsec 通信可能</text></svg>

<!--
CGWがNATの背後にある場合、NAT-TがESPをUDP 4500でカプセル化することでNATを透過させる。AWS VPN EndpointはデフォルトでNAT-Tを有効化。
-->

---

# IKE フェーズとトンネル確立フロー

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><text x="170" y="22" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">Customer Router</text><text x="590" y="22" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">AWS VGW / TGW</text><line x1="170" y1="28" x2="170" y2="340" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><line x1="590" y1="28" x2="590" y2="340" stroke="#3b82f6" stroke-width="1.5" stroke-dasharray="4,3"/><rect x="15" y="30" width="730" height="28" rx="4" fill="#374151"/><text x="380" y="48" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Phase 1: IKE SA 確立（双方向認証・鍵交換）</text><line x1="170" y1="80" x2="590" y2="80" stroke="#ef4444" stroke-width="1.5"/><polygon points="592,80 584,76 584,84" fill="#ef4444"/><text x="380" y="73" text-anchor="middle" font-size="10" fill="#374151">IKE_SA_INIT（提案: 暗号化・DH・ハッシュ）</text><line x1="590" y1="105" x2="170" y2="105" stroke="#ef4444" stroke-width="1.5"/><polygon points="168,105 176,101 176,109" fill="#ef4444"/><text x="380" y="98" text-anchor="middle" font-size="10" fill="#374151">IKE_SA_INIT 応答（選択したパラメータ + DH公開鍵）</text><line x1="170" y1="130" x2="590" y2="130" stroke="#ef4444" stroke-width="1.5"/><polygon points="592,130 584,126 584,134" fill="#ef4444"/><text x="380" y="123" text-anchor="middle" font-size="10" fill="#374151">IKE_AUTH（ID・証明書/PSK・認証）</text><line x1="590" y1="155" x2="170" y2="155" stroke="#ef4444" stroke-width="1.5"/><polygon points="168,155 176,151 176,159" fill="#ef4444"/><text x="380" y="148" text-anchor="middle" font-size="10" fill="#374151">IKE_AUTH 応答 → IKE SA 確立完了</text><rect x="15" y="168" width="730" height="28" rx="4" fill="#1d4ed8"/><text x="380" y="186" text-anchor="middle" font-size="11" font-weight="bold" fill="white">Phase 2: IPsec SA 確立（実データ保護の鍵交換）</text><line x1="170" y1="218" x2="590" y2="218" stroke="#3b82f6" stroke-width="1.5"/><polygon points="592,218 584,214 584,222" fill="#3b82f6"/><text x="380" y="211" text-anchor="middle" font-size="10" fill="#374151">CREATE_CHILD_SA（ESP パラメータ・PFS グループ）</text><line x1="590" y1="243" x2="170" y2="243" stroke="#3b82f6" stroke-width="1.5"/><polygon points="168,243 176,239 176,247" fill="#3b82f6"/><text x="380" y="236" text-anchor="middle" font-size="10" fill="#374151">CREATE_CHILD_SA 応答 → IPsec SA 確立完了</text><rect x="15" y="260" width="730" height="28" rx="4" fill="#15803d"/><text x="380" y="278" text-anchor="middle" font-size="11" font-weight="bold" fill="white">暗号化されたデータ通信開始</text><rect x="15" y="300" width="730" height="40" rx="4" fill="#f8fafc" stroke="#e2e8f0"/><text x="120" y="318" text-anchor="middle" font-size="9" fill="#374151">IKE SA 有効期限: 28,800秒（8時間）</text><text x="380" y="318" text-anchor="middle" font-size="9" fill="#374151">IPsec SA 有効期限: 3,600秒（1時間）</text><text x="620" y="318" text-anchor="middle" font-size="9" fill="#374151">DPD: デッドピア検知（30秒間隔）</text><text x="380" y="334" text-anchor="middle" font-size="9" fill="#6b7280">再鍵交換はセッション継続中に自動実行（トラフィック中断なし）</text></svg>

<!--
IKEv2の4メッセージシーケンス。Phase 1でIKE SAを確立し、Phase 2でIPsec SA（CHILD SA）を確立。再鍵交換は自動で行われ通信は継続される。
-->

---

# Site-to-Site VPN 制限・クォータ

- **VPN 接続数**: 10/VGW（デフォルト）、50/TGW（デフォルト）— 上限緩和申請可
- **トンネルスループット**: 最大 1.25 Gbps/トンネル（AWS 側上限）
- **BGP プレフィックス受信**: 最大 100 プレフィックス（CGW から VGW/TGW へ）
- **BGP プレフィックス送信**: 最大 10,000 ルート（VGW から CGW へ）
- **トンネル MTU**: 1,436 バイト（NAT-T 有効時）/ 1,446 バイト（NAT-T 無効時）
- **Customer Gateway 数**: 50/リージョン（デフォルト）— 緩和申請可

<!--
ANS試験でよく問われる数字。特に「BGP広報プレフィックス上限100」「トンネルスループット1.25Gbps」は必須暗記。MTU断片化にも注意。
-->

---

<!-- _class: lead -->
# Section 3: AWS Client VPN

- リモートユーザーが VPC リソースに安全にアクセス
- OpenVPN 互換クライアントを使用するフルマネージドサービス
- 証明書・Active Directory・SAML SSO の 3 種類の認証方式をサポート

<!--
Client VPNはエンドユーザー向けのリモートアクセスVPN。OpenVPN互換クライアントを利用するためクロスプラットフォーム対応。
-->

---

# Client VPN アーキテクチャ

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="50" width="100" height="70" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="60" y="82" text-anchor="middle" font-size="10" fill="#374151">ユーザー 1</text><text x="60" y="100" text-anchor="middle" font-size="9" fill="#6b7280">OpenVPN</text><rect x="10" y="145" width="100" height="70" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="60" y="177" text-anchor="middle" font-size="10" fill="#374151">ユーザー 2</text><text x="60" y="195" text-anchor="middle" font-size="9" fill="#6b7280">OpenVPN</text><rect x="10" y="240" width="100" height="70" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="60" y="272" text-anchor="middle" font-size="10" fill="#374151">ユーザー 3</text><text x="60" y="290" text-anchor="middle" font-size="9" fill="#6b7280">OpenVPN</text><ellipse cx="250" cy="185" rx="75" ry="45" fill="#e0f2fe" stroke="#7dd3fc" stroke-width="2"/><text x="250" y="180" text-anchor="middle" font-size="10" font-weight="bold" fill="#0369a1">インターネット</text><text x="250" y="196" text-anchor="middle" font-size="9" fill="#0c4a6e">TLS 1.2+</text><line x1="110" y1="85" x2="173" y2="165" stroke="#6b7280" stroke-width="1" stroke-dasharray="3,2"/><line x1="110" y1="180" x2="173" y2="185" stroke="#6b7280" stroke-width="1" stroke-dasharray="3,2"/><line x1="110" y1="275" x2="173" y2="205" stroke="#6b7280" stroke-width="1" stroke-dasharray="3,2"/><rect x="360" y="30" width="380" height="300" rx="8" fill="#f0f9ff" stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,3"/><text x="550" y="52" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">AWS VPC</text><rect x="375" y="65" width="200" height="90" rx="6" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><text x="475" y="90" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">Client VPN Endpoint</text><text x="475" y="110" text-anchor="middle" font-size="9" fill="#374151">クライアント CIDR:</text><text x="475" y="126" text-anchor="middle" font-size="9" fill="#374151">172.16.0.0/22</text><text x="475" y="144" text-anchor="middle" font-size="9" fill="#374151">ENI: subnet-xxx</text><rect x="590" y="65" width="140" height="80" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/><text x="660" y="90" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">認証</text><text x="660" y="108" text-anchor="middle" font-size="9" fill="#374151">証明書 / AD</text><text x="660" y="124" text-anchor="middle" font-size="9" fill="#374151">SAML SSO</text><rect x="375" y="175" width="340" height="50" rx="6" fill="#fef9c3" stroke="#eab308" stroke-width="1.5"/><text x="545" y="197" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">ルート + Authorization Rules</text><text x="545" y="213" text-anchor="middle" font-size="9" fill="#374151">どのグループがどの CIDR にアクセスできるか</text><rect x="375" y="240" width="155" height="60" rx="6" fill="#a7f3d0" stroke="#059669" stroke-width="1.5"/><text x="452" y="268" text-anchor="middle" font-size="10" font-weight="bold" fill="#065f46">Private Resources</text><text x="452" y="286" text-anchor="middle" font-size="9" fill="#374151">EC2 / RDS / EFS</text><rect x="560" y="240" width="155" height="60" rx="6" fill="#a7f3d0" stroke="#059669" stroke-width="1.5"/><text x="637" y="268" text-anchor="middle" font-size="10" font-weight="bold" fill="#065f46">On-Premises</text><text x="637" y="286" text-anchor="middle" font-size="9" fill="#374151">S2S VPN 経由</text><line x1="325" y1="185" x2="373" y2="115" stroke="#374151" stroke-width="2"/><polygon points="375,113 367,117 371,125" fill="#374151"/></svg>

<!--
Client VPNエンドポイントはVPCのサブネットに関連付けられたENIとして存在。ユーザーはOpenVPN互換クライアントでTLS接続し、認証後に指定CIDRへのアクセスが許可される。
-->

---

# Client VPN 認証方式 3 種類

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="20" width="230" height="320" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/><rect x="10" y="20" width="230" height="35" rx="8" fill="#1d4ed8"/><rect x="10" y="41" width="230" height="14" fill="#1d4ed8"/><text x="125" y="45" text-anchor="middle" font-size="12" font-weight="bold" fill="white">証明書認証</text><text x="125" y="80" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">相互 TLS 認証</text><text x="15" y="103" font-size="10" fill="#374151">  ✓ サーバー証明書: ACM</text><text x="15" y="121" font-size="10" fill="#374151">  ✓ クライアント証明書: 個別発行</text><text x="15" y="139" font-size="10" fill="#374151">  ✓ 追加インフラ不要</text><text x="15" y="157" font-size="10" fill="#374151">  ✓ MFA と組み合わせ可</text><text x="15" y="185" font-size="10" fill="#374151">  ✗ 証明書失効管理が必要</text><text x="15" y="203" font-size="10" fill="#374151">  ✗ 大規模は証明書配布が煩雑</text><text x="125" y="235" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">推奨: 小〜中規模</text><text x="125" y="255" text-anchor="middle" font-size="10" fill="#374151">easy-rsa / ACM Private CA</text><text x="125" y="275" text-anchor="middle" font-size="10" fill="#6b7280">ユーザー毎 or 共有証明書</text><text x="125" y="295" text-anchor="middle" font-size="9" fill="#6b7280">共有: 1 証明書を複数ユーザー利用</text><text x="125" y="315" text-anchor="middle" font-size="9" fill="#6b7280">個別: ユーザー単位での失効が可能</text><rect x="265" y="20" width="230" height="320" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><rect x="265" y="20" width="230" height="35" rx="8" fill="#15803d"/><rect x="265" y="41" width="230" height="14" fill="#15803d"/><text x="380" y="45" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Active Directory 認証</text><text x="380" y="80" text-anchor="middle" font-size="11" font-weight="bold" fill="#15803d">LDAP / AD DS 統合</text><text x="270" y="103" font-size="10" fill="#374151">  ✓ 既存 AD ユーザーを流用</text><text x="270" y="121" font-size="10" fill="#374151">  ✓ グループポリシー連携</text><text x="270" y="139" font-size="10" fill="#374151">  ✓ パスワード一元管理</text><text x="270" y="157" font-size="10" fill="#374151">  ✓ MFA with RADIUS 対応</text><text x="270" y="185" font-size="10" fill="#374151">  ✗ AWS Managed Microsoft AD</text><text x="270" y="203" font-size="10" fill="#374151">     または AD Connector 必要</text><text x="380" y="235" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">推奨: 既存 AD 環境保有企業</text><text x="380" y="255" text-anchor="middle" font-size="10" fill="#374151">AWS Managed Microsoft AD</text><text x="380" y="275" text-anchor="middle" font-size="10" fill="#374151">または AD Connector</text><text x="380" y="295" text-anchor="middle" font-size="9" fill="#6b7280">Authorization rules で</text><text x="380" y="315" text-anchor="middle" font-size="9" fill="#6b7280">AD グループ単位でアクセス制御</text><rect x="520" y="20" width="230" height="320" rx="8" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/><rect x="520" y="20" width="230" height="35" rx="8" fill="#7c3aed"/><rect x="520" y="41" width="230" height="14" fill="#7c3aed"/><text x="635" y="45" text-anchor="middle" font-size="12" font-weight="bold" fill="white">SAML 2.0 SSO 認証</text><text x="635" y="80" text-anchor="middle" font-size="11" font-weight="bold" fill="#7e22ce">フェデレーション認証</text><text x="525" y="103" font-size="10" fill="#374151">  ✓ IdP 統合（Okta / Azure AD）</text><text x="525" y="121" font-size="10" fill="#374151">  ✓ SSO: 既存 IdP ログイン活用</text><text x="525" y="139" font-size="10" fill="#374151">  ✓ MFA は IdP 側で実施</text><text x="525" y="157" font-size="10" fill="#374151">  ✓ 証明書管理が不要</text><text x="525" y="185" font-size="10" fill="#374151">  ✗ IAM Identity Center の設定</text><text x="525" y="203" font-size="10" fill="#374151">     + IdP 連携設定が必要</text><text x="635" y="235" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">推奨: 大規模・クラウドネイティブ</text><text x="635" y="255" text-anchor="middle" font-size="10" fill="#374151">IAM Identity Center 経由</text><text x="635" y="275" text-anchor="middle" font-size="10" fill="#374151">SAML 2.0 対応 IdP と連携</text><text x="635" y="295" text-anchor="middle" font-size="9" fill="#6b7280">Okta / Azure AD / Google Workspace</text><text x="635" y="315" text-anchor="middle" font-size="9" fill="#6b7280">などの商用 IdP が利用可能</text></svg>

<!--
3種類の認証方式を目的に応じて選択。証明書：シンプル、AD：既存AD環境、SAML：大規模SSO。いずれもMFA追加が可能。
-->

---

# 証明書認証: セットアップフロー

- <svg viewBox="0 0 760 340" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="20" width="100" height="55" rx="6" fill="#374151"/><text x="60" y="46" text-anchor="middle" font-size="9" fill="white" font-weight="bold">1. CA 証明書</text><text x="60" y="62" text-anchor="middle" font-size="9" fill="#d1fae5">easy-rsa 生成</text><line x1="110" y1="47" x2="148" y2="47" stroke="#374151" stroke-width="1.5"/><polygon points="150,47 142,43 142,51" fill="#374151"/><rect x="150" y="20" width="100" height="55" rx="6" fill="#1d4ed8"/><text x="200" y="46" text-anchor="middle" font-size="9" fill="white" font-weight="bold">2. ACM に</text><text x="200" y="62" text-anchor="middle" font-size="9" fill="#bfdbfe">CA 証明書 Import</text><line x1="250" y1="47" x2="288" y2="47" stroke="#374151" stroke-width="1.5"/><polygon points="290,47 282,43 282,51" fill="#374151"/><rect x="290" y="20" width="100" height="55" rx="6" fill="#1d4ed8"/><text x="340" y="46" text-anchor="middle" font-size="9" fill="white" font-weight="bold">3. サーバー証明書</text><text x="340" y="62" text-anchor="middle" font-size="9" fill="#bfdbfe">ACM に Import</text><line x1="390" y1="47" x2="428" y2="47" stroke="#374151" stroke-width="1.5"/><polygon points="430,47 422,43 422,51" fill="#374151"/><rect x="430" y="20" width="130" height="55" rx="6" fill="#15803d"/><text x="495" y="46" text-anchor="middle" font-size="9" fill="white" font-weight="bold">4. Client VPN Endpoint</text><text x="495" y="62" text-anchor="middle" font-size="9" fill="#d1fae5">作成（サーバー証明書指定）</text><line x1="560" y1="47" x2="598" y2="47" stroke="#374151" stroke-width="1.5"/><polygon points="600,47 592,43 592,51" fill="#374151"/><rect x="600" y="20" width="150" height="55" rx="6" fill="#15803d"/><text x="675" y="46" text-anchor="middle" font-size="9" fill="white" font-weight="bold">5. サブネット関連付け</text><text x="675" y="62" text-anchor="middle" font-size="9" fill="#d1fae5">+ Authorization Rules</text><rect x="10" y="110" width="100" height="55" rx="6" fill="#7c3aed"/><text x="60" y="136" text-anchor="middle" font-size="9" fill="white" font-weight="bold">6. クライアント証明書</text><text x="60" y="152" text-anchor="middle" font-size="9" fill="#e9d5ff">ユーザー毎に発行</text><line x1="110" y1="137" x2="148" y2="137" stroke="#374151" stroke-width="1.5"/><polygon points="150,137 142,133 142,141" fill="#374151"/><rect x="150" y="110" width="100" height="55" rx="6" fill="#7c3aed"/><text x="200" y="136" text-anchor="middle" font-size="9" fill="white" font-weight="bold">7. .ovpn 設定ファイル</text><text x="200" y="152" text-anchor="middle" font-size="9" fill="#e9d5ff">ダウンロード + 証明書埋込</text><line x1="250" y1="137" x2="288" y2="137" stroke="#374151" stroke-width="1.5"/><polygon points="290,137 282,133 282,141" fill="#374151"/><rect x="290" y="110" width="100" height="55" rx="6" fill="#d97706"/><text x="340" y="136" text-anchor="middle" font-size="9" fill="white" font-weight="bold">8. OpenVPN クライアント</text><text x="340" y="152" text-anchor="middle" font-size="9" fill="#fef3c7">.ovpn をインポート</text><line x1="390" y1="137" x2="428" y2="137" stroke="#374151" stroke-width="1.5"/><polygon points="430,137 422,133 422,141" fill="#374151"/><rect x="430" y="110" width="100" height="55" rx="6" fill="#ef4444"/><text x="480" y="136" text-anchor="middle" font-size="9" fill="white" font-weight="bold">9. VPN 接続</text><text x="480" y="152" text-anchor="middle" font-size="9" fill="#fee2e2">TLS ハンドシェイク完了</text><line x1="530" y1="137" x2="568" y2="137" stroke="#374151" stroke-width="1.5"/><polygon points="570,137 562,133 562,141" fill="#374151"/><rect x="570" y="110" width="180" height="55" rx="6" fill="#059669"/><text x="660" y="136" text-anchor="middle" font-size="9" fill="white" font-weight="bold">10. VPC リソースへアクセス</text><text x="660" y="152" text-anchor="middle" font-size="9" fill="#d1fae5">Authorization Rules に従いアクセス</text><rect x="10" y="205" width="730" height="120" rx="8" fill="#f8fafc" stroke="#e2e8f0"/><text x="380" y="228" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">主要コマンド（easy-rsa を使った証明書発行）</text><text x="20" y="250" font-size="9" font-family="monospace" fill="#374151">  ./easyrsa init-pki                            # PKI 初期化</text><text x="20" y="268" font-size="9" font-family="monospace" fill="#374151">  ./easyrsa build-ca nopass                     # CA 証明書作成</text><text x="20" y="286" font-size="9" font-family="monospace" fill="#374151">  ./easyrsa build-server-full server nopass     # サーバー証明書作成</text><text x="20" y="304" font-size="9" font-family="monospace" fill="#374151">  ./easyrsa build-client-full client1 nopass    # クライアント証明書作成</text></svg>

<!--
証明書認証のセットアップは10ステップ。easy-rsaでCA/サーバー/クライアント証明書を生成し、サーバー証明書をACMにインポートしてEndpointを作成する。
-->

---

# スプリットトンネル vs フルトンネル

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="15" width="355" height="330" rx="8" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/><rect x="10" y="15" width="355" height="35" rx="8" fill="#b91c1c"/><rect x="10" y="36" width="355" height="14" fill="#b91c1c"/><text x="187" y="40" text-anchor="middle" font-size="13" font-weight="bold" fill="white">フルトンネル（デフォルト）</text><rect x="20" y="65" width="80" height="50" rx="4" fill="#f3f4f6" stroke="#6b7280"/><text x="60" y="88" text-anchor="middle" font-size="9" fill="#374151">ユーザー PC</text><text x="60" y="104" font-size="8" text-anchor="middle" fill="#6b7280">172.16.x.x</text><rect x="210" y="65" width="80" height="50" rx="4" fill="#dbeafe" stroke="#3b82f6"/><text x="250" y="88" text-anchor="middle" font-size="9" fill="#1e40af">VPN EP</text><text x="250" y="104" font-size="8" text-anchor="middle" fill="#374151">10.0.x.x</text><rect x="310" y="55" width="50" height="35" rx="4" fill="#a7f3d0" stroke="#059669"/><text x="335" y="77" text-anchor="middle" font-size="8" fill="#065f46">VPC</text><rect x="310" y="100" width="50" height="35" rx="4" fill="#e0f2fe" stroke="#0369a1"/><text x="335" y="122" text-anchor="middle" font-size="8" fill="#0c4a6e">Internet</text><line x1="100" y1="90" x2="208" y2="90" stroke="#ef4444" stroke-width="2"/><polygon points="210,90 202,86 202,94" fill="#ef4444"/><line x1="290" y1="80" x2="308" y2="72" stroke="#374151" stroke-width="1"/><polygon points="310,70 302,74 306,82" fill="#374151"/><line x1="290" y1="100" x2="308" y2="110" stroke="#374151" stroke-width="1"/><polygon points="310,112 302,108 306,116" fill="#374151"/><text x="150" y="84" text-anchor="middle" font-size="8" fill="#ef4444">全トラフィック</text><text x="20" y="160" font-size="10" fill="#374151">  全トラフィックが VPN → VPC → Internet</text><text x="20" y="178" font-size="10" fill="#15803d">  ✓ 最高レベルのセキュリティ</text><text x="20" y="196" font-size="10" fill="#15803d">  ✓ インターネット出口を一元管理</text><text x="20" y="214" font-size="10" fill="#dc2626">  ✗ 全トラフィックがVPN EP経由</text><text x="20" y="232" font-size="10" fill="#dc2626">  ✗ コスト増・レイテンシ増</text><text x="20" y="250" font-size="10" fill="#dc2626">  ✗ EP の帯域を圧迫しやすい</text><text x="20" y="278" font-size="10" font-weight="bold" fill="#374151">  適用場面:</text><text x="20" y="296" font-size="10" fill="#374151">  ・コンプライアンス要件（全通信ログ取得）</text><text x="20" y="314" font-size="10" fill="#374151">  ・ゼロトラスト移行前の暫定対応</text><rect x="395" y="15" width="355" height="330" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><rect x="395" y="15" width="355" height="35" rx="8" fill="#15803d"/><rect x="395" y="36" width="355" height="14" fill="#15803d"/><text x="572" y="40" text-anchor="middle" font-size="13" font-weight="bold" fill="white">スプリットトンネル（推奨）</text><rect x="405" y="65" width="80" height="50" rx="4" fill="#f3f4f6" stroke="#6b7280"/><text x="445" y="88" text-anchor="middle" font-size="9" fill="#374151">ユーザー PC</text><text x="445" y="104" font-size="8" text-anchor="middle" fill="#6b7280">172.16.x.x</text><rect x="580" y="55" width="70" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6"/><text x="615" y="77" text-anchor="middle" font-size="9" fill="#1e40af">VPN → VPC</text><rect x="580" y="100" width="70" height="35" rx="4" fill="#fef9c3" stroke="#eab308"/><text x="615" y="122" text-anchor="middle" font-size="9" fill="#854d0e">直接 Internet</text><rect x="670" y="55" width="70" height="35" rx="4" fill="#a7f3d0" stroke="#059669"/><text x="705" y="77" text-anchor="middle" font-size="8" fill="#065f46">VPC リソース</text><line x1="485" y1="80" x2="578" y2="72" stroke="#3b82f6" stroke-width="2"/><polygon points="580,70 572,74 576,82" fill="#3b82f6"/><line x1="485" y1="100" x2="578" y2="112" stroke="#eab308" stroke-width="2"/><polygon points="580,114 572,110 576,118" fill="#eab308"/><line x1="650" y1="72" x2="668" y2="72" stroke="#374151" stroke-width="1"/><polygon points="670,72 662,68 662,76" fill="#374151"/><text x="405" y="160" font-size="10" fill="#374151">  AWS CIDR のみ VPN、それ以外は直接</text><text x="405" y="178" font-size="10" fill="#15803d">  ✓ EP の負荷・コストを大幅削減</text><text x="405" y="196" font-size="10" fill="#15803d">  ✓ インターネットアクセスが高速</text><text x="405" y="214" font-size="10" fill="#15803d">  ✓ ほとんどのユースケースで推奨</text><text x="405" y="232" font-size="10" fill="#dc2626">  ✗ インターネット通信はVPN外</text><text x="405" y="278" font-size="10" font-weight="bold" fill="#374151">  適用場面:</text><text x="405" y="296" font-size="10" fill="#374151">  ・一般的なリモートワーク環境</text><text x="405" y="314" font-size="10" fill="#374151">  ・VPC + オンプレ間アクセスが目的</text></svg>

<!--
スプリットトンネルが推奨。AWSのCIDRのみVPN経由とすることで、Client VPN Endpointの負荷とコストを削減。インターネットトラフィックは直接経路を使用。
-->

---

# ルーティングと Authorization Rules

- <svg viewBox="0 0 760 340" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="20" width="340" height="300" rx="8" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/><rect x="10" y="20" width="340" height="35" rx="8" fill="#1d4ed8"/><rect x="10" y="41" width="340" height="14" fill="#1d4ed8"/><text x="180" y="45" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Route Table（Client VPN Endpoint）</text><rect x="20" y="70" width="320" height="28" rx="4" fill="#dbeafe" stroke="#93c5fd"/><text x="80" y="88" text-anchor="middle" font-size="10" fill="#1e40af">10.0.0.0/16</text><text x="250" y="88" text-anchor="middle" font-size="10" fill="#374151">subnet-aaa → VPC プライベート</text><rect x="20" y="105" width="320" height="28" rx="4" fill="#dbeafe" stroke="#93c5fd"/><text x="80" y="123" text-anchor="middle" font-size="10" fill="#1e40af">192.168.0.0/16</text><text x="250" y="123" text-anchor="middle" font-size="10" fill="#374151">subnet-bbb → オンプレ（S2S VPN 経由）</text><rect x="20" y="140" width="320" height="28" rx="4" fill="#fef9c3" stroke="#eab308"/><text x="80" y="158" text-anchor="middle" font-size="10" fill="#854d0e">0.0.0.0/0</text><text x="250" y="158" text-anchor="middle" font-size="10" fill="#374151">NAT GW → インターネット（フルトンネル時）</text><text x="180" y="200" text-anchor="middle" font-size="10" fill="#374151">ルートを追加するとその宛先への通信が可能に</text><text x="180" y="218" text-anchor="middle" font-size="10" fill="#374151">スプリットトンネル: VPC/オンプレ CIDR のみ追加</text><text x="180" y="255" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">注意: ルートはアクセスを「許可」しない</text><text x="180" y="275" text-anchor="middle" font-size="10" fill="#374151">Authorization Rules が別途必要</text><rect x="370" y="20" width="375" height="300" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/><rect x="370" y="20" width="375" height="35" rx="8" fill="#15803d"/><rect x="370" y="41" width="375" height="14" fill="#15803d"/><text x="557" y="45" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Authorization Rules（アクセス認可）</text><rect x="380" y="70" width="355" height="28" rx="4" fill="#dcfce7" stroke="#22c55e"/><text x="470" y="88" text-anchor="middle" font-size="10" fill="#15803d">10.0.0.0/16</text><text x="600" y="88" text-anchor="middle" font-size="10" fill="#374151">全ユーザー許可</text><rect x="380" y="105" width="355" height="28" rx="4" fill="#dcfce7" stroke="#22c55e"/><text x="470" y="123" text-anchor="middle" font-size="10" fill="#15803d">10.0.1.0/24</text><text x="600" y="123" text-anchor="middle" font-size="10" fill="#374151">AD グループ: developers</text><rect x="380" y="140" width="355" height="28" rx="4" fill="#dcfce7" stroke="#22c55e"/><text x="470" y="158" text-anchor="middle" font-size="10" fill="#15803d">10.0.10.0/24</text><text x="600" y="158" text-anchor="middle" font-size="10" fill="#374151">AD グループ: admins</text><rect x="380" y="175" width="355" height="28" rx="4" fill="#dcfce7" stroke="#22c55e"/><text x="470" y="193" text-anchor="middle" font-size="10" fill="#15803d">192.168.0.0/16</text><text x="600" y="193" text-anchor="middle" font-size="10" fill="#374151">AD グループ: networking</text><text x="557" y="240" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">ルート + Authorization Rules の両方が必要</text><text x="557" y="260" text-anchor="middle" font-size="10" fill="#374151">どちらか片方だけでは通信できない</text><text x="557" y="300" text-anchor="middle" font-size="9" fill="#6b7280">最大: 50 ルール/エンドポイント（デフォルト）</text></svg>

<!--
ルーティングとAuthorizationは別個に設定が必要。ルートはパスを定義し、Authorization Rulesはアクセス許可を定義。両方がないとアクセスできない。
-->

---

# サブネット関連付けとスケーリング

- <svg viewBox="0 0 760 340" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="280" y="20" width="200" height="80" rx="8" fill="#dbeafe" stroke="#1d4ed8" stroke-width="2"/><text x="380" y="52" text-anchor="middle" font-size="12" font-weight="bold" fill="#1e40af">Client VPN Endpoint</text><text x="380" y="72" text-anchor="middle" font-size="10" fill="#374151">クライアント CIDR: 172.16.0.0/22</text><text x="380" y="88" text-anchor="middle" font-size="9" fill="#6b7280">最大 2,000 同時接続</text><rect x="30" y="170" width="190" height="100" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><text x="125" y="197" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">サブネット AP-NORTHEAST-1A</text><text x="125" y="215" text-anchor="middle" font-size="9" fill="#374151">subnet-aaa (10.0.1.0/24)</text><text x="125" y="233" text-anchor="middle" font-size="9" fill="#374151">Client VPN ENI 作成</text><text x="125" y="251" text-anchor="middle" font-size="9" fill="#6b7280">HA 対応</text><rect x="285" y="170" width="190" height="100" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><text x="380" y="197" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">サブネット AP-NORTHEAST-1C</text><text x="380" y="215" text-anchor="middle" font-size="9" fill="#374151">subnet-bbb (10.0.2.0/24)</text><text x="380" y="233" text-anchor="middle" font-size="9" fill="#374151">Client VPN ENI 作成</text><text x="380" y="251" text-anchor="middle" font-size="9" fill="#6b7280">HA 対応</text><rect x="540" y="170" width="190" height="100" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/><text x="635" y="197" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">サブネット AP-NORTHEAST-1D</text><text x="635" y="215" text-anchor="middle" font-size="9" fill="#374151">subnet-ccc (10.0.3.0/24)</text><text x="635" y="233" text-anchor="middle" font-size="9" fill="#374151">Client VPN ENI 作成</text><text x="635" y="251" text-anchor="middle" font-size="9" fill="#6b7280">HA 対応</text><line x1="380" y1="100" x2="125" y2="168" stroke="#374151" stroke-width="1.5"/><polygon points="123,170 131,162 139,168" fill="#374151"/><line x1="380" y1="100" x2="380" y2="168" stroke="#374151" stroke-width="1.5"/><polygon points="380,170 376,162 384,162" fill="#374151"/><line x1="380" y1="100" x2="635" y2="168" stroke="#374151" stroke-width="1.5"/><polygon points="637,170 629,162 637,162" fill="#374151"/><rect x="30" y="285" width="700" height="45" rx="6" fill="#fef9c3" stroke="#eab308" stroke-width="1"/><text x="380" y="305" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">クライアント CIDR の要件</text><text x="380" y="323" text-anchor="middle" font-size="10" fill="#374151">最小 /22（1,024 IP）/ 最大 /12 ／ VPC CIDR と重複不可 ／ 予約 IP 5 個/サブネット差し引き後が実際の接続数の上限</text></svg>

<!--
複数AZのサブネットに関連付けることで高可用性を確保。各関連付けでENIが作成される。クライアントCIDRはVPC CIDRと重複不可。
-->

---

# Client VPN ユースケースと制限

- **主要ユースケース**
- リモートワーカーが VPC 内の EC2・RDS・EFS に安全にアクセス
- 開発者が本番 DB やプライベートサービスに一時アクセス（特権アクセス管理）
- S2S VPN と組み合わせてオンプレリソースにもアクセス
- **制限・クォータ（デフォルト値）**
- エンドポイント数: 5/リージョン ／ 同時接続: 2,000/エンドポイント ／ 認証ルール: 50/エンドポイント

<!--
Client VPNはフルマネージドサービスのため、サーバー管理不要。スプリットトンネル推奨でコスト最適化。同時接続2,000は上限緩和申請可能。
-->

---

<!-- _class: lead -->
# Section 4: Transit Gateway + VPN

- 複数 VPC・複数 VPN 接続を 1 つのハブで集中管理
- ECMP（Equal Cost Multi-Path）で複数 VPN 接続を束ね帯域を集約
- マルチアカウント・マルチリージョン対応の集中型ネットワーク設計

<!--
TGWはAWSネットワークのハブ。VPN接続にも使用でき、ECMPで複数トンネルの帯域を集約可能。
-->

---

# Transit Gateway VPN アーキテクチャ

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="305" y="140" width="150" height="80" rx="8" fill="#fef9c3" stroke="#d97706" stroke-width="3"/><text x="380" y="172" text-anchor="middle" font-size="12" font-weight="bold" fill="#92400e">Transit Gateway</text><text x="380" y="192" text-anchor="middle" font-size="9" fill="#374151">TGW ID: tgw-xxxxx</text><text x="380" y="208" text-anchor="middle" font-size="9" fill="#374151">AS: 64512</text><rect x="10" y="20" width="120" height="60" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="70" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">VPC A</text><text x="70" y="62" text-anchor="middle" font-size="8" fill="#374151">10.1.0.0/16</text><rect x="150" y="20" width="120" height="60" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="210" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">VPC B</text><text x="210" y="62" text-anchor="middle" font-size="8" fill="#374151">10.2.0.0/16</text><rect x="290" y="20" width="120" height="60" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="350" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">VPC C</text><text x="350" y="62" text-anchor="middle" font-size="8" fill="#374151">10.3.0.0/16</text><rect x="430" y="20" width="120" height="60" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="490" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">VPC D</text><text x="490" y="62" text-anchor="middle" font-size="8" fill="#374151">10.4.0.0/16</text><rect x="570" y="20" width="120" height="60" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="630" y="45" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">VPC E</text><text x="630" y="62" text-anchor="middle" font-size="8" fill="#374151">10.5.0.0/16</text><line x1="70" y1="80" x2="340" y2="148" stroke="#93c5fd" stroke-width="1.5"/><line x1="210" y1="80" x2="350" y2="148" stroke="#93c5fd" stroke-width="1.5"/><line x1="350" y1="80" x2="370" y2="138" stroke="#93c5fd" stroke-width="1.5"/><line x1="490" y1="80" x2="400" y2="148" stroke="#93c5fd" stroke-width="1.5"/><line x1="630" y1="80" x2="425" y2="148" stroke="#93c5fd" stroke-width="1.5"/><rect x="10" y="280" width="140" height="65" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="80" y="303" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">拠点 1（東京）</text><text x="80" y="321" text-anchor="middle" font-size="8" fill="#374151">AS 65000</text><text x="80" y="339" text-anchor="middle" font-size="8" fill="#6b7280">192.168.1.0/24</text><rect x="175" y="280" width="140" height="65" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="245" y="303" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">拠点 2（大阪）</text><text x="245" y="321" text-anchor="middle" font-size="8" fill="#374151">AS 65001</text><text x="245" y="339" text-anchor="middle" font-size="8" fill="#6b7280">192.168.2.0/24</text><rect x="445" y="280" width="140" height="65" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="515" y="303" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">拠点 3（名古屋）</text><text x="515" y="321" text-anchor="middle" font-size="8" fill="#374151">AS 65002</text><text x="515" y="339" text-anchor="middle" font-size="8" fill="#6b7280">192.168.3.0/24</text><rect x="610" y="280" width="140" height="65" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="680" y="303" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">データセンター</text><text x="680" y="321" text-anchor="middle" font-size="8" fill="#374151">AS 65003</text><text x="680" y="339" text-anchor="middle" font-size="8" fill="#6b7280">172.16.0.0/12</text><line x1="80" y1="278" x2="340" y2="222" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><line x1="245" y1="278" x2="360" y2="222" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><line x1="515" y1="278" x2="400" y2="222" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><line x1="680" y1="278" x2="420" y2="222" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,3"/><text x="60" y="258" text-anchor="middle" font-size="8" fill="#6b7280">VPN</text><text x="245" y="258" text-anchor="middle" font-size="8" fill="#6b7280">VPN</text><text x="515" y="258" text-anchor="middle" font-size="8" fill="#6b7280">VPN</text><text x="680" y="258" text-anchor="middle" font-size="8" fill="#6b7280">VPN</text></svg>

<!--
TGWは中央ハブとして機能。複数のVPCアタッチメントと複数のVPN接続（異なる拠点）を1つのTGWで集約管理。すべての通信はTGWを経由する。
-->

---

# TGW VPN Attachment 設定

- <svg viewBox="0 0 760 340" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><text x="380" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#374151">TGW VPN Attachment 作成フロー</text><rect x="10" y="35" width="130" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="75" y="62" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">1. CGW 作成</text><text x="75" y="80" text-anchor="middle" font-size="9" fill="#6b7280">IP / BGP ASN</text><line x1="140" y1="65" x2="168" y2="65" stroke="#374151" stroke-width="1.5"/><polygon points="170,65 162,61 162,69" fill="#374151"/><rect x="170" y="35" width="130" height="60" rx="6" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/><text x="235" y="62" text-anchor="middle" font-size="10" font-weight="bold" fill="#1e40af">2. TGW 作成</text><text x="235" y="80" text-anchor="middle" font-size="9" fill="#374151">BGP ASN 設定</text><line x1="300" y1="65" x2="328" y2="65" stroke="#374151" stroke-width="1.5"/><polygon points="330,65 322,61 322,69" fill="#374151"/><rect x="330" y="35" width="180" height="60" rx="6" fill="#fef9c3" stroke="#eab308" stroke-width="1.5"/><text x="420" y="55" text-anchor="middle" font-size="10" font-weight="bold" fill="#854d0e">3. VPN Connection 作成</text><text x="420" y="73" text-anchor="middle" font-size="9" fill="#374151">Type: Transit Gateway</text><text x="420" y="87" text-anchor="middle" font-size="9" fill="#374151">（VGW ではなく TGW を選択）</text><line x1="510" y1="65" x2="538" y2="65" stroke="#374151" stroke-width="1.5"/><polygon points="540,65 532,61 532,69" fill="#374151"/><rect x="540" y="35" width="205" height="60" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/><text x="642" y="55" text-anchor="middle" font-size="10" font-weight="bold" fill="#15803d">4. オンプレ側ルーター設定</text><text x="642" y="73" text-anchor="middle" font-size="9" fill="#374151">設定ファイルをダウンロード</text><text x="642" y="87" text-anchor="middle" font-size="9" fill="#374151">ルーターへ適用</text><rect x="10" y="130" width="340" height="180" rx="8" fill="#eff6ff" stroke="#3b82f6" stroke-width="1.5"/><text x="180" y="153" text-anchor="middle" font-size="11" font-weight="bold" fill="#1e40af">TGW Route Table 設定</text><rect x="20" y="165" width="320" height="28" rx="4" fill="#dbeafe"/><text x="80" y="183" text-anchor="middle" font-size="10" fill="#1e40af">Destination</text><text x="250" y="183" text-anchor="middle" font-size="10" fill="#1e40af">Target</text><rect x="20" y="198" width="320" height="25" rx="4" fill="#f8fafc"/><text x="80" y="214" text-anchor="middle" font-size="9" fill="#374151">192.168.0.0/16</text><text x="250" y="214" text-anchor="middle" font-size="9" fill="#374151">VPN Attachment</text><rect x="20" y="228" width="320" height="25" rx="4" fill="#f8fafc"/><text x="80" y="244" text-anchor="middle" font-size="9" fill="#374151">10.1.0.0/16</text><text x="250" y="244" text-anchor="middle" font-size="9" fill="#374151">VPC A Attachment</text><rect x="20" y="258" width="320" height="25" rx="4" fill="#f8fafc"/><text x="80" y="274" text-anchor="middle" font-size="9" fill="#374151">10.2.0.0/16</text><text x="250" y="274" text-anchor="middle" font-size="9" fill="#374151">VPC B Attachment</text><rect x="380" y="130" width="365" height="180" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="1.5"/><text x="562" y="153" text-anchor="middle" font-size="11" font-weight="bold" fill="#15803d">VGW vs TGW VPN の違い</text><text x="385" y="178" font-size="10" fill="#374151">  VGW: 1 VPC のみ接続可</text><text x="385" y="198" font-size="10" fill="#374151">  TGW: 複数 VPC + 複数 VPN を集約</text><text x="385" y="218" font-size="10" fill="#374151">  VGW: ECMP 非対応</text><text x="385" y="238" font-size="10" fill="#374151">  TGW: ECMP 対応（帯域集約）</text><text x="385" y="258" font-size="10" fill="#374151">  VGW: 単純な接続に最適</text><text x="385" y="278" font-size="10" fill="#374151">  TGW: エンタープライズ設計に最適</text><text x="385" y="298" font-size="9" fill="#6b7280">  TGW は追加コスト（アタッチメント/hr）</text></svg>

<!--
TGWへのVPN接続は、VPN Connection作成時にTarget OptionsでVGWでなくTGWを選択するだけ。TGW Route Tableでルーティングを制御する。
-->

---

# 集中型 VPN 設計（Centralized Hub）

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="290" y="30" width="180" height="70" rx="8" fill="#fef9c3" stroke="#d97706" stroke-width="3"/><text x="380" y="58" text-anchor="middle" font-size="12" font-weight="bold" fill="#92400e">Transit Gateway</text><text x="380" y="78" text-anchor="middle" font-size="9" fill="#374151">集中型ネットワーク Hub</text><rect x="50" y="170" width="130" height="80" rx="6" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/><text x="115" y="200" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">Network Account</text><text x="115" y="220" text-anchor="middle" font-size="9" fill="#374151">Shared Services VPC</text><text x="115" y="238" text-anchor="middle" font-size="9" fill="#374151">VPN Connections</text><rect x="210" y="170" width="130" height="80" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="275" y="200" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">App Account A</text><text x="275" y="220" text-anchor="middle" font-size="9" fill="#374151">Spoke VPC 1</text><text x="275" y="238" text-anchor="middle" font-size="9" fill="#374151">10.1.0.0/16</text><rect x="370" y="170" width="130" height="80" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="435" y="200" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">App Account B</text><text x="435" y="220" text-anchor="middle" font-size="9" fill="#374151">Spoke VPC 2</text><text x="435" y="238" text-anchor="middle" font-size="9" fill="#374151">10.2.0.0/16</text><rect x="530" y="170" width="130" height="80" rx="6" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/><text x="595" y="200" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e40af">App Account C</text><text x="595" y="220" text-anchor="middle" font-size="9" fill="#374151">Spoke VPC 3</text><text x="595" y="238" text-anchor="middle" font-size="9" fill="#374151">10.3.0.0/16</text><line x1="380" y1="100" x2="115" y2="168" stroke="#374151" stroke-width="1.5"/><line x1="380" y1="100" x2="275" y2="168" stroke="#374151" stroke-width="1.5"/><line x1="380" y1="100" x2="380" y2="168" stroke="#374151" stroke-width="1.5"/><line x1="380" y1="100" x2="595" y2="168" stroke="#374151" stroke-width="1.5"/><polygon points="113,170 121,162 129,168" fill="#374151"/><polygon points="273,170 281,162 283,170" fill="#374151"/><polygon points="380,170 376,162 384,162" fill="#374151"/><polygon points="593,170 601,162 603,170" fill="#374151"/><rect x="10" y="290" width="180" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="100" y="315" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">拠点 1（東京オフィス）</text><text x="100" y="333" text-anchor="middle" font-size="8" fill="#6b7280">VPN → TGW → 全 VPC</text><rect x="290" y="290" width="180" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="380" y="315" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">拠点 2（大阪オフィス）</text><text x="380" y="333" text-anchor="middle" font-size="8" fill="#6b7280">VPN → TGW → 全 VPC</text><rect x="570" y="290" width="180" height="60" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/><text x="660" y="315" text-anchor="middle" font-size="9" font-weight="bold" fill="#374151">Data Center</text><text x="660" y="333" text-anchor="middle" font-size="8" fill="#6b7280">VPN → TGW → 全 VPC</text><line x1="100" y1="288" x2="115" y2="250" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="3,2"/><line x1="380" y1="288" x2="380" y2="250" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="3,2"/><line x1="660" y1="288" x2="595" y2="250" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="3,2"/></svg>

<!--
TGWを使った集中型VPN設計。Network Accountに共有TGWを配置し、各App AccountのVPCをアタッチ。オンプレ拠点のVPN接続はすべてTGWに集約する。
-->

---

# ECMP による帯域集約

- <svg viewBox="0 0 760 360" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;letter-spacing:0"><rect x="10" y="130" width="160" height="100" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/><text x="90" y="165" text-anchor="middle" font-size="11" font-weight="bold" fill="#374151">オンプレ ルーター</text><text x="90" y="185" text-anchor="middle" font-size="10" fill="#374151">AS: 65000</text><text x="90" y="205" text-anchor="middle" font-size="9" fill="#6b7280">4 x VPN Connection</text><rect x="530" y="130" width="220" height="100" rx="8" fill="#fef9c3" stroke="#d97706" stroke-width="3"/><text x="640" y="160" text-anchor="middle" font-size="12" font-weight="bold" fill="#92400e">Transit Gateway</text><text x="640" y="180" text-anchor="middle" font-size="10" fill="#374151">ECMP 有効</text><text x="640" y="200" text-anchor="middle" font-size="9" fill="#374151">Equal Cost Multi-Path</text><text x="640" y="216" text-anchor="middle" font-size="8" fill="#6b7280">同コストのルートを等分割</text><line x1="170" y1="148" x2="528" y2="148" stroke="#3b82f6" stroke-width="2"/><polygon points="530,148 522,144 522,152" fill="#3b82f6"/><text x="350" y="140" text-anchor="middle" font-size="9" fill="#3b82f6">VPN Conn 1 (Tunnel 1: 1.25Gbps)</text><line x1="170" y1="163" x2="528" y2="163" stroke="#22c55e" stroke-width="2"/><polygon points="530,163 522,159 522,167" fill="#22c55e"/><text x="350" y="157" text-anchor="middle" font-size="9" fill="#22c55e">VPN Conn 2 (Tunnel 1: 1.25Gbps)</text><line x1="170" y1="178" x2="528" y2="178" stroke="#a855f7" stroke-width="2"/><polygon points="530,178 522,174 522,182" fill="#a855f7"/><text x="350" y="172" text-anchor="middle" font-size="9" fill="#a855f7">VPN Conn 3 (Tunnel 1: 1.25Gbps)</text><line x1="170" y1="193" x2="528" y2="193" stroke="#ef4444" stroke-width="2"/><polygon points="530,193 522,189 522,197" fill="#ef4444"/><text x="350" y="187" text-anchor="middle" font-size="9" fill="#ef4444">VPN Conn 4 (Tunnel 1: 1.25Gbps)</text><rect x="10" y="270" width="730" height="80" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="1"/><text x="380" y="293" text-anchor="middle" font-size="11" font-weight="bold" fill="#15803d">ECMP 帯域集約の計算</text><text x="380" y="313" text-anchor="middle" font-size="10" fill="#374151">4 VPN 接続 × アクティブトンネル × 1.25Gbps = 最大 5Gbps（Tunnel 1 のみ使用時）</text><text x="380" y="333" text-anchor="middle" font-size="10" fill="#374151">4 VPN 接続 × 両トンネル × 1.25Gbps = 理論最大 10Gbps（BGP で等コスト広報時）</text><text x="380" y="349" text-anchor="middle" font-size="9" fill="#6b7280">TGW の最大スループット上限は 50Gbps。ECMP に必要な条件: BGP 使用 + 同じ AS_PATH 長 + TGW ECMP 有効化</text></svg>

<!--
ECMPはTGWで有効化でき、BGP動的ルーティング使用時のみ機能する。同じAS_PATHの長さの複数経路を等分してトラフィックを分散。帯域は接続数に比例してスケール。
-->

---

# BGP + ECMP スループット最大化

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="32" font-size="16" fill="#e0e0ff" text-anchor="middle" font-weight="bold">BGP + ECMP — VPN スループット最大化</text><rect x="320" y="55" width="140" height="50" rx="8" fill="#4a3080" stroke="#9d71e8" stroke-width="1.5"/><text x="390" y="76" font-size="12" fill="#e0d0ff" text-anchor="middle">オンプレミス Router</text><text x="390" y="94" font-size="11" fill="#c0b0f0" text-anchor="middle">BGP AS 65000</text><line x1="250" y1="130" x2="320" y2="80" stroke="#60a0ff" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="530" y1="130" x2="460" y2="80" stroke="#60ff90" stroke-width="1.5" stroke-dasharray="6,3"/><rect x="160" y="130" width="180" height="55" rx="8" fill="#1a4a7a" stroke="#4a90e2" stroke-width="1.5"/><text x="250" y="153" font-size="12" fill="#80c0ff" text-anchor="middle">Tunnel 1 (1.25 Gbps)</text><text x="250" y="172" font-size="11" fill="#60a0e0" text-anchor="middle">10.0.0.1 ↔ 169.254.0.1</text><rect x="440" y="130" width="180" height="55" rx="8" fill="#1a4a7a" stroke="#4a90e2" stroke-width="1.5"/><text x="530" y="153" font-size="12" fill="#80c0ff" text-anchor="middle">Tunnel 2 (1.25 Gbps)</text><text x="530" y="172" font-size="11" fill="#60a0e0" text-anchor="middle">10.0.0.2 ↔ 169.254.1.1</text><text x="390" y="215" font-size="13" fill="#ffdd60" text-anchor="middle" font-weight="bold">ECMP: 合計 2.5 Gbps (理論値)</text><line x1="250" y1="185" x2="310" y2="250" stroke="#4a90e2" stroke-width="1.5"/><line x1="530" y1="185" x2="470" y2="250" stroke="#4a90e2" stroke-width="1.5"/><rect x="290" y="250" width="200" height="50" rx="8" fill="#2a5a2a" stroke="#5aaa5a" stroke-width="1.5"/><text x="390" y="271" font-size="12" fill="#80ff80" text-anchor="middle">VGW / TGW</text><text x="390" y="290" font-size="11" fill="#60c060" text-anchor="middle">ルートテーブル: 等コスト経路</text><rect x="30" y="320" width="340" height="65" rx="6" fill="#1a2a4a" stroke="#4060a0" stroke-width="1"/><text x="200" y="342" font-size="12" fill="#80a0e0" text-anchor="middle" font-weight="bold">ECMP 有効化の要件</text><text x="40" y="362" font-size="11" fill="#a0b8d8">• 同一ネクストホップへの等コスト BGP 経路</text><text x="40" y="380" font-size="11" fill="#a0b8d8">• TGW: enableEqualCostMultipathRouting = true</text><rect x="410" y="320" width="340" height="65" rx="6" fill="#1a2a4a" stroke="#4060a0" stroke-width="1"/><text x="580" y="342" font-size="12" fill="#80a0e0" text-anchor="middle" font-weight="bold">スループット上限</text><text x="420" y="362" font-size="11" fill="#a0b8d8">• VGW: 1.25 Gbps × 2 tunnel = 2.5 Gbps</text><text x="420" y="380" font-size="11" fill="#a0b8d8">• TGW: 最大 50 VPN × ECMP = 大帯域</text></svg>

<!--
BGPとECMPを組み合わせることで、単一VPN接続の1.25Gbps上限を超えられます。TGWではenableEqualCostMultipathRoutingを有効化し、複数VPN接続を束ねることで大規模帯域を実現します。
-->

---

# TGW ルートテーブル設計パターン

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">TGW ルートテーブル設計パターン</text><rect x="20" y="45" width="360" height="160" rx="8" fill="#12204a" stroke="#4a6090" stroke-width="1.5"/><text x="200" y="68" font-size="13" fill="#60a8ff" text-anchor="middle" font-weight="bold">パターン A: 単一ルートテーブル</text><rect x="40" y="80" width="100" height="40" rx="6" fill="#2a4a7a" stroke="#4a90e2" stroke-width="1"/><text x="90" y="105" font-size="11" fill="#a0c8ff" text-anchor="middle">VPC-A</text><rect x="160" y="80" width="100" height="40" rx="6" fill="#2a4a7a" stroke="#4a90e2" stroke-width="1"/><text x="210" y="105" font-size="11" fill="#a0c8ff" text-anchor="middle">VPC-B</text><rect x="280" y="80" width="80" height="40" rx="6" fill="#4a3080" stroke="#9d71e8" stroke-width="1"/><text x="320" y="105" font-size="11" fill="#c0a0ff" text-anchor="middle">VPN</text><line x1="90" y1="120" x2="90" y2="145" stroke="#4a90e2" stroke-width="1"/><line x1="210" y1="120" x2="210" y2="145" stroke="#4a90e2" stroke-width="1"/><line x1="320" y1="120" x2="320" y2="145" stroke="#9d71e8" stroke-width="1"/><rect x="70" y="145" width="280" height="35" rx="5" fill="#1a3060" stroke="#3a5090" stroke-width="1"/><text x="210" y="168" font-size="11" fill="#80a8e0" text-anchor="middle">共有 Route Table — 全 Attachment</text><text x="200" y="195" font-size="11" fill="#a0b8d8">✓ シンプル  ✗ 分離なし  → 小規模向け</text><rect x="400" y="45" width="360" height="160" rx="8" fill="#12204a" stroke="#4a6090" stroke-width="1.5"/><text x="580" y="68" font-size="13" fill="#60ff90" text-anchor="middle" font-weight="bold">パターン B: 分離型ルートテーブル</text><rect x="420" y="80" width="90" height="40" rx="6" fill="#1a4a7a" stroke="#4a90e2" stroke-width="1"/><text x="465" y="105" font-size="11" fill="#a0c8ff" text-anchor="middle">本番 VPC</text><rect x="530" y="80" width="90" height="40" rx="6" fill="#1a4a7a" stroke="#4a90e2" stroke-width="1"/><text x="575" y="105" font-size="11" fill="#a0c8ff" text-anchor="middle">開発 VPC</text><rect x="640" y="80" width="80" height="40" rx="6" fill="#4a3080" stroke="#9d71e8" stroke-width="1"/><text x="680" y="105" font-size="11" fill="#c0a0ff" text-anchor="middle">VPN</text><line x1="465" y1="120" x2="465" y2="145" stroke="#4a90e2" stroke-width="1"/><line x1="575" y1="120" x2="575" y2="145" stroke="#4a90e2" stroke-width="1"/><line x1="680" y1="120" x2="680" y2="145" stroke="#9d71e8" stroke-width="1"/><rect x="430" y="145" width="110" height="30" rx="4" fill="#1a3060" stroke="#2a6080" stroke-width="1"/><text x="485" y="165" font-size="10" fill="#60c0e0" text-anchor="middle">本番 RT</text><rect x="550" y="145" width="110" height="30" rx="4" fill="#2a4020" stroke="#3a6030" stroke-width="1"/><text x="605" y="165" font-size="10" fill="#60c060" text-anchor="middle">開発 RT</text><text x="580" y="195" font-size="11" fill="#a0b8d8">✓ セグメント分離  ✓ 本番/開発隔離</text><rect x="20" y="220" width="740" height="80" rx="8" fill="#0e1a30" stroke="#3a5090" stroke-width="1"/><text x="390" y="242" font-size="13" fill="#e0e0ff" text-anchor="middle" font-weight="bold">ルートテーブル設定フロー</text><rect x="35" y="255" width="130" height="35" rx="5" fill="#2a4a5a" stroke="#4a8090" stroke-width="1"/><text x="100" y="278" font-size="11" fill="#80c8e0" text-anchor="middle">1. RT 作成</text><polygon points="175,272 185,265 185,279" fill="#6080a0"/><rect x="195" y="255" width="130" height="35" rx="5" fill="#2a4a5a" stroke="#4a8090" stroke-width="1"/><text x="260" y="278" font-size="11" fill="#80c8e0" text-anchor="middle">2. Association</text><polygon points="335,272 345,265 345,279" fill="#6080a0"/><rect x="355" y="255" width="130" height="35" rx="5" fill="#2a4a5a" stroke="#4a8090" stroke-width="1"/><text x="420" y="278" font-size="11" fill="#80c8e0" text-anchor="middle">3. Propagation</text><polygon points="495,272 505,265 505,279" fill="#6080a0"/><rect x="515" y="255" width="130" height="35" rx="5" fill="#2a4a5a" stroke="#4a8090" stroke-width="1"/><text x="580" y="278" font-size="11" fill="#80c8e0" text-anchor="middle">4. Static Route</text><polygon points="655,272 665,265 665,279" fill="#6080a0"/><rect x="670" y="255" width="75" height="35" rx="5" fill="#2a4a5a" stroke="#4a8090" stroke-width="1"/><text x="707" y="278" font-size="11" fill="#80c8e0" text-anchor="middle">5. 確認</text><rect x="20" y="315" width="740" height="70" rx="6" fill="#1a1a1a" stroke="#3a3a5a" stroke-width="1"/><text x="390" y="336" font-size="12" fill="#e0e0e0" text-anchor="middle" font-weight="bold">ルートテーブルのキー概念</text><text x="50" y="358" font-size="11" fill="#a0b8d8">Association: どの Attachment がこの RT を使うか</text><text x="50" y="376" font-size="11" fill="#a0b8d8">Propagation: VPN/DXGW の動的ルートを RT に自動反映</text><text x="430" y="358" font-size="11" fill="#a0b8d8">Static Route: 手動で 0.0.0.0/0 → 共有サービス VPC など</text><text x="430" y="376" font-size="11" fill="#a0b8d8">Blackhole: 特定 CIDR を明示的に Drop</text></svg>

<!--
TGWルートテーブルはAssociation（どのAttachmentがこのRTを使うか）とPropagation（BGP経路を自動反映）の2概念が核心。本番/開発分離など環境ごとにRTを分けるパターンBが推奨です。
-->

---

# TGW VPN vs VGW VPN — 選択基準

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">TGW VPN vs VGW VPN — 選択基準マトリクス</text><rect x="20" y="40" width="370" height="270" rx="8" fill="#12204a" stroke="#4a90e2" stroke-width="2"/><text x="205" y="65" font-size="14" fill="#60a8ff" text-anchor="middle" font-weight="bold">VGW (Virtual Private Gateway)</text><text x="205" y="88" font-size="12" fill="#a0c0f0" text-anchor="middle">単一 VPC に直接アタッチ</text><rect x="35" y="100" width="340" height="195" rx="6" fill="#0e1a38" stroke="#3a6090" stroke-width="1"/><text x="50" y="122" font-size="12" fill="#60d0a0" font-weight="bold">✓ 向いているケース</text><text x="50" y="143" font-size="11" fill="#a0c8b8">• 接続する VPC が 1〜3 個</text><text x="50" y="163" font-size="11" fill="#a0c8b8">• シンプルな Hub-Spoke 不要</text><text x="50" y="183" font-size="11" fill="#a0c8b8">• コスト優先（TGW 時間料金なし）</text><text x="50" y="203" font-size="11" fill="#a0c8b8">• VPC 間トラフィックが少ない</text><text x="50" y="230" font-size="12" fill="#ff8080" font-weight="bold">✗ 苦手なケース</text><text x="50" y="251" font-size="11" fill="#d0a0a0">• VPC 数が多い（全 VPC に VGW 必要）</text><text x="50" y="271" font-size="11" fill="#d0a0a0">• 複数 VPC 間の通信が必要</text><rect x="400" y="40" width="370" height="270" rx="8" fill="#1a2012" stroke="#5aaa3a" stroke-width="2"/><text x="585" y="65" font-size="14" fill="#80e060" text-anchor="middle" font-weight="bold">TGW (Transit Gateway)</text><text x="585" y="88" font-size="12" fill="#a0c880" text-anchor="middle">VPC・VPN・DX を集中管理</text><rect x="415" y="100" width="340" height="195" rx="6" fill="#121e0a" stroke="#3a5030" stroke-width="1"/><text x="430" y="122" font-size="12" fill="#60d0a0" font-weight="bold">✓ 向いているケース</text><text x="430" y="143" font-size="11" fill="#a0c8b8">• VPC が 4 個以上</text><text x="430" y="163" font-size="11" fill="#a0c8b8">• VPC 間通信が多い</text><text x="430" y="183" font-size="11" fill="#a0c8b8">• マルチアカウント/マルチリージョン</text><text x="430" y="203" font-size="11" fill="#a0c8b8">• 集中型セキュリティ検査が必要</text><text x="430" y="230" font-size="12" fill="#ff8080" font-weight="bold">✗ 苦手なケース</text><text x="430" y="251" font-size="11" fill="#d0a0a0">• 小規模 (VGW の方が安い)</text><text x="430" y="271" font-size="11" fill="#d0a0a0">• 単純 VPN のみ</text><rect x="20" y="325" width="740" height="60" rx="6" fill="#1a1a2e" stroke="#4a4a6a" stroke-width="1"/><text x="390" y="345" font-size="12" fill="#e0e0ff" text-anchor="middle" font-weight="bold">コスト比較 (東京リージョン目安)</text><text x="100" y="366" font-size="11" fill="#a0b8d8" text-anchor="middle">VGW: $0.05/h</text><text x="100" y="381" font-size="11" fill="#a0b8d8" text-anchor="middle">+ データ転送</text><text x="320" y="366" font-size="11" fill="#a0b8d8" text-anchor="middle">TGW: $0.07/h (本体)</text><text x="320" y="381" font-size="11" fill="#a0b8d8" text-anchor="middle">+ $0.05/GB データ処理</text><text x="550" y="366" font-size="11" fill="#ffd070" text-anchor="middle">VPC 3個超: TGW が</text><text x="550" y="381" font-size="11" fill="#ffd070" text-anchor="middle">トータルコスト有利になる傾向</text><text x="700" y="366" font-size="11" fill="#a0c8a0" text-anchor="middle">VPN 接続料:</text><text x="700" y="381" font-size="11" fill="#a0c8a0" text-anchor="middle">両者 $0.05/h 共通</text></svg>

<!--
VGWは単一VPC直結でシンプル・低コスト。TGWはVPC数が多くなるほど管理効率が上がりコスト面でも有利になります。分岐点はおおよそVPC 3〜4個です。
-->

---

<!-- _class: lead -->
# Section 5: VPN CloudHub

- 複数オンプレミスサイトをAWS VGWでハブとして接続
- VPN CloudHub — Hub-and-Spoke VPN

<!--
VPN CloudHubはAWSを経由して複数の拠点間を接続するHub-and-Spoke型のVPNアーキテクチャです。
-->

---

# VPN CloudHub — Hub-and-Spoke 構成図

- <svg viewBox="0 0 780 410" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="410" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">VPN CloudHub — Hub-and-Spoke アーキテクチャ</text><rect x="310" y="155" width="160" height="70" rx="10" fill="#1a4060" stroke="#4a90c0" stroke-width="2"/><text x="390" y="182" font-size="13" fill="#80d0ff" text-anchor="middle" font-weight="bold">AWS VGW</text><text x="390" y="200" font-size="11" fill="#60a8e0" text-anchor="middle">Hub (BGP)</text><text x="390" y="216" font-size="10" fill="#508090" text-anchor="middle">ASN: 64512</text><rect x="20" y="55" width="130" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="85" y="78" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">東京本社</text><text x="85" y="96" font-size="10" fill="#8090d0" text-anchor="middle">10.0.0.0/24</text><text x="85" y="110" font-size="10" fill="#8090d0" text-anchor="middle">BGP AS 65001</text><rect x="20" y="175" width="130" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="85" y="198" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">大阪支社</text><text x="85" y="216" font-size="10" fill="#8090d0" text-anchor="middle">10.1.0.0/24</text><text x="85" y="230" font-size="10" fill="#8090d0" text-anchor="middle">BGP AS 65002</text><rect x="20" y="295" width="130" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="85" y="318" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">福岡拠点</text><text x="85" y="336" font-size="10" fill="#8090d0" text-anchor="middle">10.2.0.0/24</text><text x="85" y="350" font-size="10" fill="#8090d0" text-anchor="middle">BGP AS 65003</text><rect x="630" y="55" width="130" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="695" y="78" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">名古屋拠点</text><text x="695" y="96" font-size="10" fill="#8090d0" text-anchor="middle">10.3.0.0/24</text><text x="695" y="110" font-size="10" fill="#8090d0" text-anchor="middle">BGP AS 65004</text><rect x="630" y="295" width="130" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="695" y="318" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">海外拠点</text><text x="695" y="336" font-size="10" fill="#8090d0" text-anchor="middle">192.168.0.0/24</text><text x="695" y="350" font-size="10" fill="#8090d0" text-anchor="middle">BGP AS 65005</text><line x1="150" y1="82" x2="310" y2="175" stroke="#6080c0" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="150" y1="202" x2="310" y2="195" stroke="#6080c0" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="150" y1="322" x2="310" y2="215" stroke="#6080c0" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="630" y1="82" x2="470" y2="175" stroke="#6080c0" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="630" y1="322" x2="470" y2="215" stroke="#6080c0" stroke-width="1.5" stroke-dasharray="6,3"/><text x="230" y="130" font-size="10" fill="#6090c0" text-anchor="middle">IPsec VPN</text><text x="230" y="195" font-size="10" fill="#6090c0" text-anchor="middle">IPsec VPN</text><text x="230" y="270" font-size="10" fill="#6090c0" text-anchor="middle">IPsec VPN</text><text x="555" y="130" font-size="10" fill="#6090c0" text-anchor="middle">IPsec VPN</text><text x="555" y="270" font-size="10" fill="#6090c0" text-anchor="middle">IPsec VPN</text><rect x="20" y="370" width="740" height="35" rx="5" fill="#0e1a38" stroke="#3a5080" stroke-width="1"/><text x="40" y="388" font-size="11" fill="#a0b8d8">要件: 各拠点が異なる BGP ASN を持つ</text><text x="40" y="401" font-size="10" fill="#6080a8">　 VGW が各拠点の経路を受信・再広報 → 拠点間通信を仲介</text><text x="430" y="388" font-size="11" fill="#a0b8d8">コスト: VPN 接続数 × $0.05/h</text><text x="430" y="401" font-size="10" fill="#6080a8">　 データ転送: $0.09/GB (インターネット出口)</text></svg>

<!--
VPN CloudHubはAWS VGWをハブとして、各拠点がスポークとして接続します。各拠点は異なるBGP ASNが必要で、VGWが経路を再広報することで拠点間通信を実現します。専用線より安価なWAN代替として有効です。
-->

---

# VPN CloudHub — マルチサイト接続ユースケース

- <svg viewBox="0 0 780 380" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="380" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">VPN CloudHub ユースケースと制約</text><rect x="20" y="45" width="360" height="150" rx="8" fill="#12204a" stroke="#4a90e2" stroke-width="1.5"/><text x="200" y="68" font-size="13" fill="#60a8ff" text-anchor="middle" font-weight="bold">主なユースケース</text><text x="35" y="92" font-size="12" fill="#80d0ff">1. WAN 代替</text><text x="35" y="112" font-size="11" fill="#a0b8d8">   MPLS/専用線の代わりに低コスト VPN で拠点接続</text><text x="35" y="135" font-size="12" fill="#80d0ff">2. バックアップ回線</text><text x="35" y="155" font-size="11" fill="#a0b8d8">   DX のフェイルオーバーとして VPN CloudHub を併用</text><text x="35" y="178" font-size="12" fill="#80d0ff">3. 小規模マルチサイト展開</text><rect x="400" y="45" width="360" height="150" rx="8" fill="#1a2a1a" stroke="#5a9a4a" stroke-width="1.5"/><text x="580" y="68" font-size="13" fill="#80e060" text-anchor="middle" font-weight="bold">制約・注意点</text><text x="415" y="92" font-size="11" fill="#a0c888">• 帯域上限: 1.25 Gbps/トンネル (VGW 共有)</text><text x="415" y="115" font-size="11" fill="#a0c888">• 最大 10 VPN 接続/VGW</text><text x="415" y="138" font-size="11" fill="#a0c888">• 拠点間トラフィックは AWS を経由する</text><text x="415" y="161" font-size="11" fill="#a0c888">• BGP 必須 (Static では動作しない)</text><text x="415" y="184" font-size="11" fill="#a0c888">• 各 CGW は一意の BGP ASN が必要</text><rect x="20" y="210" width="740" height="70" rx="8" fill="#1a2a4a" stroke="#4a6090" stroke-width="1"/><text x="390" y="232" font-size="13" fill="#e0e0ff" text-anchor="middle" font-weight="bold">VPN CloudHub vs TGW の使い分け</text><rect x="35" y="245" width="340" height="25" rx="4" fill="#1a3050" stroke="#3a5070" stroke-width="1"/><text x="205" y="263" font-size="11" fill="#80a8d8" text-anchor="middle">CloudHub: 拠点数 ≤10, 低コスト重視, VPC 間通信不要</text><rect x="400" y="245" width="340" height="25" rx="4" fill="#1a3050" stroke="#3a5070" stroke-width="1"/><text x="570" y="263" font-size="11" fill="#80a8d8" text-anchor="middle">TGW: 拠点数多い, VPC 間通信あり, マルチアカウント</text><rect x="20" y="295" width="740" height="70" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="390" y="315" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">設定のポイント</text><text x="40" y="338" font-size="11" fill="#a0b0d0">• 各 Site の CGW を同一 VGW に接続し BGP セッション確立</text><text x="40" y="358" font-size="11" fill="#a0b0d0">• VGW の Route Propagation を有効化 → 各 VPC のルートテーブルへ自動反映</text><text x="430" y="338" font-size="11" fill="#a0b0d0">• Summary Route (スーパーネット) で広報経路を集約</text><text x="430" y="358" font-size="11" fill="#a0b0d0">• CloudWatch: TunnelState メトリクスで監視</text></svg>

<!--
VPN CloudHubは拠点数が10以下で低コストなWAN代替として有効です。BGPが必須で各CGWは異なるASNが必要。大規模や複数VPC間通信が必要な場合はTGWへの移行を検討します。
-->

---

<!-- _class: lead -->
# Section 6: Direct Connect + VPN 組み合わせ

- AWS Direct Connect との VPN 併用パターン
- 暗号化・冗長化・フェイルオーバー設計

<!--
Direct ConnectとVPNを組み合わせることで、暗号化と冗長化を同時に実現できます。
-->

---

# Direct Connect + VPN 暗号化アーキテクチャ

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">DX + VPN 暗号化アーキテクチャ</text><rect x="30" y="45" width="150" height="80" rx="8" fill="#2a304a" stroke="#6060c0" stroke-width="1.5"/><text x="105" y="70" font-size="12" fill="#a0b0f0" text-anchor="middle" font-weight="bold">オンプレミス</text><text x="105" y="90" font-size="11" fill="#8090d0" text-anchor="middle">IPsec 対応</text><text x="105" y="108" font-size="11" fill="#8090d0" text-anchor="middle">ルーター/FW</text><rect x="220" y="45" width="150" height="80" rx="8" fill="#1a2040" stroke="#4060a0" stroke-width="1.5"/><text x="295" y="70" font-size="12" fill="#6080d0" text-anchor="middle" font-weight="bold">AWS Direct</text><text x="295" y="88" font-size="12" fill="#6080d0" text-anchor="middle">Connect</text><text x="295" y="108" font-size="10" fill="#4060a0" text-anchor="middle">Private VIF</text><line x1="180" y1="85" x2="220" y2="85" stroke="#4060a0" stroke-width="2"/><text x="200" y="78" font-size="10" fill="#6080a0" text-anchor="middle">専用線</text><rect x="410" y="45" width="150" height="80" rx="8" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="485" y="70" font-size="12" fill="#80c0e0" text-anchor="middle" font-weight="bold">VGW / TGW</text><text x="485" y="90" font-size="11" fill="#60a0c0" text-anchor="middle">IPsec Tunnel</text><text x="485" y="108" font-size="11" fill="#60a0c0" text-anchor="middle">over DX</text><line x1="370" y1="85" x2="410" y2="85" stroke="#3a7090" stroke-width="2"/><text x="390" y="78" font-size="10" fill="#5080a0" text-anchor="middle">IPsec</text><rect x="600" y="45" width="150" height="80" rx="8" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="675" y="78" font-size="12" fill="#80c060" text-anchor="middle" font-weight="bold">VPC</text><text x="675" y="96" font-size="11" fill="#60a040" text-anchor="middle">プライベート</text><text x="675" y="112" font-size="11" fill="#60a040" text-anchor="middle">サブネット</text><line x1="560" y1="85" x2="600" y2="85" stroke="#3a6030" stroke-width="2"/><rect x="30" y="155" width="720" height="80" rx="8" fill="#12204a" stroke="#3a5090" stroke-width="1"/><text x="390" y="178" font-size="13" fill="#80a8e0" text-anchor="middle" font-weight="bold">なぜ DX 上に VPN を重ねるのか</text><text x="50" y="202" font-size="12" fill="#60d0a0">1. 暗号化</text><text x="50" y="222" font-size="11" fill="#a0c8a8">   DX は暗号化なし → 規制要件 (金融・医療) での必須対応</text><text x="390" y="202" font-size="12" fill="#60d0a0">2. 完全性</text><text x="390" y="222" font-size="11" fill="#a0c8a8">   IPsec が改ざん検知 (HMAC) を提供</text><rect x="30" y="250" width="720" height="60" rx="6" fill="#0e1a38" stroke="#3a4a80" stroke-width="1"/><text x="390" y="270" font-size="12" fill="#e0e0ff" text-anchor="middle" font-weight="bold">2 つの実装パターン</text><rect x="45" y="282" width="320" height="22" rx="4" fill="#1a2a50" stroke="#3a4a70" stroke-width="1"/><text x="205" y="298" font-size="11" fill="#80a8d8" text-anchor="middle">Private VIF + VGW/TGW + IPsec (推奨)</text><rect x="410" y="282" width="320" height="22" rx="4" fill="#1a2a50" stroke="#3a4a70" stroke-width="1"/><text x="570" y="298" font-size="11" fill="#80a8d8" text-anchor="middle">Public VIF + Site-to-Site VPN (別パターン)</text><rect x="30" y="325" width="720" height="65" rx="6" fill="#1a1a2e" stroke="#3a3a5a" stroke-width="1"/><text x="390" y="345" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">注意点とトレードオフ</text><text x="50" y="368" font-size="11" fill="#a0b0d0">• DX 帯域が VPN スループット上限より大きい場合、IPsec が ボトルネック (1.25 Gbps/tunnel)</text><text x="50" y="385" font-size="11" fill="#a0b0d0">• ECMP 構成で複数 VPN トンネルを並列にすると制限を緩和可能</text></svg>

<!--
DX上にIPsec VPNを重ねることで暗号化なしのDXの弱点を補います。金融・医療など規制業種では必須パターンです。ただしIPsecのトンネル帯域上限がボトルネックになりうるため、ECMP構成を検討します。
-->

---

# DX Public VIF + Site-to-Site VPN

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">DX Public VIF + Site-to-Site VPN</text><rect x="30" y="50" width="140" height="70" rx="8" fill="#2a304a" stroke="#6060c0" stroke-width="1.5"/><text x="100" y="78" font-size="12" fill="#a0b0f0" text-anchor="middle" font-weight="bold">オンプレミス</text><text x="100" y="98" font-size="11" fill="#8090d0" text-anchor="middle">CGW</text><text x="100" y="113" font-size="10" fill="#6070b0" text-anchor="middle">BGP AS 65001</text><rect x="230" y="50" width="140" height="70" rx="8" fill="#1a2040" stroke="#4060a0" stroke-width="1.5"/><text x="300" y="72" font-size="11" fill="#6080d0" text-anchor="middle" font-weight="bold">DX Public VIF</text><text x="300" y="92" font-size="10" fill="#4060a0" text-anchor="middle">AWS Public IP</text><text x="300" y="110" font-size="10" fill="#4060a0" text-anchor="middle">へのアクセス</text><line x1="170" y1="85" x2="230" y2="85" stroke="#4060a0" stroke-width="2"/><text x="200" y="78" font-size="10" fill="#6080a0" text-anchor="middle">専用線</text><rect x="430" y="50" width="140" height="70" rx="8" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="500" y="72" font-size="11" fill="#80c0e0" text-anchor="middle" font-weight="bold">VGW / TGW</text><text x="500" y="92" font-size="10" fill="#60a0c0" text-anchor="middle">Public Endpoint</text><text x="500" y="110" font-size="10" fill="#60a0c0" text-anchor="middle">169.254.x.x</text><line x1="370" y1="85" x2="430" y2="85" stroke="#60c0e0" stroke-width="2" stroke-dasharray="8,4"/><text x="400" y="75" font-size="10" fill="#60a8c0" text-anchor="middle">IPsec VPN</text><rect x="630" y="50" width="120" height="70" rx="8" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="690" y="85" font-size="12" fill="#80c060" text-anchor="middle" font-weight="bold">VPC</text><line x1="570" y1="85" x2="630" y2="85" stroke="#3a6030" stroke-width="2"/><rect x="30" y="148" width="720" height="70" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="390" y="170" font-size="13" fill="#80a8e0" text-anchor="middle" font-weight="bold">Public VIF を経由する仕組み</text><text x="50" y="193" font-size="11" fill="#a0b8d8">1. DX Public VIF は AWS の Public サービス (S3, DynamoDB, VPN エンドポイント等) へ接続</text><text x="50" y="213" font-size="11" fill="#a0b8d8">2. VPN の Public Endpoint (169.254.x.x) は AWS Global Network 上の Public IP として到達可能</text><rect x="30" y="235" width="340" height="80" rx="6" fill="#12204a" stroke="#3a5090" stroke-width="1"/><text x="200" y="258" font-size="12" fill="#60a8ff" text-anchor="middle" font-weight="bold">メリット</text><text x="45" y="278" font-size="11" fill="#a0b8d8">• DX の安定帯域 + IPsec 暗号化</text><text x="45" y="298" font-size="11" fill="#a0b8d8">• インターネットを経由しない</text><text x="45" y="308" font-size="10" fill="#808090">(Public VIF は AWS 内に閉じる)</text><rect x="410" y="235" width="340" height="80" rx="6" fill="#1a1a2a" stroke="#3a3a5a" stroke-width="1"/><text x="580" y="258" font-size="12" fill="#ff8080" text-anchor="middle" font-weight="bold">デメリット</text><text x="425" y="278" font-size="11" fill="#c0a0a0">• VPN スループット上限 1.25 Gbps</text><text x="425" y="298" font-size="11" fill="#c0a0a0">• BGP 設定が複雑 (VIF + VPN)</text><text x="425" y="315" font-size="11" fill="#c0a0a0">• Private VIF パターンより一般的でない</text><rect x="30" y="330" width="720" height="55" rx="5" fill="#0e1a38" stroke="#3a4a70" stroke-width="1"/><text x="390" y="352" font-size="11" fill="#a0b8d8" text-anchor="middle">使いどころ: DX Private VIF が使えない環境で暗号化が必要な場合</text><text x="390" y="372" font-size="11" fill="#a0b8d8" text-anchor="middle">例: 既存 DX 接続を活用しつつ暗号化要件を後から追加するケース</text></svg>

<!--
DX Public VIFを経由してVPNエンドポイントに接続するパターンです。Public VIFはAWSのパブリックサービスへの接続に使われ、VPNのパブリックエンドポイントにもアクセスできます。インターネットを経由しない点がメリットです。
-->

---

# DX バックアップとしての VPN フェイルオーバー

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">DX + VPN フェイルオーバー設計</text><rect x="30" y="50" width="130" height="60" rx="8" fill="#2a304a" stroke="#6060c0" stroke-width="1.5"/><text x="95" y="77" font-size="12" fill="#a0b0f0" text-anchor="middle" font-weight="bold">オンプレミス</text><text x="95" y="97" font-size="11" fill="#8090d0" text-anchor="middle">CGW (BGP)</text><rect x="330" y="50" width="120" height="60" rx="8" fill="#1a4060" stroke="#4a90c0" stroke-width="2"/><text x="390" y="78" font-size="12" fill="#80c0e0" text-anchor="middle" font-weight="bold">VGW</text><text x="390" y="96" font-size="11" fill="#60a0c0" text-anchor="middle">/ TGW</text><rect x="600" y="50" width="140" height="60" rx="8" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="670" y="85" font-size="12" fill="#80c060" text-anchor="middle" font-weight="bold">VPC</text><line x1="460" y1="80" x2="600" y2="80" stroke="#3a6030" stroke-width="1.5"/><line x1="160" y1="65" x2="330" y2="65" stroke="#4a8090" stroke-width="3"/><text x="245" y="55" font-size="11" fill="#80c0d0" text-anchor="middle" font-weight="bold">DX (Primary)</text><text x="245" y="72" font-size="10" fill="#60a0b0" text-anchor="middle">高優先度 BGP</text><line x1="160" y1="93" x2="330" y2="93" stroke="#808040" stroke-width="1.5" stroke-dasharray="8,4"/><text x="245" y="106" font-size="11" fill="#c0c050" text-anchor="middle">VPN (Backup)</text><text x="245" y="119" font-size="10" fill="#a0a030" text-anchor="middle">低優先度 BGP</text><rect x="30" y="145" width="720" height="90" rx="8" fill="#12204a" stroke="#3a5090" stroke-width="1"/><text x="390" y="168" font-size="13" fill="#80a8e0" text-anchor="middle" font-weight="bold">BGP による自動フェイルオーバー制御</text><rect x="50" y="182" width="300" height="44" rx="5" fill="#1a3050" stroke="#3a5080" stroke-width="1"/><text x="200" y="200" font-size="11" fill="#80a8d8" text-anchor="middle" font-weight="bold">DX 優先設定 (オンプレ側)</text><text x="200" y="220" font-size="10" fill="#6080b0" text-anchor="middle">MED 値: DX=100, VPN=200 (小さい方が優先)</text><rect x="420" y="182" width="300" height="44" rx="5" fill="#1a3050" stroke="#3a5080" stroke-width="1"/><text x="570" y="200" font-size="11" fill="#80a8d8" text-anchor="middle" font-weight="bold">AWS 側 (VGW)</text><text x="570" y="220" font-size="10" fill="#6080b0" text-anchor="middle">AS PATH: DX 短い → 優先  / VPN 長い → フォールバック</text><rect x="30" y="250" width="720" height="70" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="390" y="272" font-size="12" fill="#e0e0ff" text-anchor="middle" font-weight="bold">フェイルオーバーシナリオ</text><text x="50" y="296" font-size="11" fill="#a0b8d8">①正常時: DX 経由で通信 (高帯域・低遅延)</text><text x="50" y="314" font-size="11" fill="#a0b8d8">②DX 障害: BGP ルート消失 → VPN の BGP 経路が自動的にアクティブ化</text><text x="430" y="296" font-size="11" fill="#a0b8d8">③VPN 経路帯域: 1.25 Gbps (一時的に低下を許容)</text><text x="430" y="314" font-size="11" fill="#a0b8d8">④DX 復旧: BGP 再確立 → DX 経路が再び優先</text><rect x="30" y="335" width="720" height="55" rx="5" fill="#1a1a2e" stroke="#3a3a5a" stroke-width="1"/><text x="390" y="355" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">監視推奨メトリクス</text><text x="50" y="377" font-size="11" fill="#a0b0d0">DX: ConnectionState / VirtualInterfaceState  |  VPN: TunnelState / TunnelDataIn / TunnelDataOut</text></svg>

<!--
DXをプライマリ、VPNをバックアップとするフェイルオーバー構成です。BGPのMED値とAS PATH長で優先度を制御します。DX障害時はBGPルートが自動消失し、VPN経路が自動アクティブ化されます。
-->

---

# DX vs VPN — コスト・性能・信頼性比較

- <svg viewBox="0 0 780 390" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="390" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">Direct Connect vs VPN — 比較マトリクス</text><rect x="20" y="42" width="740" height="30" rx="5" fill="#2a3060" stroke="#4a6090" stroke-width="1"/><text x="200" y="63" font-size="12" fill="#a0b8f0" text-anchor="middle" font-weight="bold">比較項目</text><text x="430" y="63" font-size="12" fill="#60a8ff" text-anchor="middle" font-weight="bold">Direct Connect</text><text x="650" y="63" font-size="12" fill="#80e060" text-anchor="middle" font-weight="bold">Site-to-Site VPN</text><rect x="20" y="75" width="740" height="28" rx="0" fill="#12203a"/><text x="200" y="94" font-size="11" fill="#c0c8e0" text-anchor="middle">帯域</text><text x="430" y="94" font-size="11" fill="#80c0ff" text-anchor="middle">1 Gbps / 10 Gbps / 100 Gbps</text><text x="650" y="94" font-size="11" fill="#a0d888" text-anchor="middle">最大 1.25 Gbps/トンネル</text><rect x="20" y="103" width="740" height="28" rx="0" fill="#0e1a30"/><text x="200" y="122" font-size="11" fill="#c0c8e0" text-anchor="middle">レイテンシ</text><text x="430" y="122" font-size="11" fill="#80c0ff" text-anchor="middle">一貫した低遅延 (専用回線)</text><text x="650" y="122" font-size="11" fill="#a0d888" text-anchor="middle">変動あり (インターネット品質依存)</text><rect x="20" y="131" width="740" height="28" rx="0" fill="#12203a"/><text x="200" y="150" font-size="11" fill="#c0c8e0" text-anchor="middle">暗号化</text><text x="430" y="150" font-size="11" fill="#ffaa60" text-anchor="middle">なし (MACsec オプション)</text><text x="650" y="150" font-size="11" fill="#80ff80" text-anchor="middle">標準 IPsec (AES-256 等)</text><rect x="20" y="159" width="740" height="28" rx="0" fill="#0e1a30"/><text x="200" y="178" font-size="11" fill="#c0c8e0" text-anchor="middle">コスト (初期)</text><text x="430" y="178" font-size="11" fill="#ffaa60" text-anchor="middle">高い (回線工事・ポート料)</text><text x="650" y="178" font-size="11" fill="#80ff80" text-anchor="middle">ほぼなし (設定のみ)</text><rect x="20" y="187" width="740" height="28" rx="0" fill="#12203a"/><text x="200" y="206" font-size="11" fill="#c0c8e0" text-anchor="middle">コスト (月額)</text><text x="430" y="206" font-size="11" fill="#a0b8d8" text-anchor="middle">ポート料 + データ転送 (高)</text><text x="650" y="206" font-size="11" fill="#a0b8d8" text-anchor="middle">VGW $0.05/h + 接続 $0.05/h</text><rect x="20" y="215" width="740" height="28" rx="0" fill="#0e1a30"/><text x="200" y="234" font-size="11" fill="#c0c8e0" text-anchor="middle">SLA / 可用性</text><text x="430" y="234" font-size="11" fill="#80c0ff" text-anchor="middle">99.99% (冗長 DX 構成)</text><text x="650" y="234" font-size="11" fill="#a0d888" text-anchor="middle">99.95% (デュアルトンネル)</text><rect x="20" y="243" width="740" height="28" rx="0" fill="#12203a"/><text x="200" y="262" font-size="11" fill="#c0c8e0" text-anchor="middle">セットアップ期間</text><text x="430" y="262" font-size="11" fill="#ffaa60" text-anchor="middle">数週間〜数ヶ月 (回線手配)</text><text x="650" y="262" font-size="11" fill="#80ff80" text-anchor="middle">数分〜数時間 (即時利用可)</text><rect x="20" y="285" width="740" height="95" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="390" y="308" font-size="13" fill="#e0e0ff" text-anchor="middle" font-weight="bold">選択ガイドライン</text><text x="40" y="330" font-size="11" fill="#60d0a0">DX 向き:</text><text x="110" y="330" font-size="11" fill="#a0b8d8">大容量転送 (&gt;1Gbps)、低遅延SLA、規制業種 (暗号化不要または MACsec)、長期安定運用</text><text x="40" y="352" font-size="11" fill="#60d0a0">VPN 向き:</text><text x="110" y="352" font-size="11" fill="#a0b8d8">即時接続、コスト優先、一時的接続、暗号化必須、中小規模帯域 (&lt;1Gbps)</text><text x="40" y="372" font-size="11" fill="#ffd070">両方使う:</text><text x="110" y="372" font-size="11" fill="#a0b8d8">DX (プライマリ) + VPN (バックアップ/暗号化レイヤー) の組み合わせが最強</text></svg>

<!--
DXは高帯域・低遅延・SLAが強み、VPNはコスト・即時性・暗号化が強みです。実務では両方を組み合わせるハイブリッド構成が最も一般的で推奨されます。
-->

---

<!-- _class: lead -->
# Section 7: 高可用性 VPN 設計パターン

- Active-Active / Active-Standby の冗長化
- 障害シナリオと自動フェイルオーバー

<!--
VPNの高可用性設計では、Active-ActiveとActive-Standbyの2つの主要パターンがあります。
-->

---

# Active-Active vs Active-Standby 設計比較

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">Active-Active vs Active-Standby</text><rect x="20" y="45" width="355" height="245" rx="8" fill="#12204a" stroke="#4a90e2" stroke-width="2"/><text x="197" y="68" font-size="13" fill="#60a8ff" text-anchor="middle" font-weight="bold">Active-Active (ECMP)</text><rect x="35" y="80" width="100" height="45" rx="6" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="85" y="98" font-size="11" fill="#80c0e0" text-anchor="middle">Tunnel 1</text><text x="85" y="115" font-size="10" fill="#60a0c0" text-anchor="middle">ACTIVE ●</text><rect x="145" y="80" width="100" height="45" rx="6" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="195" y="98" font-size="11" fill="#80c0e0" text-anchor="middle">Tunnel 2</text><text x="195" y="115" font-size="10" fill="#60a0c0" text-anchor="middle">ACTIVE ●</text><rect x="255" y="80" width="100" height="45" rx="6" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="305" y="98" font-size="11" fill="#80c0e0" text-anchor="middle">Tunnel 3</text><text x="305" y="115" font-size="10" fill="#60a0c0" text-anchor="middle">ACTIVE ●</text><line x1="85" y1="125" x2="155" y2="165" stroke="#4a90e2" stroke-width="1.5"/><line x1="195" y1="125" x2="195" y2="165" stroke="#4a90e2" stroke-width="1.5"/><line x1="305" y1="125" x2="235" y2="165" stroke="#4a90e2" stroke-width="1.5"/><rect x="140" y="165" width="110" height="40" rx="6" fill="#2a5a2a" stroke="#5aaa5a" stroke-width="1.5"/><text x="195" y="183" font-size="11" fill="#80e080" text-anchor="middle">TGW / VGW</text><text x="195" y="200" font-size="10" fill="#60c060" text-anchor="middle">ECMP 分散</text><text x="197" y="230" font-size="11" fill="#60d0a0" text-anchor="middle">✓ 全トンネルが同時利用</text><text x="197" y="250" font-size="11" fill="#60d0a0" text-anchor="middle">✓ 最大スループット</text><text x="197" y="270" font-size="11" fill="#60d0a0" text-anchor="middle">✓ 即時フェイルオーバー</text><text x="197" y="288" font-size="11" fill="#ff8060" text-anchor="middle">✗ BGP 設定が複雑</text><rect x="405" y="45" width="355" height="245" rx="8" fill="#1a2a1a" stroke="#5aaa3a" stroke-width="2"/><text x="582" y="68" font-size="13" fill="#80e060" text-anchor="middle" font-weight="bold">Active-Standby (Primary/Backup)</text><rect x="420" y="80" width="100" height="45" rx="6" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="470" y="98" font-size="11" fill="#80c0e0" text-anchor="middle">Tunnel 1</text><text x="470" y="115" font-size="10" fill="#60d060" text-anchor="middle">PRIMARY ●</text><rect x="620" y="80" width="100" height="45" rx="6" fill="#3a3a3a" stroke="#6a6a6a" stroke-width="1.5"/><text x="670" y="98" font-size="11" fill="#a0a0a0" text-anchor="middle">Tunnel 2</text><text x="670" y="115" font-size="10" fill="#909090" text-anchor="middle">STANDBY ○</text><line x1="470" y1="125" x2="540" y2="165" stroke="#4a90e2" stroke-width="2"/><line x1="670" y1="125" x2="620" y2="165" stroke="#606060" stroke-width="1.5" stroke-dasharray="6,3"/><rect x="500" y="165" width="110" height="40" rx="6" fill="#2a5a2a" stroke="#5aaa5a" stroke-width="1.5"/><text x="555" y="183" font-size="11" fill="#80e080" text-anchor="middle">VGW / TGW</text><text x="555" y="200" font-size="10" fill="#60c060" text-anchor="middle">単一経路</text><text x="582" y="230" font-size="11" fill="#60d0a0" text-anchor="middle">✓ 設定シンプル</text><text x="582" y="250" font-size="11" fill="#60d0a0" text-anchor="middle">✓ BGP 不要 (Static 可)</text><text x="582" y="270" font-size="11" fill="#ff8060" text-anchor="middle">✗ 待機トンネルは未使用</text><text x="582" y="288" font-size="11" fill="#ff8060" text-anchor="middle">✗ フェイルオーバーに数十秒</text><rect x="20" y="305" width="740" height="80" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="390" y="326" font-size="12" fill="#e0e0ff" text-anchor="middle" font-weight="bold">フェイルオーバー時間の目安</text><rect x="35" y="338" width="320" height="38" rx="4" fill="#1a2a50" stroke="#3a4a80" stroke-width="1"/><text x="195" y="354" font-size="11" fill="#80a8d8" text-anchor="middle">Active-Active: ほぼ瞬時 (既存接続の再ルーティング)</text><text x="195" y="371" font-size="10" fill="#6080a0" text-anchor="middle">DPD (Dead Peer Detection) + BGP Hold Timer 依存</text><rect x="420" y="338" width="320" height="38" rx="4" fill="#1a2a50" stroke="#3a4a80" stroke-width="1"/><text x="580" y="354" font-size="11" fill="#80a8d8" text-anchor="middle">Active-Standby: 数十秒〜1分 (BGP 再確立)</text><text x="580" y="371" font-size="10" fill="#6080a0" text-anchor="middle">BGP Timer 最適化 (Keepalive 10s / Hold 30s)</text></svg>

<!--
Active-Activeは全トンネルを同時利用してスループットを最大化し、即時フェイルオーバーが可能ですが設定が複雑。Active-StandbyはシンプルでStatic BGP不要ですが、フェイルオーバーに数十秒かかります。
-->

---

# デュアル CGW + ECMP 冗長構成

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">デュアル CGW + ECMP — 最高可用性構成</text><rect x="30" y="50" width="120" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="90" y="73" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">CGW-1</text><text x="90" y="92" font-size="10" fill="#8090d0" text-anchor="middle">ISP-A 回線</text><rect x="30" y="130" width="120" height="55" rx="8" fill="#2a3060" stroke="#6060c0" stroke-width="1.5"/><text x="90" y="153" font-size="11" fill="#a0b0f0" text-anchor="middle" font-weight="bold">CGW-2</text><text x="90" y="172" font-size="10" fill="#8090d0" text-anchor="middle">ISP-B 回線</text><rect x="330" y="80" width="120" height="60" rx="10" fill="#1a4060" stroke="#4a90c0" stroke-width="2"/><text x="390" y="107" font-size="13" fill="#80c0e0" text-anchor="middle" font-weight="bold">VGW</text><text x="390" y="127" font-size="11" fill="#60a0c0" text-anchor="middle">/ TGW</text><line x1="150" y1="77" x2="330" y2="100" stroke="#4060c0" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="150" y1="90" x2="330" y2="115" stroke="#4060c0" stroke-width="1" stroke-dasharray="4,3"/><line x1="150" y1="157" x2="330" y2="115" stroke="#4060c0" stroke-width="1.5" stroke-dasharray="6,3"/><line x1="150" y1="170" x2="330" y2="128" stroke="#4060c0" stroke-width="1" stroke-dasharray="4,3"/><text x="225" y="72" font-size="9" fill="#6080b0">T1 (ECMP)</text><text x="225" y="96" font-size="9" fill="#6080b0">T2 (ECMP)</text><text x="225" y="145" font-size="9" fill="#6080b0">T3 (ECMP)</text><text x="225" y="170" font-size="9" fill="#6080b0">T4 (ECMP)</text><rect x="600" y="80" width="140" height="60" rx="8" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="670" y="115" font-size="13" fill="#80c060" text-anchor="middle" font-weight="bold">VPC</text><line x1="450" y1="110" x2="600" y2="110" stroke="#3a6030" stroke-width="2"/><rect x="30" y="215" width="720" height="80" rx="8" fill="#12204a" stroke="#3a5090" stroke-width="1"/><text x="390" y="238" font-size="13" fill="#80a8e0" text-anchor="middle" font-weight="bold">4トンネル構成の冗長効果</text><text x="50" y="260" font-size="11" fill="#a0b8d8">• CGW-1 故障 → T1/T2 消失 → T3/T4 (CGW-2) が自動継続</text><text x="50" y="280" font-size="11" fill="#a0b8d8">• ISP-A 障害 → CGW-1 の BGP セッション切断 → CGW-2 経由に自動切替</text><text x="50" y="295" font-size="11" fill="#808090">合計帯域: 4 × 1.25 Gbps = 5 Gbps (ECMP 有効時)</text><rect x="30" y="310" width="340" height="75" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="200" y="330" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">構成要件</text><text x="45" y="352" font-size="11" fill="#a0b0d0">• 2つの物理 CGW (異なるルーター推奨)</text><text x="45" y="372" font-size="11" fill="#a0b0d0">• 2回線: 異なる ISP / 異なる物理パス</text><rect x="410" y="310" width="340" height="75" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="580" y="330" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">AWS 側設定</text><text x="425" y="352" font-size="11" fill="#a0b0d0">• TGW: enableEqualCostMultipathRouting</text><text x="425" y="372" font-size="11" fill="#a0b0d0">• BGP Propagation 有効化</text></svg>

<!--
デュアルCGWはISPやルーターの単一障害点を排除します。CGW-1が故障してもCGW-2の2トンネルが継続し、ECMP有効時は4トンネル合計5Gbpsの帯域も得られます。最高可用性が求められる本番環境の推奨構成です。
-->

---

<!-- _class: lead -->
# Section 8: セキュリティ設計

- 暗号化アルゴリズム・PFS・アクセス制御
- VPN とネットワークセキュリティの統合

<!--
VPNのセキュリティ設計では、適切な暗号化アルゴリズムの選択とPFS（Perfect Forward Secrecy）の活用が重要です。
-->

---

# VPN 暗号化アルゴリズム選択ガイド

- <svg viewBox="0 0 780 390" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="390" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">AWS VPN 暗号化アルゴリズム選択ガイド</text><rect x="20" y="42" width="740" height="28" rx="4" fill="#2a3060" stroke="#4a6090" stroke-width="1"/><text x="130" y="62" font-size="12" fill="#a0b8f0" text-anchor="middle" font-weight="bold">Phase / パラメータ</text><text x="360" y="62" font-size="12" fill="#60a8ff" text-anchor="middle" font-weight="bold">推奨値 (強)</text><text x="560" y="62" font-size="12" fill="#ffd070" text-anchor="middle" font-weight="bold">互換性重視</text><text x="700" y="62" font-size="12" fill="#ff7070" text-anchor="middle" font-weight="bold">非推奨 (廃止予定)</text><rect x="20" y="73" width="740" height="26" rx="0" fill="#12203a"/><text x="130" y="91" font-size="11" fill="#80a0d0" text-anchor="middle">IKE 暗号化</text><text x="360" y="91" font-size="11" fill="#80ff80" text-anchor="middle">AES-256-GCM</text><text x="560" y="91" font-size="11" fill="#ffd070" text-anchor="middle">AES-256-CBC</text><text x="700" y="91" font-size="11" fill="#ff8080" text-anchor="middle">3DES, DES</text><rect x="20" y="99" width="740" height="26" rx="0" fill="#0e1a30"/><text x="130" y="117" font-size="11" fill="#80a0d0" text-anchor="middle">IKE 完全性</text><text x="360" y="117" font-size="11" fill="#80ff80" text-anchor="middle">SHA-512 / SHA-384</text><text x="560" y="117" font-size="11" fill="#ffd070" text-anchor="middle">SHA-256</text><text x="700" y="117" font-size="11" fill="#ff8080" text-anchor="middle">SHA-1, MD5</text><rect x="20" y="125" width="740" height="26" rx="0" fill="#12203a"/><text x="130" y="143" font-size="11" fill="#80a0d0" text-anchor="middle">DH グループ</text><text x="360" y="143" font-size="11" fill="#80ff80" text-anchor="middle">Group 20/21 (ECDH 384/521bit)</text><text x="560" y="143" font-size="11" fill="#ffd070" text-anchor="middle">Group 14/16</text><text x="700" y="143" font-size="11" fill="#ff8080" text-anchor="middle">Group 1/2/5</text><rect x="20" y="151" width="740" height="26" rx="0" fill="#0e1a30"/><text x="130" y="169" font-size="11" fill="#80a0d0" text-anchor="middle">IPsec 暗号化</text><text x="360" y="169" font-size="11" fill="#80ff80" text-anchor="middle">AES-256-GCM-16</text><text x="560" y="169" font-size="11" fill="#ffd070" text-anchor="middle">AES-128-GCM-16</text><text x="700" y="169" font-size="11" fill="#ff8080" text-anchor="middle">NULL (暗号化なし)</text><rect x="20" y="177" width="740" height="26" rx="0" fill="#12203a"/><text x="130" y="195" font-size="11" fill="#80a0d0" text-anchor="middle">SA ライフタイム</text><text x="360" y="195" font-size="11" fill="#80ff80" text-anchor="middle">IKE: 8h / IPsec: 1h (デフォルト)</text><text x="560" y="195" font-size="11" fill="#ffd070" text-anchor="middle">同左 (変更不要)</text><text x="700" y="195" font-size="11" fill="#ff8080" text-anchor="middle">極端に長い値</text><rect x="20" y="220" width="355" height="155" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="197" y="242" font-size="12" fill="#80a8e0" text-anchor="middle" font-weight="bold">Perfect Forward Secrecy (PFS)</text><text x="35" y="265" font-size="11" fill="#a0b8d8">• 各 IPsec SA で独立した DH 鍵交換</text><text x="35" y="285" font-size="11" fill="#a0b8d8">• 過去セッションの鍵漏洩が現在に影響しない</text><text x="35" y="305" font-size="11" fill="#a0b8d8">• AWS VPN: PFS はデフォルト無効</text><text x="35" y="325" font-size="11" fill="#60d0a0">→ 規制業種では必ず有効化を推奨</text><text x="35" y="345" font-size="11" fill="#a0b8d8">• 設定: Phase 2 の PFS Group を指定</text><text x="35" y="365" font-size="10" fill="#808090">   (Group 14 以上を選択)</text><rect x="405" y="220" width="355" height="155" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="582" y="242" font-size="12" fill="#80a8e0" text-anchor="middle" font-weight="bold">Dead Peer Detection (DPD)</text><text x="420" y="265" font-size="11" fill="#a0b8d8">• ピアの死活監視 (RFC 3706)</text><text x="420" y="285" font-size="11" fill="#a0b8d8">• DPD Timeout: 30 秒 (デフォルト)</text><text x="420" y="305" font-size="11" fill="#a0b8d8">• Action: Clear (SA 削除) / Restart (再接続)</text><text x="420" y="325" font-size="11" fill="#60d0a0">→ Restart 推奨 (自動再接続)</text><text x="420" y="345" font-size="11" fill="#a0b8d8">• フェイルオーバー検知に利用</text><text x="420" y="365" font-size="10" fill="#808090">   (BGP Hold Timer と組み合わせ)</text></svg>

<!--
AES-256-GCMとSHA-512、ECDHグループ20/21の組み合わせが最も強固です。PFSはデフォルト無効なので規制業種では必ず有効化します。DPDをRestartに設定することで自動再接続が可能です。
-->

---

# VPN + Security Groups / NACL 設計

- <svg viewBox="0 0 780 390" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="390" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">VPN + Security Groups / NACL 多層防御</text><rect x="30" y="48" width="100" height="50" rx="6" fill="#2a304a" stroke="#6060c0" stroke-width="1.5"/><text x="80" y="68" font-size="11" fill="#a0b0f0" text-anchor="middle">オンプレ</text><text x="80" y="84" font-size="10" fill="#8090d0" text-anchor="middle">10.0.0.0/8</text><line x1="130" y1="73" x2="180" y2="73" stroke="#6060c0" stroke-width="2"/><text x="155" y="65" font-size="10" fill="#8080c0">IPsec</text><rect x="180" y="48" width="110" height="50" rx="6" fill="#1a4060" stroke="#4a90c0" stroke-width="1.5"/><text x="235" y="68" font-size="11" fill="#80c0e0" text-anchor="middle">VGW/TGW</text><text x="235" y="84" font-size="10" fill="#60a0c0" text-anchor="middle">暗号化終端</text><line x1="290" y1="73" x2="340" y2="73" stroke="#4a90c0" stroke-width="2"/><rect x="340" y="42" width="160" height="62" rx="6" fill="#1a3060" stroke="#3a70b0" stroke-width="1.5"/><text x="420" y="62" font-size="11" fill="#80a8d0" text-anchor="middle" font-weight="bold">Subnet (Public/Private)</text><rect x="352" y="72" width="136" height="25" rx="4" fill="#2a4080" stroke="#4a60a0" stroke-width="1"/><text x="420" y="89" font-size="10" fill="#80a8e0" text-anchor="middle">NACL: ステートレス フィルタ</text><line x1="500" y1="73" x2="550" y2="73" stroke="#3a70b0" stroke-width="2"/><rect x="550" y="42" width="160" height="62" rx="6" fill="#1a2040" stroke="#3a5090" stroke-width="1.5"/><text x="630" y="62" font-size="11" fill="#7090d0" text-anchor="middle" font-weight="bold">EC2 Instance</text><rect x="562" y="72" width="136" height="25" rx="4" fill="#1a3060" stroke="#3a5090" stroke-width="1"/><text x="630" y="89" font-size="10" fill="#6080c0" text-anchor="middle">SG: ステートフル フィルタ</text><rect x="30" y="125" width="710" height="80" rx="8" fill="#12203a" stroke="#3a5090" stroke-width="1"/><text x="375" y="148" font-size="13" fill="#80a8e0" text-anchor="middle" font-weight="bold">各レイヤーの役割</text><rect x="45" y="160" width="200" height="36" rx="4" fill="#1a2a50" stroke="#3a4a80" stroke-width="1"/><text x="145" y="174" font-size="11" fill="#80a8d8" text-anchor="middle" font-weight="bold">NACL (Subnet レベル)</text><text x="145" y="190" font-size="10" fill="#6080a8" text-anchor="middle">サブネット境界で粗いフィルタ</text><rect x="265" y="160" width="200" height="36" rx="4" fill="#1a2a50" stroke="#3a4a80" stroke-width="1"/><text x="365" y="174" font-size="11" fill="#80a8d8" text-anchor="middle" font-weight="bold">Security Group (ENI レベル)</text><text x="365" y="190" font-size="10" fill="#6080a8" text-anchor="middle">インスタンス単位の精細なフィルタ</text><rect x="485" y="160" width="200" height="36" rx="4" fill="#1a2a50" stroke="#3a4a80" stroke-width="1"/><text x="585" y="174" font-size="11" fill="#80a8d8" text-anchor="middle" font-weight="bold">VGW/TGW ルートテーブル</text><text x="585" y="190" font-size="10" fill="#6080a8" text-anchor="middle">L3 ルーティング制御</text><rect x="30" y="220" width="340" height="160" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="200" y="242" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">Security Group 推奨設定</text><text x="45" y="265" font-size="11" fill="#a0b0d0">インバウンド (オンプレ → EC2):</text><text x="45" y="285" font-size="11" fill="#80c0a0">• ソース: オンプレ CIDR (10.0.0.0/8)</text><text x="45" y="305" font-size="11" fill="#80c0a0">• ポート: 業務必要ポートのみ許可</text><text x="45" y="325" font-size="11" fill="#a0b0d0">アウトバウンド:</text><text x="45" y="345" font-size="11" fill="#80c0a0">• 必要な宛先・ポートのみ</text><text x="45" y="365" font-size="11" fill="#ff8060">• 0.0.0.0/0 全解放は避ける</text><rect x="410" y="220" width="340" height="160" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="580" y="242" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">NACL 推奨設定</text><text x="425" y="265" font-size="11" fill="#a0b0d0">インバウンド:</text><text x="425" y="285" font-size="11" fill="#80c0a0">• 100: オンプレ CIDR 許可</text><text x="425" y="305" font-size="11" fill="#80c0a0">• 200: 戻りパケット用 (Ephemeral)</text><text x="425" y="325" font-size="11" fill="#a0b0d0">アウトバウンド:</text><text x="425" y="345" font-size="11" fill="#80c0a0">• ステートレスのため戻り方向も明示</text><text x="425" y="365" font-size="11" fill="#ffd070">• ルール番号: 100刻みで管理</text></svg>

<!--
VPN接続後のトラフィック制御はNACL（ステートレス・サブネット境界）とSecurity Group（ステートフル・インスタンス単位）の二層で行います。最小権限の原則で必要なCIDR・ポートのみ許可します。
-->

---

<!-- _class: lead -->
# Section 9: 運用・監視・トラブルシューティング

- CloudWatch メトリクス・アラート設計
- 接続断の診断フローと共通設定ミス

<!--
VPNの安定運用には適切な監視設定とトラブルシューティング手順が不可欠です。
-->

---

# VPN 接続断 診断フロー

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">VPN 接続断 診断フローチャート</text><rect x="310" y="42" width="160" height="38" rx="6" fill="#3a1a5a" stroke="#9d71e8" stroke-width="2"/><text x="390" y="66" font-size="12" fill="#d0b0ff" text-anchor="middle">VPN 接続断を検知</text><line x1="390" y1="80" x2="390" y2="105" stroke="#9d71e8" stroke-width="1.5"/><polygon points="390,108 384,100 396,100" fill="#9d71e8"/><rect x="290" y="108" width="200" height="35" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="390" y="131" font-size="11" fill="#80a8e0" text-anchor="middle">TunnelState = 0 確認 (CW)</text><line x1="390" y1="143" x2="390" y2="163" stroke="#4a70b0" stroke-width="1.5"/><polygon points="390,166 384,158 396,158" fill="#4a70b0"/><rect x="280" y="166" width="220" height="35" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="390" y="189" font-size="11" fill="#80a8e0" text-anchor="middle">CGW の IP / BGP ASN 確認</text><line x1="280" y1="183" x2="180" y2="183" stroke="#ff6060" stroke-width="1.5"/><rect x="30" y="170" width="150" height="35" rx="5" fill="#3a1a1a" stroke="#a06060" stroke-width="1.5"/><text x="105" y="192" font-size="10" fill="#ff9090" text-anchor="middle">NG: CGW 設定修正</text><line x1="390" y1="201" x2="390" y2="221" stroke="#4a70b0" stroke-width="1.5"/><polygon points="390,224 384,216 396,216" fill="#4a70b0"/><rect x="265" y="224" width="250" height="35" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="390" y="247" font-size="11" fill="#80a8e0" text-anchor="middle">IKE Phase 1 ネゴシエーション確認</text><line x1="265" y1="241" x2="180" y2="241" stroke="#ff6060" stroke-width="1.5"/><rect x="30" y="228" width="150" height="35" rx="5" fill="#3a1a1a" stroke="#a06060" stroke-width="1.5"/><text x="105" y="250" font-size="10" fill="#ff9090" text-anchor="middle">NG: 暗号化パラメータ修正</text><line x1="390" y1="259" x2="390" y2="279" stroke="#4a70b0" stroke-width="1.5"/><polygon points="390,282 384,274 396,274" fill="#4a70b0"/><rect x="265" y="282" width="250" height="35" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="390" y="305" font-size="11" fill="#80a8e0" text-anchor="middle">ルーティング確認 (BGP/Static)</text><line x1="265" y1="299" x2="180" y2="299" stroke="#ff6060" stroke-width="1.5"/><rect x="30" y="286" width="150" height="35" rx="5" fill="#3a1a1a" stroke="#a06060" stroke-width="1.5"/><text x="105" y="308" font-size="10" fill="#ff9090" text-anchor="middle">NG: ルートテーブル修正</text><line x1="390" y1="317" x2="390" y2="337" stroke="#4a70b0" stroke-width="1.5"/><polygon points="390,340 384,332 396,332" fill="#4a70b0"/><rect x="265" y="340" width="250" height="35" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="390" y="363" font-size="11" fill="#80a8e0" text-anchor="middle">SG / NACL のポート許可確認</text><line x1="515" y1="358" x2="590" y2="358" stroke="#60d060" stroke-width="1.5"/><rect x="590" y="340" width="150" height="35" rx="5" fill="#1a3a1a" stroke="#5aaa5a" stroke-width="1.5"/><text x="665" y="363" font-size="10" fill="#80d080" text-anchor="middle">OK: 疎通確認 完了</text></svg>

<!--
VPN接続断の診断はTunnelStateメトリクスから始め、CGW設定→IKEネゴシエーション→ルーティング→SG/NACLの順に確認します。各ステップでNGなら対応修正を行います。
-->

---

# CloudWatch VPN 監視メトリクス

- <svg viewBox="0 0 780 390" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="390" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">CloudWatch VPN 監視メトリクス一覧</text><rect x="20" y="42" width="740" height="28" rx="4" fill="#2a3060" stroke="#4a6090" stroke-width="1"/><text x="160" y="62" font-size="12" fill="#a0b8f0" text-anchor="middle" font-weight="bold">メトリクス名</text><text x="380" y="62" font-size="12" fill="#60a8ff" text-anchor="middle" font-weight="bold">説明</text><text x="590" y="62" font-size="12" fill="#80e060" text-anchor="middle" font-weight="bold">推奨アラート閾値</text><rect x="20" y="72" width="740" height="26" rx="0" fill="#12203a"/><text x="160" y="90" font-size="11" fill="#ffd070" text-anchor="middle" font-weight="bold">TunnelState</text><text x="380" y="90" font-size="11" fill="#a0b8d8" text-anchor="middle">トンネル状態 (1=UP, 0=DOWN)</text><text x="590" y="90" font-size="11" fill="#ff8080" text-anchor="middle">=0 で即時アラート</text><rect x="20" y="98" width="740" height="26" rx="0" fill="#0e1a30"/><text x="160" y="116" font-size="11" fill="#a0c8f0" text-anchor="middle">TunnelDataIn</text><text x="380" y="116" font-size="11" fill="#a0b8d8" text-anchor="middle">受信バイト数 (5分間)</text><text x="590" y="116" font-size="11" fill="#a0c8a0" text-anchor="middle">突然の急減 (前比 -80%) で警告</text><rect x="20" y="124" width="740" height="26" rx="0" fill="#12203a"/><text x="160" y="142" font-size="11" fill="#a0c8f0" text-anchor="middle">TunnelDataOut</text><text x="380" y="142" font-size="11" fill="#a0b8d8" text-anchor="middle">送信バイト数 (5分間)</text><text x="590" y="142" font-size="11" fill="#a0c8a0" text-anchor="middle">突然の急減 (前比 -80%) で警告</text><rect x="20" y="150" width="740" height="26" rx="0" fill="#0e1a30"/><text x="160" y="168" font-size="11" fill="#a0c8f0" text-anchor="middle">TunnelPacketsDropped</text><text x="380" y="168" font-size="11" fill="#a0b8d8" text-anchor="middle">ドロップパケット数</text><text x="590" y="168" font-size="11" fill="#ffd070" text-anchor="middle">&gt;100/5min で警告</text><rect x="20" y="176" width="740" height="26" rx="0" fill="#12203a"/><text x="160" y="194" font-size="11" fill="#a0c8f0" text-anchor="middle">BGPStatus (TGW)</text><text x="380" y="194" font-size="11" fill="#a0b8d8" text-anchor="middle">BGP セッション状態</text><text x="590" y="194" font-size="11" fill="#ff8080" text-anchor="middle">DOWN で即時アラート</text><rect x="20" y="220" width="740" height="75" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="390" y="242" font-size="12" fill="#80a8e0" text-anchor="middle" font-weight="bold">推奨 CloudWatch アラーム設定</text><text x="35" y="264" font-size="11" fill="#a0b8d8">P1 (Critical): TunnelState = 0 → SNS → PagerDuty / Slack に即時通知</text><text x="35" y="284" font-size="11" fill="#a0b8d8">P2 (Warning): PacketsDropped &gt; 100 → 5分間の閾値超過 → Slack 通知</text><rect x="20" y="310" width="740" height="70" rx="6" fill="#0e1a30" stroke="#3a4a70" stroke-width="1"/><text x="390" y="332" font-size="12" fill="#e0e0ff" text-anchor="middle" font-weight="bold">AWS Network Manager との統合</text><text x="40" y="355" font-size="11" fill="#a0b0d0">• グローバルネットワーク全体の VPN/DX 状態を一元可視化</text><text x="40" y="375" font-size="11" fill="#a0b0d0">• Route Analyzer でルーティング問題を自動検出</text><text x="430" y="355" font-size="11" fill="#a0b0d0">• Transit Gateway Network Manager でトポロジー図を自動生成</text><text x="430" y="375" font-size="11" fill="#a0b0d0">• イベント履歴で変更管理・インシデント分析</text></svg>

<!--
VPN監視の最重要メトリクスはTunnelStateです。0になったら即時アラートを設定します。TunnelDataIn/Outの急減も異常検知に有効です。AWS Network Managerを使うと複数VPNの一元監視が可能です。
-->

---

# よくある設定ミスと対策

- <svg viewBox="0 0 780 390" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="390" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">よくある VPN 設定ミスと対策</text><rect x="20" y="42" width="740" height="26" rx="4" fill="#2a3060" stroke="#4a6090" stroke-width="1"/><text x="200" y="60" font-size="12" fill="#ff8080" text-anchor="middle" font-weight="bold">設定ミス</text><text x="480" y="60" font-size="12" fill="#60a8ff" text-anchor="middle" font-weight="bold">原因と対策</text><rect x="20" y="70" width="740" height="28" rx="0" fill="#1a1220"/><text x="200" y="89" font-size="11" fill="#ff9090" text-anchor="middle">IKE Phase 1 失敗</text><text x="480" y="89" font-size="11" fill="#a0b8d8" text-anchor="middle">暗号化パラメータ不一致 → 両側の Encryption/Hash/DH を揃える</text><rect x="20" y="100" width="740" height="28" rx="0" fill="#0e1a30"/><text x="200" y="119" font-size="11" fill="#ff9090" text-anchor="middle">Tunnel UP だが通信不可</text><text x="480" y="119" font-size="11" fill="#a0b8d8" text-anchor="middle">ルートテーブル未設定 / SG でブロック → Route Propagation と SG を確認</text><rect x="20" y="130" width="740" height="28" rx="0" fill="#1a1220"/><text x="200" y="149" font-size="11" fill="#ff9090" text-anchor="middle">BGP セッション不安定</text><text x="480" y="149" font-size="11" fill="#a0b8d8" text-anchor="middle">Keepalive/Hold Timer 不一致 または MTU 問題 → 値を揃え MSS Clamping を設定</text><rect x="20" y="160" width="740" height="28" rx="0" fill="#0e1a30"/><text x="200" y="179" font-size="11" fill="#ff9090" text-anchor="middle">片方向のみ通信可</text><text x="480" y="179" font-size="11" fill="#a0b8d8" text-anchor="middle">NACL がステートレスのため戻りパケットを拒否 → アウトバウンドも許可ルール追加</text><rect x="20" y="190" width="740" height="28" rx="0" fill="#1a1220"/><text x="200" y="209" font-size="11" fill="#ff9090" text-anchor="middle">VPN 接続後にインターネット不可</text><text x="480" y="209" font-size="11" fill="#a0b8d8" text-anchor="middle">Full Tunnel 設定でデフォルトルートが VPN 向きに → Split Tunnel を検討</text><rect x="20" y="220" width="740" height="28" rx="0" fill="#0e1a30"/><text x="200" y="239" font-size="11" fill="#ff9090" text-anchor="middle">NAT-T が効かない</text><text x="480" y="239" font-size="11" fill="#a0b8d8" text-anchor="middle">CGW が NAT 配下 → UDP 4500 の通過を FW/SG/NACL で許可</text><rect x="20" y="250" width="740" height="28" rx="0" fill="#1a1220"/><text x="200" y="269" font-size="11" fill="#ff9090" text-anchor="middle">大きなパケットで断片化</text><text x="480" y="269" font-size="11" fill="#a0b8d8" text-anchor="middle">IPsec ヘッダでMTU超過 → CGW で ip tcp adjust-mss 1379 を設定</text><rect x="20" y="295" width="740" height="85" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="390" y="318" font-size="12" fill="#80a8e0" text-anchor="middle" font-weight="bold">Reachability Analyzer による診断</text><text x="40" y="340" font-size="11" fill="#a0b8d8">• AWS コンソールから送信元→送信先を指定して経路分析を実行</text><text x="40" y="360" font-size="11" fill="#a0b8d8">• SG / NACL / ルートテーブルの問題を自動特定</text><text x="40" y="375" font-size="11" fill="#60d0a0">→ 診断コスト: $0.10/分析実行 (本番障害時の迅速な原因特定に有効)</text></svg>

<!--
VPN設定ミスのトップはIKEパラメータ不一致とルートテーブル未設定です。NACLのステートレス性を忘れてアウトバウンドを許可し忘れるケースも多いです。Reachability Analyzerを使うと経路問題を自動診断できます。
-->

---

<!-- _class: lead -->
# Section 10: サービス選定フレームワーク

- 要件に応じた AWS VPN サービス選択
- 意思決定ツリーと設計チェックリスト

<!--
これまで学んだ各VPNサービスの特性を踏まえ、要件に応じた選定フレームワークを整理します。
-->

---

# AWS VPN サービス選定 意思決定ツリー

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">VPN サービス選定 意思決定ツリー</text><rect x="300" y="42" width="180" height="38" rx="6" fill="#3a2060" stroke="#9d71e8" stroke-width="2"/><text x="390" y="66" font-size="12" fill="#d0b0ff" text-anchor="middle">接続対象は?</text><line x1="300" y1="61" x2="160" y2="110" stroke="#9d71e8" stroke-width="1.5"/><text x="215" y="92" font-size="10" fill="#c090e0">拠点接続</text><line x1="480" y1="61" x2="620" y2="110" stroke="#9d71e8" stroke-width="1.5"/><text x="560" y="92" font-size="10" fill="#c090e0">個人ユーザー</text><rect x="80" y="110" width="160" height="36" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="160" y="133" font-size="11" fill="#80a8e0" text-anchor="middle">VPC 数は?</text><line x1="80" y1="128" x2="30" y2="185" stroke="#4a70b0" stroke-width="1.5"/><text x="45" y="160" font-size="10" fill="#6090c0">1〜3個</text><line x1="240" y1="128" x2="280" y2="185" stroke="#4a70b0" stroke-width="1.5"/><text x="270" y="160" font-size="10" fill="#6090c0">4個以上</text><rect x="540" y="110" width="160" height="36" rx="5" fill="#1a3060" stroke="#4a70b0" stroke-width="1.5"/><text x="620" y="133" font-size="11" fill="#80a8e0" text-anchor="middle">認証方式?</text><line x1="540" y1="128" x2="500" y2="185" stroke="#4a70b0" stroke-width="1.5"/><text x="505" y="160" font-size="10" fill="#6090c0">証明書</text><line x1="700" y1="128" x2="730" y2="185" stroke="#4a70b0" stroke-width="1.5"/><text x="725" y="160" font-size="10" fill="#6090c0">AD/SSO</text><rect x="0" y="185" width="120" height="50" rx="6" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="60" y="207" font-size="11" fill="#80c060" text-anchor="middle" font-weight="bold">VGW VPN</text><text x="60" y="225" font-size="9" fill="#60a040" text-anchor="middle">コスト優先</text><rect x="220" y="185" width="120" height="50" rx="6" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="280" y="207" font-size="11" fill="#80c060" text-anchor="middle" font-weight="bold">TGW VPN</text><text x="280" y="225" font-size="9" fill="#60a040" text-anchor="middle">集中管理</text><rect x="430" y="185" width="120" height="50" rx="6" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="490" y="207" font-size="11" fill="#80c060" text-anchor="middle" font-weight="bold">Client VPN</text><text x="490" y="225" font-size="9" fill="#60a040" text-anchor="middle">証明書認証</text><rect x="680" y="185" width="90" height="50" rx="6" fill="#1a4020" stroke="#4a8040" stroke-width="1.5"/><text x="725" y="207" font-size="11" fill="#80c060" text-anchor="middle" font-weight="bold">Client VPN</text><text x="725" y="225" font-size="9" fill="#60a040" text-anchor="middle">SAML/AD</text><line x1="60" y1="235" x2="60" y2="275" stroke="#4a8040" stroke-width="1.5"/><rect x="0" y="275" width="120" height="40" rx="5" fill="#0e1a30" stroke="#3a5090" stroke-width="1"/><text x="60" y="293" font-size="10" fill="#80a0c0" text-anchor="middle">多拠点?</text><text x="60" y="308" font-size="9" fill="#6080a0" text-anchor="middle">→ CloudHub 検討</text><line x1="280" y1="235" x2="280" y2="275" stroke="#4a8040" stroke-width="1.5"/><rect x="200" y="275" width="160" height="40" rx="5" fill="#0e1a30" stroke="#3a5090" stroke-width="1"/><text x="280" y="293" font-size="10" fill="#80a0c0" text-anchor="middle">帯域不足?</text><text x="280" y="308" font-size="9" fill="#6080a0" text-anchor="middle">→ DX + VPN 検討</text><rect x="30" y="335" width="710" height="55" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="385" y="356" font-size="12" fill="#c0c8e0" text-anchor="middle" font-weight="bold">共通チェックリスト</text><text x="50" y="376" font-size="11" fill="#a0b0d0">□ 冗長化: デュアルトンネル / デュアルCGW  □ BGP vs Static  □ 暗号化強度 (AES-256 + PFS)</text><text x="50" y="392" font-size="10" fill="#808090">□ 監視: TunnelState アラート  □ MTU/MSS Clamping  □ ルートテーブル設計</text></svg>

<!--
意思決定の軸は「接続対象（拠点 vs 個人）」と「VPC数」です。拠点接続でVPC数が少なければVGW、多ければTGW、個人ユーザーはClient VPNを選択します。帯域や多拠点の要件でDXやCloudHubも組み合わせます。
-->

---

# まとめ — AWS VPN 全体像と設計原則

- <svg viewBox="0 0 780 400" style="max-height:70vh;max-width:100%;display:block;margin:0 auto;" xmlns="http://www.w3.org/2000/svg"><rect width="780" height="400" fill="#1a1a2e"/><text x="390" y="28" font-size="15" fill="#e0e0ff" text-anchor="middle" font-weight="bold">AWS VPN — 設計原則まとめ</text><rect x="20" y="42" width="350" height="155" rx="8" fill="#12204a" stroke="#4a90e2" stroke-width="1.5"/><text x="195" y="65" font-size="13" fill="#60a8ff" text-anchor="middle" font-weight="bold">5 つのサービス全体像</text><text x="35" y="90" font-size="12" fill="#ffd070">S2S VPN</text><text x="35" y="108" font-size="11" fill="#a0b8d8">  拠点接続の基本 / VGW か TGW にアタッチ</text><text x="35" y="130" font-size="12" fill="#ffd070">Client VPN</text><text x="35" y="148" font-size="11" fill="#a0b8d8">  個人ユーザー向け / 証明書 or AD 認証</text><text x="35" y="168" font-size="12" fill="#ffd070">CloudHub / DX+VPN</text><text x="35" y="186" font-size="11" fill="#a0b8d8">  多拠点 WAN 代替 / 暗号化と高帯域の両立</text><rect x="410" y="42" width="350" height="155" rx="8" fill="#1a2a1a" stroke="#5aaa3a" stroke-width="1.5"/><text x="585" y="65" font-size="13" fill="#80e060" text-anchor="middle" font-weight="bold">3 つの設計原則</text><text x="425" y="90" font-size="12" fill="#80ff80">1. 常に冗長化</text><text x="425" y="110" font-size="11" fill="#a0c888">  デュアルトンネル + BGP フェイルオーバー必須</text><text x="425" y="135" font-size="12" fill="#80ff80">2. 最小権限</text><text x="425" y="155" font-size="11" fill="#a0c888">  SG / NACL で必要なポート・CIDR のみ許可</text><text x="425" y="178" font-size="12" fill="#80ff80">3. 監視と自動化</text><text x="425" y="196" font-size="11" fill="#a0c888">  TunnelState アラート + 自動フェイルオーバー</text><rect x="20" y="213" width="740" height="80" rx="8" fill="#1a2a4a" stroke="#3a5090" stroke-width="1"/><text x="390" y="236" font-size="13" fill="#e0e0ff" text-anchor="middle" font-weight="bold">サービス選択の判断軸</text><rect x="35" y="250" width="155" height="35" rx="5" fill="#2a3a5a" stroke="#4a5a80" stroke-width="1"/><text x="112" y="268" font-size="11" fill="#80a8d8" text-anchor="middle">VPC 数 ≤3 → VGW</text><text x="112" y="282" font-size="10" fill="#6080a0" text-anchor="middle">コスト優先</text><rect x="210" y="250" width="155" height="35" rx="5" fill="#2a3a5a" stroke="#4a5a80" stroke-width="1"/><text x="287" y="268" font-size="11" fill="#80a8d8" text-anchor="middle">VPC 数 ≥4 → TGW</text><text x="287" y="282" font-size="10" fill="#6080a0" text-anchor="middle">集中管理</text><rect x="385" y="250" width="155" height="35" rx="5" fill="#2a3a5a" stroke="#4a5a80" stroke-width="1"/><text x="462" y="268" font-size="11" fill="#80a8d8" text-anchor="middle">個人接続 → Client</text><text x="462" y="282" font-size="10" fill="#6080a0" text-anchor="middle">ユーザー VPN</text><rect x="560" y="250" width="185" height="35" rx="5" fill="#2a3a5a" stroke="#4a5a80" stroke-width="1"/><text x="652" y="268" font-size="11" fill="#80a8d8" text-anchor="middle">高帯域/暗号化 → DX+VPN</text><text x="652" y="282" font-size="10" fill="#6080a0" text-anchor="middle">ハイブリッド</text><rect x="20" y="308" width="740" height="80" rx="6" fill="#0e1a30" stroke="#3a3a5a" stroke-width="1"/><text x="390" y="330" font-size="12" fill="#c0c0e0" text-anchor="middle" font-weight="bold">参考リソース</text><text x="40" y="352" font-size="11" fill="#7090b8">• AWS VPN ユーザーガイド: docs.aws.amazon.com/vpn/latest/s2svpn/</text><text x="40" y="370" font-size="11" fill="#7090b8">• AWS re:Invent NET307 — Advanced VPN Architectures</text><text x="40" y="384" font-size="10" fill="#506080">• AWS Well-Architected — Reliability Pillar (冗長化ベストプラクティス)</text></svg>

<!--
AWS VPNの設計は「常に冗長化」「最小権限」「監視と自動化」の3原則で考えます。サービス選択はVPC数・接続対象・帯域要件で決まります。DXとVPNの組み合わせが最も堅牢なハイブリッド構成です。
-->
