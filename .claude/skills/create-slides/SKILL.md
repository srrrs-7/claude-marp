---
name: create-slides
description: 対話型でスライドを一から作成（ヒアリング → 構成 → タスク分割 → 並列生成 → デザイン → エクスポート）
user_invocable: true
---

# Create Slides

`.claude/agents/slide-creator.md` の手順に従って、対話的にスライドを作成する。

## ワークフロー

0. **Pre-flight Checks** — スキーマとディレクトリルールを読み込み、タイムスタンプを生成
1. **ヒアリング** — トピック、対象者、形式、持ち時間、コンテンツ要件、デザインの好みを質問
2. **構成設計** — スライドアウトライン表を提示 → ユーザー承認
3. **タスク分割計画** — アウトラインをタスク単位に分割 → タスク表を提示 → ユーザー承認
4. **config生成** — `slides.config.yaml` を作成（`docs/<timestamp>_<title>/` に専用ディレクトリ）
5. **並列データ生成** — タスクごとに独立したエージェントを**同時起動** → 各 `slides-data-part{N}.json` を並列生成
6. **マージ & 検証** — 全エージェント完了後に結合 → `slides-data.json` → Zodバリデーション
7. **レンダリング** — `bun run slides render --in <path>/slides-data.json`
8. **レビューループ** — フィードバック → 修正 → 再レンダリング（OKまで繰り返し）
9. **デザイン調整** — テーマ・CSS・ディレクティブの微調整
10. **エクスポート** — `bun run slides export -f html --in <path>/<name>.md`
11. **セルフヒーリング検証** — エクスポート後に自動検証し、問題があれば修正→再エクスポート
12. **インデックス更新** — `bun run generate:index` で `docs/index.html` を再生成

**出力先:** すべてのファイルは `docs/<yyyymmddhhmmss>_<title>/` 配下に集約される

## 重要

- 各フェーズでユーザーの承認を得てから次に進む
- 一度に全質問せず、フェーズごとに対話する
- **ヒアリングは1項目ずつ質問する**（複数の質問をまとめて投げない。1つの質問→回答→次の質問のサイクルで進める）
- **選択肢がある質問は `AskUserQuestion` ツールで選択式にする**（自由記述が必要な質問はテキストで問いかける）
- アウトライン承認前にデータ生成しない
- **タスク分割計画の承認を得てから並列エージェントを起動する**
- レビューループは何度でも回す
- **【重要】config生成時**: `slides.config.yaml` の `output.dir` は **必ず** `"docs/<timestamp>_<title>"` のフルパスを指定（相対パス `"."` は実行ディレクトリ基準で解決されるため不可）
- **【最重要】図解ファースト**: 説明はテキスト箇条書きではなく SVG 図解を第一手段とする。全スライドの 50% 以上に図解を含めること（詳細は「図解ファースト原則」セクション参照）

---

## Phase 3: タスク分割計画

**トリガー:** 構成設計（Phase 2）でアウトライン承認を受けた直後に実行。

### 分割基準

| スライド総数 | タスク数 | 1タスクあたりの上限 |
|:-----------:|:--------:|:-----------------:|
| 1〜20枚 | 1（分割なし） | 20枚 |
| 21〜40枚 | 2 | 20枚 |
| 41〜60枚 | 3 | 20枚 |
| 61枚〜 | ceil(N/20) | 20枚 |

> タスク境界はセクション区切りに合わせる。20枚を超えるセクションが連続する場合は、内部で分割して境界を揃える。

### タスク表の提示形式

アウトライン承認後、以下の形式でタスク表を提示してユーザーの承認を求める:

```
## タスク分割計画（全45枚 → 3タスク・並列実行）

| タスク  | スライド範囲    | 枚数  | [SVG] | [CODE] | [TEXT] | 出力ファイル                  |
|--------|---------------|------|-------|--------|--------|------------------------------|
| Task-1 | スライド 1〜15  | 15枚 | 8     | 2      | 5      | slides-data-part1.json       |
| Task-2 | スライド 16〜30 | 15枚 | 9     | 3      | 3      | slides-data-part2.json       |
| Task-3 | スライド 31〜45 | 15枚 | 7     | 4      | 4      | slides-data-part3.json       |

SVG合計: 24枚 (53%) ✅ 基準クリア

▶ 承認後、3つのエージェントを同時起動して並列生成します。
```

承認を得たら Phase 4（config生成）へ進む。

---

## Phase 5: 並列データ生成

**タスク分割計画の承認後に実行。各タスクを独立したエージェントとして同時起動する。**

### 起動ルール

- Task tool の `run_in_background: true` を使い、全タスクを**1回のメッセージで同時起動**する
- 10タスク以上の場合はウェーブ実行（1ウェーブ = 最大7タスク）、全ウェーブの完了を待ってから次へ
- 各エージェントは互いに独立したファイルに書き込む（競合なし）

### エージェントへの指示テンプレート

```
あなたはスライド生成エージェントです。以下のタスクを実行してください。

【担当範囲】スライド {START}〜{END}（{N}枚）
【出力先】 docs/{TIMESTAMP}_{SLUG}/slides-data-part{N}.json
【アウトライン（担当分）】
{OUTLINE_EXCERPT}

【必須制約】
- フィールド名は `content`（`bullets` は不可）
- layout: "default" | "center" | "section" のみ
- SVGは viewBox + letter-spacing:0 + url(#id)禁止
- JSON は Write tool でファイルに書き込む（インライン出力禁止）
- 完了後に slides 数を検証して報告する

You have full permissions to use Bash, Write, Read, Edit, and Glob tools.
```

### 実行イメージ

```
Phase 5 開始 — 3エージェントを同時起動
├─ [Agent A] Task-1: スライド 1〜15  → slides-data-part1.json  (並列実行中…)
├─ [Agent B] Task-2: スライド 16〜30 → slides-data-part2.json  (並列実行中…)
└─ [Agent C] Task-3: スライド 31〜45 → slides-data-part3.json  (並列実行中…)

全エージェント完了 → Phase 6（マージ）へ
```

### ウェーブ実行（10タスク以上）

```
Wave 1: Task-1 〜 Task-7  → 全完了を待機
Wave 2: Task-8 〜 Task-14 → 全完了を待機
Wave 3: Task-15〜…        → 全完了を待機
→ マージ
```

---

## Phase 6: マージ & 検証

**全並列エージェント完了後に実行。**

### マージ手順

```bash
# 1. パーツファイルを結合して slides-data.json を生成
bun -e "
const fs = require('fs');
const parts = ['part1','part2','part3'].map(p =>
  JSON.parse(fs.readFileSync('docs/<dir>/slides-data-' + p + '.json','utf-8'))
);
const merged = { slides: parts.flatMap(p => p.slides) };
fs.writeFileSync('docs/<dir>/slides-data.json', JSON.stringify(merged, null, 2));
console.log('Merged:', merged.slides.length, 'slides');
"

# 2. 中間ファイルを削除
rm docs/<dir>/slides-data-part*.json

# 3. スキーマ検証
bun run validate
```

### 検証項目

- [ ] 実際の枚数 == 計画枚数（不足があればエージェントに追加生成を依頼）
- [ ] `bun run validate` がエラーなしで完了
- [ ] `JSON.parse()` が成功する（SVGエスケープ漏れなし）
- [ ] SVG比率が基準を満たしている

---

## 図解ファースト原則

**このスキルで生成するすべてのスライドに適用される強制ルール。**

### 基本方針

> テキストで説明できることは、図で説明できる。図で説明できることは、図で説明しなければならない。

概念・仕組み・比較・フローを「箇条書きだけ」で表現することを禁止する。
SVG インライン図解を第一の表現手段とし、補足テキストを最小限に抑える。

### スライド比率の強制基準

| スライド総数 | 図解スライド最低数 |
|:-----------:|:-----------------:|
| 〜10枚 | 5枚以上 |
| 11〜20枚 | 10枚以上 |
| 21〜40枚 | 21枚以上 |
| 41枚〜 | 全体の 55% 以上 |

**構成設計（Phase 2）でアウトラインを作る時点で上記比率を満たしていること。**
比率が不足している場合はアウトラインを修正してから承認を求める。

### 図解必須スライドタイプ

以下の内容を持つスライドは、**例外なく SVG 図解を含めること**:

| 内容タイプ | 求められる図解 |
|-----------|--------------|
| アーキテクチャ・構成 | システム構成図・コンポーネント図 |
| フロー・手順・プロセス | フローチャート・シーケンス図 |
| 比較・選定基準 | 比較マトリクス・スペクトル図 |
| タイムライン・歴史 | 水平/垂直タイムライン |
| 階層・分類・カテゴリ | ツリー図・マインドマップ |
| 数値・傾向 | バーチャート・折れ線（SVGで描画） |
| 概念の関係性 | ベン図・矢印付き関係図 |
| Before / After | 左右分割比較図 |

### 表現優先順位（絶対ルール）

```
1位: SVG 図解（フロー・構成・比較・概念）  ← 最優先
2位: SVG 図解 + 補足テキスト（数行以内）
3位: コードブロック（技術的実装の説明に限定）
4位: 箇条書きテキスト（図解で表現困難な場合のみ）  ← 最終手段
```

箇条書き **のみ** のスライドを連続 2 枚以上作ることを禁止する。
3 枚以上連続する場合は、中間に図解スライドを挿入してアウトラインを再設計する。

### 構成設計フェーズでの確認

アウトライン表を作成する際、各スライドに以下のタグを付与する:

- `[SVG]` — SVG 図解メイン
- `[CODE]` — コードブロックメイン
- `[TEXT]` — テキスト/箇条書きメイン（最終手段）
- `[TITLE]` — タイトル/セクション区切り

アウトライン提示時に `[SVG]` タグの数を明示し、比率基準を満たしているか確認する:

```
## アウトライン（全25枚）
SVG図解: 14枚 (56%) ✅ 基準クリア

| # | タイトル | タイプ |
|---|---------|-------|
| 1 | タイトル | [TITLE] |
| 2 | なぜ〜が重要か | [SVG] |
| 3 | アーキテクチャ概要 | [SVG] |
...
```

### SVG 設計の強制ガイドライン

1. **すべての SVG に `viewBox` と `letter-spacing:0` を付与** — Gaia テーマの letter-spacing 継承を防ぐ
2. **`url(#id)` 参照は全面禁止** — `drop-shadow()` CSS / 明示的 `<polygon>` 矢印を使う
3. **色はスライドテーマと調和させる** — gaia: 紫・白系 / default: 青・グレー系 / uncover: モノクロ系
4. **複雑な図（8ノード以上）は単独スライド** — テキストと同居させない
5. **サイズ指定**: `style="max-height:70vh;width:auto;display:block;margin:0 auto;letter-spacing:0"`

### レビューループでの図解比率チェック

Phase 8（レビューループ）でも以下を確認する:

```
チェック: 図解比率 = [SVG]スライド数 / 全スライド数
基準未達（50%未満） → 箇条書きスライドを図解に変換して再生成
基準クリア → 次フェーズへ
```

---

## Pre-flight Validation

**ワークフローの最初に自動実行:**

1. **Schema ファイルを読み込む:**
   - `src/generate/slide-schema.ts`
   - 有効なフィールド名を確認: `content` (not `bullets`)
   - `layout` enum 値: `"default" | "center" | "section"`

2. **Directory structure rules を読み込む:**
   - `.claude/rules/output-structure.md`
   - フルパス形式: `"docs/<timestamp>_<slug>"`
   - 相対パス禁止

3. **タイムスタンプを生成:**
   - `yyyymmddhhmmss` 形式（14桁）

**これらの情報を各フェーズで参照する**

## Chunked Generation (40枚以上のデッキ必須)

**32Kトークン上限回避のため、40枚以上のスライドは必ずチャンク分割して生成する。Phase 5（並列データ生成）がこれを自動的に満たす。**

各エージェントが担当する枚数は最大20枚のため、40枚以上のデッキは自動的にパーツファイルに分割される。

**ルール:**
- JSON をインラインで出力しない（Write tool を使う）
- SVG 内のダブルクォートは `\"` にエスケープしてから JSON に埋め込む
- チャンクサイズは最大20枚（token 上限に余裕を持たせる）

## Post-Generation Validation

**slides-data.json 生成後（Phase 6: マージ & 検証）、render 前に:**

1. 生成した JSON をスキーマと照合
2. エラーがあれば自動修正
3. 3回失敗したら停止してユーザーに報告
4. 検証通過後にファイル書き込み

**検証項目:**
- [ ] フィールド名が正しい (`content` not `bullets`)
- [ ] `layout` 値が有効 (`default`, `center`, `section` のいずれか)
- [ ] 必須フィールドが存在 (`title`, `layout`)
- [ ] オプショナルフィールドのみ省略されている
- [ ] 実際のスライド数 == 計画スライド数（ズレがあれば不足分を追加）
- [ ] JSON.parse() が成功する（SVGエスケープ漏れがないか）

## Error Recovery

**検証エラー発生時:**

1. **エラーの種類を特定:**
   - Field name error → フィールド名を修正
   - Invalid enum value → 有効な値に置換
   - Structural error → 構造を再構築

2. **自動修正を試行**

3. **修正後に再検証**

4. **ユーザーに報告:**
   ```
   ⚠️ Validation error detected and fixed:
   - Changed 'bullets' to 'content' in 5 slides
   - Fixed invalid layout value 'custom' → 'default' in slide 3
   ```

## Phase 11: Self-Healing Post-Export Verification

**エクスポート完了後に自動実行（ユーザー介入不要）:**

### 検証項目

1. **アセットパス検証**: `dist/*.html` 内に `src="assets/"` が残っていないか確認
   - 修正: `src/export/marp.ts` の `fixAssetPaths()` が自動修正するが、念のため確認
2. **SVGアーティファクト検出**: `<p><text>` パターン（生SVGがHTMLにリークした痕跡）
   - 修正: マークダウン内のインラインSVGの空行を除去して再レンダリング
3. **url(#id) 違反チェック**: `assets/*.svg` に禁止パターンがないか
   - 修正: `bun run scripts/fix-svg-url-refs.ts` を実行
4. **コンテンツオーバーフロー**: スライドあたりの行数が上限を超えていないか
   - 修正: `bun run split` でコード/図を分離

### セルフヒーリングループ

```
export → 検証 → 問題検出？
  ├─ No  → 完了。ユーザーに報告
  └─ Yes → 自動修正 → 再エクスポート → 再検証（最大3回）
           3回失敗 → ユーザーに報告して手動介入を依頼
```

### 検証コマンド

```bash
# 一括テスト（全プレゼンテーション）
bun run test

# 個別確認
grep -rn 'src="assets/' docs/<dir>/dist/*.html    # 壊れたパス
grep -rn 'url(#' docs/<dir>/assets/*.svg           # url(#id) 違反
grep -rn '^```mermaid' docs/<dir>/*.md              # Mermaid 残存
```

### 完了報告テンプレート

```
✅ エクスポート完了: docs/<dir>/dist/<name>.html
   - スライド数: N枚
   - SVG図: M個（assets/）
   - テスト: 全パス
   - 問題検出: なし（or 自動修正済み: ～を修正）
```

## Phase 12: インデックス更新

**エクスポート・検証完了後に自動実行:**

新しいプレゼンテーションを `docs/index.html` の一覧に反映する。

```bash
bun run generate:index
```

- `docs/` 配下の全プレゼンテーションをスキャンし、`docs/index.html` を再生成
- `slides.config.yaml` の `topic` やテーマ情報を読み取ってカテゴリ分類・一覧表示
- GitHub Pages で公開されるトップページが自動更新される
- **このステップはユーザー確認不要**（セルフヒーリング検証と同様に自動実行）
